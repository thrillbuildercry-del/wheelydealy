<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WeightOps | Revenue & Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .hidden { display: none !important; }
        
        /* Custom Selectable Buttons */
        .btn-select { transition: all 0.2s; border: 2px solid transparent; }
        .btn-select.active { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .btn-interactive:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200 min-h-screen pb-6">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal-overlay z-[150]">
        <div class="text-white flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p class="font-bold tracking-wide">Loading Database...</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-white shadow-lg">
                <i data-lucide="scale" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">WeightOps</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-8">Secure Access Portal</p>
            
            <button onclick="window.handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-4 rounded-xl shadow-sm flex justify-center items-center hover:bg-gray-50 dark:hover:bg-gray-600 transition btn-interactive">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Approval Pending Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 id="approval-title" class="text-2xl font-bold dark:text-white">Access Pending</h2>
            <p id="approval-msg" class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">Sign in Pending, please contact an administrator for help.</p>
            <div class="flex flex-col gap-2">
                <button onclick="window.location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition btn-interactive">Refresh Status</button>
                <button onclick="window.logout()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-xl text-gray-700 dark:text-gray-300 btn-interactive">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Settings</h2>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div id="settings-vehicle-section" class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 hidden">
                <h3 class="text-xs font-bold text-blue-600 dark:text-blue-300 uppercase mb-2">My Vehicle</h3>
                <input type="text" id="set-vehicle-color" placeholder="Color (e.g. Red)" class="w-full mb-2 p-2 rounded border bg-white dark:bg-gray-800 dark:border-gray-600 text-sm dark:text-white">
                <input type="text" id="set-vehicle-desc" placeholder="Make & Model (e.g. Toyota Camry)" class="w-full mb-2 p-2 rounded border bg-white dark:bg-gray-800 dark:border-gray-600 text-sm dark:text-white">
                <button onclick="window.saveVehicleInfo()" class="w-full bg-blue-600 text-white text-xs font-bold py-2 rounded shadow hover:bg-blue-700 btn-interactive">Save Vehicle Details</button>
            </div>

            <!-- Admin Factory Reset Area -->
            <div id="admin-settings-section" class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-800 hidden">
                <h3 class="text-xs font-bold text-red-600 dark:text-red-400 uppercase mb-2 flex items-center">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> Admin Danger Zone
                </h3>
                <button onclick="window.adminFactoryReset()" class="w-full bg-red-600 text-white text-xs font-bold py-2 rounded shadow hover:bg-red-700 btn-interactive">Factory Reset Inventory</button>
                <p class="text-[10px] text-gray-500 mt-2">Wipes all stock & sales to 0. Keeps user accounts.</p>
            </div>

            <div class="space-y-3">
                <button onclick="window.toggleTheme()" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl btn-interactive">
                    <span class="font-medium dark:text-white">Toggle Dark Mode</span>
                    <i data-lucide="moon" class="w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                </button>
                <hr class="border-gray-200 dark:border-gray-700 my-2">
                <button onclick="window.logout()" class="w-full flex justify-center items-center p-4 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold btn-interactive">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Add Bill Modal -->
    <div id="admin-bill-modal" class="modal-overlay hidden z-[110]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <h2 class="text-lg font-bold dark:text-white mb-4 flex items-center"><i data-lucide="file-text" class="w-5 h-5 mr-2 text-purple-500"></i> Add Priority Bill</h2>
            <div class="space-y-3">
                <input type="text" id="bill-name" placeholder="Bill Name (e.g. Rent, Restock)" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm outline-none">
                <input type="number" id="bill-amt" placeholder="Amount ($)" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm outline-none font-bold">
                <input type="date" id="bill-date" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm outline-none">
                <label class="flex items-center text-sm dark:text-gray-300 font-bold p-2">
                    <input type="checkbox" id="bill-recurring" class="w-4 h-4 mr-2 accent-purple-600">
                    Recurring Weekly/Monthly?
                </label>
            </div>
            <div class="flex space-x-2 mt-5">
                <button onclick="document.getElementById('admin-bill-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-bold">Cancel</button>
                <button onclick="window.saveAdminBill()" class="flex-[2] py-3 bg-purple-600 text-white rounded-xl font-bold shadow-md hover:bg-purple-700">Save Bill</button>
            </div>
            <input type="hidden" id="bill-request-id" value="">
        </div>
    </div>

    <!-- Staff Request Bill Modal -->
    <div id="staff-bill-modal" class="modal-overlay hidden z-[110]">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <h2 class="text-lg font-bold dark:text-white mb-4 flex items-center"><i data-lucide="receipt" class="w-5 h-5 mr-2 text-blue-500"></i> Request Bill / Expense</h2>
            <p class="text-xs text-gray-500 mb-4">Submit a bill or expense to the Boss's planner for approval.</p>
            <div class="space-y-3">
                <input type="text" id="req-bill-desc" placeholder="What is this for?" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm outline-none">
                <input type="number" id="req-bill-amt" placeholder="Total Amount ($)" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm outline-none font-bold">
            </div>
            <div class="flex space-x-2 mt-5">
                <button onclick="document.getElementById('staff-bill-modal').classList.add('hidden')" class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-bold">Cancel</button>
                <button onclick="window.submitStaffBillReq()" class="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700">Send Request</button>
            </div>
        </div>
    </div>

    <!-- STAFF UI -->
    <div id="staff-app" class="hidden">
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold">Staff Terminal</h1>
                <div class="text-xs text-blue-200" id="staff-name-display">Guest</div>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-4">
            
            <!-- Stock Card -->
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl shadow-lg p-5 text-white relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10 mb-4 border-b border-gray-700 pb-3">
                    <div>
                        <h2 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-1">Raw Weight</h2>
                        <div class="flex items-baseline">
                            <span class="text-3xl font-black mr-1" id="staff-stock">0.0</span>
                            <span class="text-gray-400 text-xs font-bold">u</span>
                        </div>
                    </div>
                    <button onclick="window.requestWeight()" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold py-2 px-3 rounded-xl shadow-md transition active:scale-95 flex items-center">
                        <i data-lucide="bell" class="w-3 h-3 mr-1"></i> Request
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <div>
                        <h2 class="text-blue-400 text-[10px] uppercase font-bold tracking-widest mb-1">Full Units</h2>
                        <span class="text-2xl font-black" id="staff-stock-full">0</span>
                    </div>
                    <div>
                        <h2 class="text-orange-400 text-[10px] uppercase font-bold tracking-widest mb-1">Usual Units</h2>
                        <span class="text-2xl font-black" id="staff-stock-usual">0</span>
                    </div>
                </div>
            </div>

            <!-- Terminal Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                <h2 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center justify-between">
                    <div class="flex items-center"><i data-lucide="calculator" class="w-5 h-5 mr-2 text-blue-500"></i> Record Sale</div>
                </h2>

                <!-- Source Selection -->
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">1. Inventory Source</label>
                    <select id="staff-sale-source" onchange="window.updateMasterLabels()" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-sm outline-none">
                        <option value="processed">Processed Pre-Packs</option>
                        <option value="raw">Raw Weight</option>
                    </select>
                </div>
                
                <!-- Qty Selection -->
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">2. Quantity</label>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="window.selectQty(0.5)" id="btn-qty-0.5" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">.5</button>
                        <button onclick="window.selectQty(1)" id="btn-qty-1" class="qty-btn btn-select active flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">1</button>
                        <button onclick="window.selectQty(2)" id="btn-qty-2" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">2</button>
                        <button onclick="window.selectQty(3)" id="btn-qty-3" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">3</button>
                        <button onclick="window.selectQty(4)" id="btn-qty-4" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">4</button>
                    </div>
                </div>

                <!-- Type Selection -->
                <div class="mb-5" id="staff-type-selection">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">3. Weight Standard</label>
                    <div class="flex space-x-2">
                        <button onclick="window.selectType('full')" id="btn-type-full" class="type-btn btn-select active flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center btn-interactive">
                            <span class="dark:text-white">Full Weight</span>
                            <span class="text-[10px] text-gray-400 mt-1 font-normal" id="label-full-weight">(1.0 units)</span>
                        </button>
                        <button onclick="window.selectType('usual')" id="btn-type-usual" class="type-btn btn-select flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center btn-interactive">
                            <span class="dark:text-white">Usual Weight</span>
                            <span class="text-[10px] text-gray-400 mt-1 font-normal" id="label-usual-weight">(0.8 units)</span>
                        </button>
                    </div>
                </div>

                <!-- Money Collection -->
                <div class="mb-4 bg-gray-50 dark:bg-gray-900/40 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">4. Money Received</label>
                        <span class="text-xs font-bold text-gray-500" id="expected-money-hint">Expected: $100</span>
                    </div>
                    <div class="relative mb-2">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-gray-400">$</span>
                        <input type="number" id="money-input" placeholder="0.00" oninput="window.checkPriceColor()" class="w-full bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-xl py-3 pl-10 pr-4 text-2xl font-black outline-none focus:border-blue-500 dark:text-white transition">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.setQuickPrice(80)" class="flex-1 bg-orange-100 dark:bg-orange-900/40 text-orange-800 dark:text-orange-200 py-2 rounded-lg font-bold text-sm hover:bg-orange-200 btn-interactive transition shadow-sm border border-orange-200 dark:border-orange-800" id="btn-quick-usual">$80 (Usual)</button>
                        <button onclick="window.setQuickPrice(100)" class="flex-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 py-2 rounded-lg font-bold text-sm hover:bg-green-200 btn-interactive transition shadow-sm border border-green-200 dark:border-green-800" id="btn-quick-full">$100 (Full)</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">Usual Standard: Red &lt;$80, Orange $80-$99, Green $100+</p>
                </div>

                <div class="flex gap-2 mb-3">
                    <button onclick="window.processSale()" class="flex-[2] bg-blue-600 text-white font-black text-sm py-4 rounded-xl shadow-md hover:bg-blue-700 btn-interactive transition uppercase tracking-wide">
                        Log Sale
                    </button>
                    <button onclick="window.staffPersonalUse()" class="flex-1 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 font-bold text-xs py-2 rounded-xl shadow-sm hover:bg-purple-200 btn-interactive transition flex flex-col items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 mb-1"></i> Use
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="window.staffExpense()" class="flex-1 bg-orange-50 text-orange-700 dark:bg-orange-900/20 dark:text-orange-400 font-bold text-xs py-2.5 rounded-xl border border-orange-200 dark:border-orange-800 hover:bg-orange-100 btn-interactive transition flex items-center justify-center">
                        <i data-lucide="fuel" class="w-3 h-3 mr-1"></i> Personal Expense
                    </button>
                    <button onclick="document.getElementById('staff-bill-modal').classList.remove('hidden')" class="flex-1 bg-gray-50 text-gray-700 dark:bg-gray-700 dark:text-gray-300 font-bold text-xs py-2.5 rounded-xl border border-gray-200 dark:border-gray-600 hover:bg-gray-100 btn-interactive transition flex items-center justify-center">
                        <i data-lucide="receipt" class="w-3 h-3 mr-1"></i> Request Bill
                    </button>
                </div>
            </div>

            <!-- Stats/Logs -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2">Shift Financials</h3>
                
                <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                    <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-[9px] text-gray-500 uppercase font-bold">Raw Sold</div>
                        <div class="text-sm font-bold dark:text-white" id="staff-stat-sold-raw">0</div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-200 dark:border-blue-800">
                        <div class="text-[9px] text-blue-600 uppercase font-bold">Full Sold</div>
                        <div class="text-sm font-bold text-blue-600 dark:text-blue-400" id="staff-stat-sold-full">0</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-2 rounded-lg border border-orange-200 dark:border-orange-800">
                        <div class="text-[9px] text-orange-600 uppercase font-bold">Usual Sold</div>
                        <div class="text-sm font-bold text-orange-600 dark:text-orange-400" id="staff-stat-sold-usual">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-800">
                        <div class="text-[10px] text-green-700 dark:text-green-400 uppercase font-bold">Gross Cash</div>
                        <div class="text-xl font-bold text-green-600 dark:text-green-400" id="staff-stat-money">$0</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg border border-orange-200 dark:border-orange-800">
                        <div class="text-[10px] text-orange-700 dark:text-orange-400 uppercase font-bold">Logged Expenses</div>
                        <div class="text-xl font-bold text-orange-600 dark:text-orange-400" id="staff-stat-expenses">$0</div>
                    </div>
                </div>

                <!-- Earnings and Debt Settlement -->
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-200 dark:border-gray-600 mb-4">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 border-b dark:border-gray-600 pb-1 flex items-center"><i data-lucide="calculator" class="w-3 h-3 mr-1"></i> Earnings & Debt Settlement</h4>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-600 dark:text-gray-400">Gross Commission Earned:</span>
                        <span class="font-bold text-green-600 dark:text-green-400" id="staff-calc-gross-comm">$0.00</span>
                    </div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-600 dark:text-gray-400">Total Outstanding Debt:</span>
                        <span class="font-bold text-red-500 dark:text-red-400" id="staff-calc-total-debt">$0.00</span>
                    </div>
                    <div class="flex justify-between text-xs mb-3">
                        <span class="text-gray-600 dark:text-gray-400">Commission Applied to Debt:</span>
                        <span class="font-bold text-orange-500" id="staff-calc-applied">-$0.00</span>
                    </div>
                    <div class="border-t border-dashed dark:border-gray-600 my-2"></div>
                    <div class="flex justify-between text-sm mb-1 font-bold">
                        <span class="dark:text-white">Net Commission to Keep:</span>
                        <span class="text-blue-600 dark:text-blue-400" id="staff-calc-net-comm">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm font-bold">
                        <span class="dark:text-white">Remaining Debt Balance:</span>
                        <span class="text-purple-600 dark:text-purple-400" id="staff-calc-rem-debt">$0.00</span>
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl border border-blue-200 dark:border-blue-800 mb-4 flex justify-between items-center shadow-inner">
                    <div class="text-xs text-blue-800 dark:text-blue-300 uppercase font-bold tracking-widest leading-tight">Net Cash<br>to Return</div>
                    <div class="text-3xl font-black text-blue-700 dark:text-blue-400" id="staff-stat-net">$0</div>
                </div>

                <div id="staff-shortage-warning" class="hidden mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-2 rounded-lg text-xs font-bold text-center border border-red-200 dark:border-red-800">
                    Warning: Short by <span id="staff-shortage-amount">$0</span> against standard prices.
                </div>
                
                <div class="h-32 mb-4 border-b dark:border-gray-700 pb-4">
                    <canvas id="staffChart"></canvas>
                </div>

                <div id="staff-log-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar text-sm">
                    <div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>
                </div>
            </div>

        </main>
    </div>

    <!-- ADMIN UI -->
    <div id="admin-app" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900 pb-20">
        <header class="bg-gray-900 text-white p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">BOSS DASHBOARD</h1>
                <p class="text-xs text-gray-400">Weight & Revenue Manager</p>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-2xl mx-auto">
            
            <!-- Admin Navigation -->
            <div class="grid grid-cols-5 gap-1 mb-6 text-[10px] sm:text-xs">
                <button onclick="window.switchAdminTab('storage')" id="adm-tab-storage" class="py-2 px-1 rounded-xl font-bold bg-gray-800 text-white shadow transition flex flex-col justify-center items-center"><i data-lucide="database" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Vault</span></button>
                <button onclick="window.switchAdminTab('terminal')" id="adm-tab-terminal" class="py-2 px-1 rounded-xl font-bold bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex flex-col justify-center items-center"><i data-lucide="calculator" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Sell</span></button>
                <button onclick="window.switchAdminTab('staff')" id="adm-tab-staff" class="py-2 px-1 rounded-xl font-bold bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex flex-col justify-center items-center relative"><i data-lucide="users" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Team</span></button>
                <button onclick="window.switchAdminTab('transfers')" id="adm-tab-transfers" class="py-2 px-1 rounded-xl font-bold bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition relative flex flex-col justify-center items-center"><i data-lucide="arrow-right-left" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Move</span><div id="admin-req-badge" class="hidden absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full"></div></button>
                <button onclick="window.switchAdminTab('finance')" id="adm-tab-finance" class="py-2 px-1 rounded-xl font-bold bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex flex-col justify-center items-center"><i data-lucide="pie-chart" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Finance</span></button>
            </div>

            <!-- TAB: MASTER STORAGE -->
            <div id="admin-view-storage" class="admin-tab-content active">
                
                <div class="bg-gradient-to-br from-gray-800 to-black rounded-3xl p-6 shadow-xl mb-6 text-white relative overflow-hidden">
                    <div class="relative z-10 flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-gray-400 text-xs uppercase tracking-widest font-bold mb-1">Master Vault Weight</h2>
                            <div class="flex items-baseline">
                                <span class="text-5xl font-black mr-2" id="admin-master-weight">0.0</span>
                                <span class="text-gray-400 font-bold">units</span>
                            </div>
                        </div>
                        <button onclick="window.adminAddWeight()" class="bg-white/10 hover:bg-white/20 p-3 rounded-full transition border border-white/20 backdrop-blur-sm btn-interactive">
                            <i data-lucide="plus" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>

                    <!-- Processing Tool -->
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 backdrop-blur-sm mt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-blue-300 flex items-center"><i data-lucide="layers" class="w-4 h-4 mr-2"></i> Process into Units</h3>
                        </div>
                        <div class="flex space-x-2">
                            <select id="process-type" class="w-1/3 p-2 bg-black/50 border border-gray-600 rounded-lg text-sm text-white font-bold outline-none">
                                <option value="full">Full (1.0)</option>
                                <option value="usual">Usual</option>
                            </select>
                            <input type="number" id="process-qty" placeholder="# Units" class="w-1/3 p-2 bg-black/50 border border-gray-600 rounded-lg text-sm text-white font-bold outline-none">
                            <button onclick="window.adminProcessUnits()" class="w-1/3 bg-blue-600 rounded-lg font-bold text-sm hover:bg-blue-500 btn-interactive">Make</button>
                        </div>
                    </div>
                </div>

                <!-- Processed Units Vault -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-2xl p-4 flex flex-col justify-center items-center text-center">
                        <h2 class="text-blue-800 dark:text-blue-300 text-[10px] uppercase font-bold tracking-widest mb-1">Full Units (1.0)</h2>
                        <div class="text-3xl font-black text-blue-900 dark:text-white" id="admin-stock-full">0</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-2xl p-4 flex flex-col justify-center items-center text-center">
                        <h2 class="text-orange-800 dark:text-orange-300 text-[10px] uppercase font-bold tracking-widest mb-1">Usual Units</h2>
                        <div class="text-3xl font-black text-orange-900 dark:text-white" id="admin-stock-usual">0</div>
                    </div>
                </div>

                <!-- Global Network Assets -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center border-b dark:border-gray-700 pb-2">
                        <i data-lucide="globe" class="w-4 h-4 mr-1 text-blue-500"></i> Global Network Assets
                    </h3>
                    <p class="text-[10px] text-gray-400 mb-3">Includes Master Vault AND all units currently held by Staff.</p>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="text-[9px] text-gray-500 uppercase font-bold">Total Raw</div>
                            <div class="text-lg font-black dark:text-white" id="global-stock-raw">0</div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-200 dark:border-blue-800">
                            <div class="text-[9px] text-blue-600 uppercase font-bold">Total Full</div>
                            <div class="text-lg font-black text-blue-700 dark:text-blue-400" id="global-stock-full">0</div>
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/20 p-2 rounded-lg border border-orange-200 dark:border-orange-800">
                            <div class="text-[9px] text-orange-600 uppercase font-bold">Total Usual</div>
                            <div class="text-lg font-black text-orange-700 dark:text-orange-400" id="global-stock-usual">0</div>
                        </div>
                    </div>
                </div>

                <!-- Rates and Percentages -->
                <div class="grid grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Price per 1.0 Unit</div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-green-400 mr-2" id="admin-price-display">$0</span>
                            <button onclick="window.adminSetVariable('pricePerUnit', 'Price per 1.0 Unit ($)')" class="text-gray-500 hover:text-gray-700 dark:hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">"Usual" Ratio</div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-orange-400 mr-2" id="admin-ratio-display">0.8x</span>
                            <button onclick="window.adminSetVariable('usualRatio', 'Usual Ratio (e.g. 0.8 for 80%)')" class="text-gray-500 hover:text-gray-700 dark:hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div>
                        <div class="text-[10px] text-purple-400 uppercase font-bold mb-1">Personal Use Discount %</div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-purple-600 dark:text-purple-400 mr-2" id="admin-discount-display">20% Off</span>
                            <button onclick="window.adminSetVariable('personalUseDiscount', 'Personal Use Discount %')" class="text-gray-500 hover:text-gray-700 dark:hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div>
                        <div class="text-[10px] text-blue-400 uppercase font-bold mb-1">Staff Commission %</div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-blue-600 dark:text-blue-400 mr-2" id="admin-commission-display">0%</span>
                            <button onclick="window.adminSetVariable('staffCommission', 'Staff Commission %')" class="text-gray-500 hover:text-gray-700 dark:hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Purchase Stock Card -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center">
                        <i data-lucide="shopping-bag" class="w-5 h-5 mr-2 text-blue-500"></i> Purchase Restock
                    </h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="window.adminPurchaseStock(3.5, 200)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">3.5 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $200</div>
                        </button>
                        <button onclick="window.adminPurchaseStock(7, 300)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">7 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $300 <span class="text-[10px] text-gray-400">(Wknd)</span></div>
                        </button>
                        <button onclick="window.adminPurchaseStock(7, 350)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">7 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $350 <span class="text-[10px] text-gray-400">(Wkday)</span></div>
                        </button>
                        <button onclick="window.adminPurchaseStock(14, 600)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">14 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $600</div>
                        </button>
                        <button onclick="window.adminPurchaseStock(28, 1100)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">28 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $1100</div>
                        </button>
                        <button onclick="window.adminPurchaseStock('custom', 0)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive flex flex-col justify-center items-center text-gray-500">
                            <i data-lucide="plus-circle" class="w-6 h-6 mb-1"></i>
                            <span class="text-xs font-bold uppercase tracking-wider">Custom</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- TAB: FINANCE & PROJECTIONS -->
            <div id="admin-view-finance" class="admin-tab-content hidden">
                
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-green-500"></i> Potential Earnings Projection
                    </h3>
                    <p class="text-[10px] text-gray-500 mb-4">Calculates potential value from all processed units (Global Assets).</p>
                    
                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800 text-center">
                            <div class="text-[10px] text-blue-600 uppercase font-bold tracking-widest">Total Full Units</div>
                            <div class="text-2xl font-black text-blue-800 dark:text-blue-300" id="proj-full-count">0</div>
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg border border-orange-200 dark:border-orange-800 text-center">
                            <div class="text-[10px] text-orange-600 uppercase font-bold tracking-widest">Total Usual Units</div>
                            <div class="text-2xl font-black text-orange-800 dark:text-orange-300" id="proj-usual-count">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600">
                            <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">Standard Projection</h4>
                            <div class="text-3xl font-black text-gray-800 dark:text-white mb-1" id="proj-std-total">$0</div>
                            <p class="text-[10px] text-gray-500">Full units sold at Full Price, Usual units sold at Usual Price.</p>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-200 dark:border-green-800">
                            <h4 class="text-[10px] font-bold text-green-600 dark:text-green-400 uppercase tracking-widest mb-1">Maximum "What If"</h4>
                            <div class="text-3xl font-black text-green-700 dark:text-green-400 mb-1" id="proj-whatif-total">$0</div>
                            <p class="text-[10px] text-green-600/70 dark:text-green-500">Both Full and Usual units sold at the Maximum Full Price.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-2 flex items-center border-b dark:border-gray-700 pb-2">
                        <i data-lucide="line-chart" class="w-5 h-5 mr-2 text-blue-500"></i> 7-Day Revenue Forecast
                    </h3>
                    <p class="text-[10px] text-gray-500 mb-4">Extrapolates current team collection rate into a 7-day prediction.</p>
                    <div class="h-40">
                        <canvas id="financePredictionChart"></canvas>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center">
                        <i data-lucide="landmark" class="w-5 h-5 mr-2 text-purple-500"></i> Priority Balance Manager
                    </h3>
                    
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-xl border border-purple-200 dark:border-purple-800 mb-4 flex justify-between items-center">
                        <div>
                            <div class="text-[10px] text-purple-700 dark:text-purple-400 uppercase font-bold tracking-widest">Master Cash Balance</div>
                            <div class="text-3xl font-black text-purple-800 dark:text-purple-300" id="finance-cash-balance">$0.00</div>
                        </div>
                        <button onclick="window.adminUpdateCash()" class="bg-purple-600 text-white p-3 rounded-full hover:bg-purple-700 transition btn-interactive shadow-md"><i data-lucide="plus-minus" class="w-5 h-5"></i></button>
                    </div>

                    <div class="flex justify-between items-center mb-4 px-2">
                        <span class="text-sm font-bold text-gray-600 dark:text-gray-400">Total Unpaid Bills:</span>
                        <span class="text-lg font-bold text-red-500 dark:text-red-400" id="finance-unpaid-total">-$0.00</span>
                    </div>

                    <div class="border-t border-dashed border-gray-300 dark:border-gray-600 my-4"></div>

                    <div class="flex justify-between items-center mb-6 px-2">
                        <span class="text-sm font-bold dark:text-white">Net Cash After Bills:</span>
                        <span class="text-2xl font-black text-green-600 dark:text-green-400" id="finance-net-after-bills">$0.00</span>
                    </div>

                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Bills & Liabilities</h4>
                        <button onclick="document.getElementById('admin-bill-modal').classList.remove('hidden')" class="text-xs bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg font-bold hover:bg-gray-300 dark:hover:bg-gray-600 btn-interactive flex items-center"><i data-lucide="plus" class="w-3 h-3 mr-1"></i> Add Bill</button>
                    </div>
                    
                    <div id="finance-liabilities-list" class="space-y-2">
                        <!-- Populated dynamically -->
                    </div>
                </div>

            </div>

            <!-- TAB: ADMIN TERMINAL (Unified) -->
            <div id="admin-view-terminal" class="admin-tab-content hidden">
                
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h2 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center justify-between">
                        <div class="flex items-center"><i data-lucide="calculator" class="w-5 h-5 mr-2 text-blue-500"></i> Record Admin Sale</div>
                    </h2>

                    <!-- Source Selection -->
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">1. Master Inventory Source</label>
                        <select id="adm-sale-source" onchange="window.admUpdateMasterLabels()" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-sm outline-none">
                            <option value="processed">Processed Pre-Packs</option>
                            <option value="raw">Raw Master Weight</option>
                        </select>
                    </div>
                    
                    <!-- Qty Selection -->
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">2. Quantity</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="window.admSelectQty(0.5)" id="adm-btn-qty-0.5" class="adm-qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">.5</button>
                            <button onclick="window.admSelectQty(1)" id="adm-btn-qty-1" class="adm-qty-btn btn-select active flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">1</button>
                            <button onclick="window.admSelectQty(2)" id="adm-btn-qty-2" class="adm-qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">2</button>
                            <button onclick="window.admSelectQty(3)" id="adm-btn-qty-3" class="adm-qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">3</button>
                            <button onclick="window.admSelectQty(4)" id="adm-btn-qty-4" class="adm-qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">4</button>
                        </div>
                    </div>

                    <!-- Type Selection -->
                    <div class="mb-5" id="adm-type-selection">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">3. Weight Standard</label>
                        <div class="flex space-x-2">
                            <button onclick="window.admSelectType('full')" id="adm-btn-type-full" class="adm-type-btn btn-select active flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center btn-interactive">
                                <span class="dark:text-white">Full Weight</span>
                                <span class="text-[10px] text-gray-400 mt-1 font-normal" id="adm-label-full-weight">(1.0 units)</span>
                            </button>
                            <button onclick="window.admSelectType('usual')" id="adm-btn-type-usual" class="adm-type-btn btn-select flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center btn-interactive">
                                <span class="dark:text-white">Usual Weight</span>
                                <span class="text-[10px] text-gray-400 mt-1 font-normal" id="adm-label-usual-weight">(0.8 units)</span>
                            </button>
                        </div>
                    </div>

                    <!-- Money Collection -->
                    <div class="mb-4 bg-gray-50 dark:bg-gray-900/40 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">4. Money Received</label>
                            <span class="text-xs font-bold text-gray-500" id="adm-expected-money-hint">Expected: $100</span>
                        </div>
                        <div class="relative mb-2">
                            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-gray-400">$</span>
                            <input type="number" id="adm-money-input" placeholder="0.00" oninput="window.admCheckPriceColor()" class="w-full bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-xl py-3 pl-10 pr-4 text-2xl font-black outline-none focus:border-blue-500 dark:text-white transition">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.admSetQuickPrice(80)" class="flex-1 bg-orange-100 dark:bg-orange-900/40 text-orange-800 dark:text-orange-200 py-2 rounded-lg font-bold text-sm hover:bg-orange-200 btn-interactive transition shadow-sm border border-orange-200 dark:border-orange-800" id="adm-btn-quick-usual">$80 (Usual)</button>
                            <button onclick="window.admSetQuickPrice(100)" class="flex-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 py-2 rounded-lg font-bold text-sm hover:bg-green-200 btn-interactive transition shadow-sm border border-green-200 dark:border-green-800" id="adm-btn-quick-full">$100 (Full)</button>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="window.adminProcessSale()" class="flex-[2] bg-blue-600 text-white font-black text-sm py-4 rounded-xl shadow-md hover:bg-blue-700 btn-interactive transition uppercase tracking-wide">
                            Log Admin Sale
                        </button>
                        <button onclick="window.adminPersonalUseUnified()" class="flex-1 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 font-bold text-xs py-2 rounded-xl shadow-sm hover:bg-purple-200 btn-interactive transition flex flex-col items-center justify-center">
                            <i data-lucide="user" class="w-4 h-4 mb-1"></i> Use
                        </button>
                    </div>
                </div>

                <!-- Admin Activity / Stats -->
                <div class="mt-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide">My Activity (Admin)</h3>
                    
                    <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                        <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="text-[9px] text-gray-500 uppercase font-bold">Raw Sold</div>
                            <div class="text-sm font-bold dark:text-white" id="admin-stat-sold-raw">0</div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-200 dark:border-blue-800">
                            <div class="text-[9px] text-blue-600 uppercase font-bold">Full Sold</div>
                            <div class="text-sm font-bold text-blue-600 dark:text-blue-400" id="admin-stat-sold-full">0</div>
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/20 p-2 rounded-lg border border-orange-200 dark:border-orange-800">
                            <div class="text-[9px] text-orange-600 uppercase font-bold">Usual Sold</div>
                            <div class="text-sm font-bold text-orange-600 dark:text-orange-400" id="admin-stat-sold-usual">0</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-800">
                            <div class="text-[10px] text-green-700 dark:text-green-400 uppercase font-bold">Money Collected</div>
                            <div class="text-xl font-bold text-green-600" id="admin-stat-money">$0</div>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border border-purple-200 dark:border-purple-800">
                            <div class="text-[10px] text-purple-700 dark:text-purple-400 uppercase font-bold">Personal Debt</div>
                            <div class="text-xl font-bold text-purple-600" id="admin-stat-debt">$0</div>
                        </div>
                    </div>

                    <div id="admin-shortage-warning" class="hidden mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-2 rounded-lg text-xs font-bold text-center border border-red-200 dark:border-red-800">
                        Warning: Short by <span id="admin-shortage-amount">$0</span> against standard prices.
                    </div>

                    <div class="h-32 mb-4 border-b dark:border-gray-700 pb-4">
                        <canvas id="adminTerminalChart"></canvas>
                    </div>

                    <div id="admin-log-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar text-sm">
                        <div class="text-center text-gray-400 py-4 text-xs">No sales recorded yet.</div>
                    </div>
                </div>

            </div>

            <!-- TAB: STAFF PERFORMANCE -->
            <div id="admin-view-staff" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 border border-gray-100 dark:border-gray-700 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 dark:text-white text-sm uppercase tracking-wide">Team Summary</h3>
                        <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300" id="admin-active-count">0 Active</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl border border-gray-200 dark:border-gray-600">
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Total Expected $</div>
                            <div class="text-lg font-bold dark:text-white" id="admin-total-expected">$0</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-xl border border-green-200 dark:border-green-800">
                            <div class="text-[10px] text-green-700 dark:text-green-400 uppercase font-bold">Total Collected $</div>
                            <div class="text-lg font-bold text-green-600 dark:text-green-400" id="admin-total-collected">$0</div>
                        </div>
                    </div>
                    
                    <!-- Admin Overall Graph -->
                    <div class="border-t dark:border-gray-700 pt-4">
                        <h3 class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">Revenue Contribution</h3>
                        <div class="h-40"><canvas id="adminOverallChart"></canvas></div>
                    </div>
                </div>

                <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3 ml-1 text-sm uppercase">Staff List</h3>
                <div id="admin-staff-list" class="space-y-3 mb-6">
                    <div class="text-center py-8 text-gray-400 animate-pulse text-sm">Loading staff data...</div>
                </div>

                <!-- Pending Approvals in Staff Tab -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-3 text-sm uppercase">Pending Approvals</h3>
                    <div id="admin-pending-users" class="space-y-2 text-sm">
                        <div class="text-gray-400 italic text-xs">No pending users.</div>
                    </div>
                </div>
            </div>

            <!-- TAB: TRANSFERS & REQUESTS -->
            <div id="admin-view-transfers" class="admin-tab-content hidden">
                
                <!-- Stock Requests -->
                <div id="admin-requests-section" class="hidden mb-6 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <h3 class="font-bold text-blue-800 dark:text-blue-300 text-xs uppercase mb-3 flex items-center tracking-wide">
                        <i data-lucide="bell" class="w-4 h-4 mr-2"></i> Action Requests
                    </h3>
                    <div id="admin-requests-list" class="space-y-2"></div>
                </div>

                <!-- Transfer Tool -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center text-sm uppercase tracking-wide border-b dark:border-gray-700 pb-2">
                        <i data-lucide="arrow-right-left" class="w-4 h-4 mr-2 text-purple-600"></i> Move Inventory
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Staff Member</label>
                            <select id="transfer-staff-select" onchange="window.updateTransferPreview()" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none text-sm font-bold dark:text-white">
                                <option value="">Select Staff...</option>
                            </select>
                            <div id="transfer-preview" class="text-xs text-blue-600 dark:text-blue-400 mt-1 ml-1 h-4 font-medium"></div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Item to Move</label>
                            <select id="transfer-item-type" onchange="window.updateTransferPreview()" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none text-sm font-bold dark:text-white">
                                <option value="raw">Raw Weight</option>
                                <option value="full">Full Units (1.0)</option>
                                <option value="usual">Usual Units</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Amount to Send/Reclaim</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="number" step="0.1" id="transfer-amount" placeholder="0.0" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none font-black text-lg dark:text-white">
                            </div>
                            <div class="flex space-x-2 mt-2">
                                <button onclick="window.adminTransferWeight('send')" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition flex justify-center items-center"><i data-lucide="arrow-up-right" class="w-4 h-4 mr-1"></i> Send</button>
                                <button onclick="window.adminTransferWeight('reclaim')" class="flex-1 bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-orange-600 active:scale-95 transition flex justify-center items-center"><i data-lucide="arrow-down-left" class="w-4 h-4 mr-1"></i> Reclaim</button>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-2">* Adjusts Master Vault and Staff's inventory.</p>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- User Detail Modal (Admin) -->
    <div id="admin-user-detail" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 overflow-y-auto hidden">
        <div class="bg-white dark:bg-gray-800 p-4 sticky top-0 shadow-md flex justify-between items-center z-10">
            <button onclick="document.getElementById('admin-user-detail').classList.add('hidden')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h2 class="font-bold text-lg dark:text-white" id="detail-user-name">Staff Details</h2>
            <div class="w-9"></div>
        </div>
        <div class="p-4 max-w-2xl mx-auto space-y-4">
            
            <div class="bg-gray-800 text-white p-4 rounded-2xl shadow-sm mb-2">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-2 border-b border-gray-700 pb-1">Holding Inventory</div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><div class="text-[10px] text-gray-400 uppercase">Raw Weight</div><div class="text-xl font-black" id="det-holding-raw">0</div></div>
                    <div><div class="text-[10px] text-blue-400 uppercase">Full Units</div><div class="text-xl font-black" id="det-holding-full">0</div></div>
                    <div><div class="text-[10px] text-orange-400 uppercase">Usual Units</div><div class="text-xl font-black" id="det-holding-usual">0</div></div>
                </div>
            </div>

            <div class="bg-gray-800 text-white p-4 rounded-2xl shadow-sm mb-4">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-2 border-b border-gray-700 pb-1">Total Sold Items</div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><div class="text-[10px] text-gray-400 uppercase">Raw Sold</div><div class="text-xl font-black" id="det-sold-raw">0</div></div>
                    <div><div class="text-[10px] text-blue-400 uppercase">Full Sold</div><div class="text-xl font-black" id="det-sold-full">0</div></div>
                    <div><div class="text-[10px] text-orange-400 uppercase">Usual Sold</div><div class="text-xl font-black" id="det-sold-usual">0</div></div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-4 border-b dark:border-gray-700 pb-2">Revenue Analysis</h3>
                
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm font-bold dark:text-gray-300">Total Expected Value</span>
                    <span class="text-lg font-bold dark:text-white" id="det-expected">$0</span>
                </div>
                
                <div class="border-t border-gray-100 dark:border-gray-700 my-3"></div>
                
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold dark:text-gray-300">Gross Cash Collected</span>
                    <span class="text-lg font-bold text-green-600" id="det-collected">$0</span>
                </div>
                <div class="flex justify-between items-center mb-4 text-xs text-orange-600 dark:text-orange-400">
                    <span class="font-bold flex items-center"><i data-lucide="fuel" class="w-3 h-3 mr-1"></i> Logged Expenses</span>
                    <span class="font-bold" id="det-expenses">-$0</span>
                </div>

                <!-- Earnings and Debt Settlement -->
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-200 dark:border-gray-600 mb-4">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 border-b dark:border-gray-600 pb-1 flex items-center"><i data-lucide="calculator" class="w-3 h-3 mr-1"></i> Earnings & Debt Settlement</h4>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-600 dark:text-gray-400">Gross Commission Earned:</span>
                        <span class="font-bold text-green-600 dark:text-green-400" id="det-calc-gross-comm">$0.00</span>
                    </div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-600 dark:text-gray-400">Total Outstanding Debt:</span>
                        <span class="font-bold text-red-500 dark:text-red-400" id="det-calc-total-debt">$0.00</span>
                    </div>
                    <div class="flex justify-between text-xs mb-3">
                        <span class="text-gray-600 dark:text-gray-400">Commission Applied to Debt:</span>
                        <span class="font-bold text-orange-500" id="det-calc-applied">-$0.00</span>
                    </div>
                    <div class="border-t border-dashed dark:border-gray-600 my-2"></div>
                    <div class="flex justify-between text-sm mb-1 font-bold">
                        <span class="dark:text-white">Net Commission to Pay Staff:</span>
                        <span class="text-blue-600 dark:text-blue-400" id="det-calc-net-comm">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm font-bold">
                        <span class="dark:text-white">Remaining Debt Balance:</span>
                        <span class="text-purple-600 dark:text-purple-400" id="det-calc-rem-debt">$0.00</span>
                    </div>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl border border-blue-200 dark:border-blue-800 mb-3 flex justify-between items-center shadow-inner">
                    <div class="text-xs text-blue-800 dark:text-blue-300 uppercase font-bold tracking-widest leading-tight">Net Cash<br>from Staff</div>
                    <div class="text-3xl font-black text-blue-700 dark:text-blue-400" id="det-net-cash">$0</div>
                </div>

                <div id="det-diff-box" class="p-3 rounded-lg flex justify-between items-center font-bold mb-4">
                    <span class="text-sm uppercase tracking-wide">Shortage / Difference</span>
                    <span class="text-xl" id="det-diff">$0</span>
                </div>
                
                <h3 class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-2 border-b dark:border-gray-700 pb-2">Recent Sales</h3>
                <div class="h-32 mb-4">
                    <canvas id="adminDetailChart"></canvas>
                </div>
            </div>

            <button onclick="window.adminAddBorrowing()" class="w-full mt-4 bg-gray-800 text-white font-bold py-3 rounded-xl border border-gray-700 shadow flex justify-center items-center hover:bg-gray-900 transition btn-interactive">
                <i data-lucide="banknote" class="w-4 h-4 mr-2"></i> Log Cash Advance / Debt
            </button>

            <!-- Danger / Clear -->
            <button onclick="window.adminClearStaffData()" class="w-full mt-4 bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400 font-bold py-3 rounded-xl border border-red-200 dark:border-red-800/50 btn-interactive">
                Clear Shift / Settle Balances
            </button>
            <p class="text-center text-[10px] text-gray-500 mt-2 pb-6">Use this after collecting money. Resets expected and collected, effectively finalizing the settlement.</p>

        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, updateDoc, increment, addDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // ---------------------------------------------------------
        // FIREBASE CONFIGURATION
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDz4iG5KZy3JAxBhubaGEaMKTY7jcObRDE",
            authDomain: "deals-bcfea.firebaseapp.com",
            projectId: "deals-bcfea",
            storageBucket: "deals-bcfea.firebasestorage.app",
            messagingSenderId: "686014043249",
            appId: "1:686014043249:web:8dcc93549cdb265269b7d0"
        };
        const appId = "weight-tracker-v2"; 
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app); 
        const googleProvider = new GoogleAuthProvider();

        // ---------------------------------------------------------
        // GLOBAL STATE
        // ---------------------------------------------------------
        let currentUser = null; 
        let userRole = 'staff'; 
        
        // Staff State
        let appData = { weight: 0, unitsFull: 0, unitsUsual: 0, soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, borrowings: 0, transactions: [] };
        let currentQty = 1;
        let currentType = 'full';

        // Admin State
        let masterData = { rawWeight: 0, unitsFull: 0, unitsUsual: 0, pricePerUnit: 100, usualRatio: 0.8, personalUseDiscount: 20, staffCommission: 0, totalExpenses: 0, cashBalance: 0, liabilities: [] };
        let adminData = { soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, borrowings: 0, transactions: [] };
        let globalRoster = []; 
        let currentDetailUid = null;

        // Admin Terminal Sale State
        let admCurrentQty = 1;
        let admCurrentType = 'full';

        // Chart Instances
        let staffChartInst = null;
        let adminOverallChartInst = null;
        let adminDetailChartInst = null;
        let adminTerminalChartInst = null;
        let financePredictionChartInst = null;

        // Chart Default Styling
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        // Listeners
        let unsubUserData, unsubRoster, unsubMaster, unsubReqs, unsubAuthCheck;

        // ---------------------------------------------------------
        // UTILS
        // ---------------------------------------------------------
        window.showToast = (msg) => { 
            const t = document.getElementById('toast'); 
            t.innerText = msg; 
            t.className = "show"; 
            setTimeout(() => t.className = "", 3000); 
        };
        
        window.toggleTheme = () => { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        };

        // ---------------------------------------------------------
        // AUTH LOGIC
        // ---------------------------------------------------------
        window.handleGoogleLogin = async () => { 
            try { 
                const res = await signInWithPopup(auth, googleProvider);
                const profRef = doc(db, 'artifacts', appId, 'users', res.user.uid, 'settings', 'profile');
                const snap = await getDoc(profRef);
                
                // If New User -> Auto assign pending staff
                if(!snap.exists()) {
                    await setDoc(profRef, { name: res.user.displayName, email: res.user.email, role: 'staff', status: 'pending', createdAt: Date.now() });
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', res.user.uid), { name: res.user.displayName, role: 'staff', status: 'pending', uid: res.user.uid }, {merge:true});
                }
            } catch (e) { 
                console.error("Auth Error:", e);
                window.showToast("Login Failed: " + e.message); 
            }
        };

        window.logout = async () => { 
            if(unsubUserData) unsubUserData(); if(unsubRoster) unsubRoster(); if(unsubMaster) unsubMaster(); if(unsubAuthCheck) unsubAuthCheck();
            
            document.getElementById('staff-app').classList.add('hidden');
            document.getElementById('admin-app').classList.add('hidden');
            document.getElementById('approval-modal').classList.add('hidden');
            
            await signOut(auth); 
            window.location.reload(); 
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', user.uid);
                
                unsubAuthCheck = onSnapshot(rosterRef, (snap) => {
                    const data = snap.data() || {};
                    const role = data.role || 'staff';
                    const status = data.status || 'pending';
                    userRole = role;
                    
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('login-modal').classList.add('hidden');

                    if (role === 'admin') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        document.getElementById('staff-app').classList.add('hidden');
                        initAdminDashboard(user);
                    } else if (status === 'active') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        document.getElementById('admin-app').classList.add('hidden');
                        initStaffApp(user);
                    } else {
                        // Pending or Suspended
                        document.getElementById('approval-modal').classList.remove('hidden');
                        document.getElementById('staff-app').classList.add('hidden');
                        document.getElementById('admin-app').classList.add('hidden');
                        
                        const title = document.getElementById('approval-title');
                        const msg = document.getElementById('approval-msg');
                        if(status === 'suspended') {
                            title.innerText = "Account Suspended";
                            msg.innerText = "Your access has been restricted by management.";
                        } else {
                            title.innerText = "Access Pending";
                            msg.innerText = "Waiting for Admin to approve your account.";
                        }
                    }
                }, (error) => {
                    console.error("Roster Access Denied:", error);
                    document.getElementById('loading-overlay').classList.add('hidden');
                    window.showToast("Permission denied. Check Firebase Rules.");
                });

                // Always listen to master data for calculations
                unsubMaster = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), (s) => {
                    if(s.exists()) {
                        masterData = { rawWeight: 0, unitsFull: 0, unitsUsual: 0, pricePerUnit: 100, usualRatio: 0.8, personalUseDiscount: 20, staffCommission: 0, totalExpenses: 0, cashBalance: 0, liabilities: [], ...s.data() };
                        updateMasterLabels();
                        if(userRole === 'admin') {
                            window.admUpdateMasterLabels();
                            updateFinanceUI();
                        }
                        if(userRole === 'staff' && typeof renderStaffUI === 'function') renderStaffUI();
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), masterData).catch(e => console.log(e));
                    }
                });

            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });

        function updateMasterLabels() {
            // Staff Pricing Labels
            const labelFull = document.getElementById('label-full-weight');
            const labelUsual = document.getElementById('label-usual-weight');
            const expHint = document.getElementById('expected-money-hint');
            
            if(labelFull) labelFull.innerText = `(${(currentQty * 1.0).toFixed(1)} units)`;
            if(labelUsual) labelUsual.innerText = `(${(currentQty * masterData.usualRatio).toFixed(1)} units)`;
            
            // Dynamic Expected Calculation (Staff)
            const unitPrice = currentType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            if(expHint) expHint.innerText = `Expected: $${currentQty * unitPrice}`;

            // Sync Buttons
            const btnUsual = document.getElementById('btn-quick-usual');
            const btnFull = document.getElementById('btn-quick-full');
            if(btnUsual) btnUsual.innerText = `$${masterData.pricePerUnit * masterData.usualRatio} (Usual)`;
            if(btnFull) btnFull.innerText = `$${masterData.pricePerUnit} (Full)`;

            // Admin Display Updates
            const wRaw = document.getElementById('admin-master-weight');
            const pDisp = document.getElementById('admin-price-display');
            const rDisp = document.getElementById('admin-ratio-display');
            const discDisp = document.getElementById('admin-discount-display');
            const commDisp = document.getElementById('admin-commission-display');
            
            const expDisp = document.getElementById('admin-total-expenses');
            const uFull = document.getElementById('admin-units-full');
            const uUsual = document.getElementById('admin-units-usual');
            
            const hRat = document.getElementById('hint-ratio-txt');
            const stockFull = document.getElementById('admin-stock-full');
            const stockUsual = document.getElementById('admin-stock-usual');

            const rawW = masterData.rawWeight || 0;
            const price = masterData.pricePerUnit || 0;
            const ratio = masterData.usualRatio || 1;
            const expenses = masterData.totalExpenses || 0;

            if(wRaw) wRaw.innerText = rawW.toFixed(1);
            if(pDisp) pDisp.innerText = `$${price}`;
            if(rDisp) rDisp.innerText = `${ratio}x`;
            if(discDisp) discDisp.innerText = `${masterData.personalUseDiscount}% Off`;
            if(commDisp) commDisp.innerText = `${masterData.staffCommission}%`;
            if(expDisp) expDisp.innerText = `-$${expenses}`;
            
            if(stockFull) stockFull.innerText = masterData.unitsFull || 0;
            if(stockUsual) stockUsual.innerText = masterData.unitsUsual || 0;
            if(hRat) hRat.innerText = ratio;
        }

        // ---------------------------------------------------------
        // STAFF TERMINAL LOGIC
        // ---------------------------------------------------------
        function initStaffApp(user) {
            document.getElementById('staff-app').classList.remove('hidden');
            document.getElementById('staff-name-display').innerText = user.displayName || user.email;

            unsubUserData = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state'), (snap) => { 
                if(snap.exists()) { 
                    const d = JSON.parse(snap.data().json);
                    appData = { weight: 0, unitsFull: 0, unitsUsual: 0, soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, borrowings: 0, transactions: [], ...d };
                    renderStaffUI(); 
                } else { saveStaffData(); } 
            });
        }

        function renderStaffUI() {
            // Stock
            document.getElementById('staff-stock').innerText = (appData.weight || 0).toFixed(1);
            document.getElementById('staff-stock-full').innerText = (appData.unitsFull || 0);
            document.getElementById('staff-stock-usual').innerText = (appData.unitsUsual || 0);
            
            // Stats Breakdown
            document.getElementById('staff-stat-sold-raw').innerText = (appData.soldWeight || 0).toFixed(1);
            document.getElementById('staff-stat-sold-full').innerText = (appData.soldUnitsFull || 0);
            document.getElementById('staff-stat-sold-usual').innerText = (appData.soldUnitsUsual || 0);
            
            document.getElementById('staff-stat-money').innerText = `$${appData.collected || 0}`;
            document.getElementById('staff-stat-expenses').innerText = `-$${appData.expenses || 0}`;
            
            // Commission & Debt Calculation
            const grossComm = (appData.collected || 0) * ((masterData.staffCommission || 0) / 100);
            const totalDebt = (appData.personalUseOwed || 0) + (appData.borrowings || 0);
            
            // Apply Commission to Debt First
            const appliedToDebt = Math.min(grossComm, totalDebt);
            const netComm = grossComm - appliedToDebt;
            const remainingDebt = totalDebt - appliedToDebt;

            document.getElementById('staff-calc-gross-comm').innerText = `$${grossComm.toFixed(2)}`;
            document.getElementById('staff-calc-total-debt').innerText = `$${totalDebt.toFixed(2)}`;
            document.getElementById('staff-calc-applied').innerText = `-$${appliedToDebt.toFixed(2)}`;
            document.getElementById('staff-calc-net-comm').innerText = `$${netComm.toFixed(2)}`;
            document.getElementById('staff-calc-rem-debt').innerText = `$${remainingDebt.toFixed(2)}`;

            // Net Cash calculation for Boss (Gross - Expenses - Net Commission)
            const netCash = (appData.collected || 0) - (appData.expenses || 0) - netComm;
            document.getElementById('staff-stat-net').innerText = `$${netCash.toFixed(2)}`;

            // Shortage checking (Expected includes the discounted personal debt & borrowings)
            const diff = (appData.expected || 0) - (appData.collected || 0);
            const warn = document.getElementById('staff-shortage-warning');
            if(diff > 0) {
                warn.classList.remove('hidden');
                document.getElementById('staff-shortage-amount').innerText = `$${diff.toFixed(2)}`;
            } else {
                warn.classList.add('hidden');
            }

            // Update Staff Chart
            updateStaffChart(appData.transactions);

            const list = document.getElementById('staff-log-list');
            list.innerHTML = '';
            
            const reversed = [...appData.transactions].reverse();
            reversed.forEach(t => {
                if(t.type === 'personal') {
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-2 border border-purple-100 dark:border-purple-800">
                        <div>
                            <div class="font-bold text-purple-800 dark:text-purple-300"><i data-lucide="user" class="inline w-3 h-3 mr-1"></i> Personal Use (${t.qty} units)</div>
                            <div class="text-xs text-gray-500">${t.time}  ${masterData.personalUseDiscount}% Discount Applied</div>
                        </div>
                        <div class="text-right"><div class="font-black text-purple-600 dark:text-purple-400">+$${t.expected} Owed</div></div>
                    </div>`;
                } else if(t.type === 'expense') {
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded-xl mb-2 border border-orange-100 dark:border-orange-800">
                        <div>
                            <div class="font-bold text-orange-800 dark:text-orange-300"><i data-lucide="fuel" class="inline w-3 h-3 mr-1"></i> Expense: ${t.desc}</div>
                            <div class="text-xs text-gray-500">${t.time}</div>
                        </div>
                        <div class="text-right"><div class="font-black text-orange-600 dark:text-orange-400">-$${Math.abs(t.money)}</div></div>
                    </div>`;
                } else if (t.type === 'borrowing') {
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/20 rounded-xl mb-2 border border-red-100 dark:border-red-800">
                        <div>
                            <div class="font-bold text-red-800 dark:text-red-300"><i data-lucide="banknote" class="inline w-3 h-3 mr-1"></i> Cash Advance / Debt</div>
                            <div class="text-xs text-gray-500">${t.time}  ${t.desc}</div>
                        </div>
                        <div class="text-right"><div class="font-black text-red-600 dark:text-red-400">+$${t.expected} Owed</div></div>
                    </div>`;
                } else {
                    const color = t.type === 'full' ? 'text-green-600' : (t.type === 'usual' ? 'text-orange-500' : 'text-blue-500');
                    const label = t.type === 'full' ? 'Full' : (t.type === 'raw' ? 'Raw' : 'Usual');
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-xl mb-2 border border-gray-200 dark:border-gray-600">
                        <div>
                            <div class="font-bold dark:text-white">Sold ${t.qty} <span class="text-[10px] ${color} uppercase tracking-wider ml-1">(${label})</span></div>
                            <div class="text-xs text-gray-500">${t.time}  Used: ${t.actualWeight.toFixed(1)} u</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-green-600">+$${t.money}</div>
                        </div>
                    </div>`;
                }
            });
            if(reversed.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>';
            lucide.createIcons();
        }

        function updateStaffChart(transactions) {
            const ctx = document.getElementById('staffChart');
            if(!ctx) return;
            
            const sales = transactions.filter(t => t.type !== 'personal' && t.type !== 'expense' && t.type !== 'borrowing').reverse(); 
            const labels = sales.map(t => t.time);
            const data = sales.map(t => t.money);

            if(staffChartInst) staffChartInst.destroy();
            staffChartInst = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sale ($)',
                        data: data,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function saveStaffData() { 
            if(!currentUser) return; 
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state'), { json: JSON.stringify(appData), lastUpdated: Date.now() }); 
            
            // Sync summary to public roster
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid), { 
                    weight: appData.weight,
                    unitsFull: appData.unitsFull || 0,
                    unitsUsual: appData.unitsUsual || 0,
                    soldWeight: appData.soldWeight,
                    soldUnitsFull: appData.soldUnitsFull || 0,
                    soldUnitsUsual: appData.soldUnitsUsual || 0,
                    personalUseWeight: appData.personalUseWeight || 0,
                    personalUseOwed: appData.personalUseOwed || 0,
                    borrowings: appData.borrowings || 0,
                    collected: appData.collected,
                    expected: appData.expected,
                    expenses: appData.expenses || 0,
                    recentLogs: appData.transactions.slice(-10).reverse(), 
                    lastSync: Date.now() 
                }, { merge: true }); 
            } catch(e){} 
        }

        // Terminal Actions
        window.checkPriceColor = () => {
            const input = document.getElementById('money-input');
            const val = parseFloat(input.value) || 0;
            const perUnit = val / currentQty;
            
            input.classList.remove('text-gray-400', 'text-red-500', 'text-orange-500', 'text-green-500', 'dark:text-white', 'dark:text-red-500', 'dark:text-orange-500', 'dark:text-green-500');

            if (val === 0) {
                input.classList.add('dark:text-white', 'text-gray-800');
                return;
            }

            if (currentType === 'usual') {
                const usualPrice = masterData.pricePerUnit * masterData.usualRatio;
                if (perUnit < usualPrice) input.classList.add('text-red-500', 'dark:text-red-500');
                else if (perUnit < masterData.pricePerUnit) input.classList.add('text-orange-500', 'dark:text-orange-500');
                else input.classList.add('text-green-500', 'dark:text-green-500');
            } else {
                if (perUnit < masterData.pricePerUnit) input.classList.add('text-red-500', 'dark:text-red-500');
                else input.classList.add('text-green-500', 'dark:text-green-500');
            }
        };

        window.setQuickPrice = (pricePerUnit) => {
            const input = document.getElementById('money-input');
            input.value = pricePerUnit * currentQty;
            window.checkPriceColor();
        };

        window.selectQty = (q) => {
            currentQty = q;
            document.querySelectorAll('.qty-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-qty-${q}`).classList.add('active');
            window.updateMasterLabels();
            window.checkPriceColor();
        };

        window.selectType = (t) => {
            currentType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-type-${t}`).classList.add('active');
            window.updateMasterLabels();
            window.checkPriceColor();
        };

        window.processSale = async () => {
            const source = document.getElementById('staff-sale-source').value;
            const moneyInput = document.getElementById('money-input');
            const money = parseFloat(moneyInput.value);
            if(isNaN(money) || money < 0) return window.showToast("Enter valid money received");

            let actualWeightDeducted = 0;
            const unitPrice = currentType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);

            if (source === 'raw') {
                actualWeightDeducted = currentType === 'full' ? currentQty * 1.0 : currentQty * masterData.usualRatio;
                if(appData.weight < actualWeightDeducted) return window.showToast(`Not enough raw weight! Need ${actualWeightDeducted.toFixed(1)}`);
                appData.weight -= actualWeightDeducted;
            } else if (source === 'processed' && currentType === 'full') {
                if(appData.unitsFull < currentQty) return window.showToast("Not enough Full Pre-Packs!");
                appData.unitsFull -= currentQty;
                actualWeightDeducted = currentQty * 1.0;
            } else if (source === 'processed' && currentType === 'usual') {
                if(appData.unitsUsual < currentQty) return window.showToast("Not enough Usual Pre-Packs!");
                appData.unitsUsual -= currentQty;
                actualWeightDeducted = currentQty * masterData.usualRatio;
            }

            const expectedMoney = currentQty * unitPrice;

            if (source === 'raw') {
                appData.soldWeight += actualWeightDeducted;
            } else if (source === 'processed' && currentType === 'full') {
                appData.soldUnitsFull += currentQty;
            } else if (source === 'processed' && currentType === 'usual') {
                appData.soldUnitsUsual += currentQty;
            }

            appData.collected += money;
            appData.expected += expectedMoney;

            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: currentQty,
                type: currentType,
                actualWeight: actualWeightDeducted,
                money: money,
                expected: expectedMoney
            });

            moneyInput.value = '';
            await saveStaffData();
            window.showToast("Sale Complete!");
        };

        window.staffPersonalUse = async () => {
            const source = document.getElementById('staff-sale-source').value;
            const unitPrice = currentType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            
            if(!confirm(`Log Personal Use for ${currentQty} ${currentType.toUpperCase()} units from ${source.toUpperCase()} inventory?\n\nYou will be charged the standard price at a ${masterData.personalUseDiscount}% discount.`)) return;

            let actualWeightDeducted = 0;
            let standardCost = currentQty * unitPrice;

            if (source === 'raw') {
                actualWeightDeducted = currentType === 'full' ? currentQty * 1.0 : currentQty * masterData.usualRatio;
                if(appData.weight < actualWeightDeducted) return window.showToast("Not enough raw weight!");
                appData.weight -= actualWeightDeducted;
            } else if (source === 'processed' && currentType === 'full') {
                if(appData.unitsFull < currentQty) return window.showToast("Not enough Full Pre-Packs!");
                appData.unitsFull -= currentQty;
                actualWeightDeducted = currentQty * 1.0;
            } else if (source === 'processed' && currentType === 'usual') {
                if(appData.unitsUsual < currentQty) return window.showToast("Not enough Usual Pre-Packs!");
                appData.unitsUsual -= currentQty;
                actualWeightDeducted = currentQty * masterData.usualRatio;
            }

            const discountMultiplier = 1 - (masterData.personalUseDiscount / 100);
            const discountedDebt = standardCost * discountMultiplier;
            
            appData.personalUseWeight = (appData.personalUseWeight || 0) + actualWeightDeducted;
            appData.expected += discountedDebt;
            appData.personalUseOwed = (appData.personalUseOwed || 0) + discountedDebt;
            
            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: currentQty,
                type: 'personal',
                actualWeight: actualWeightDeducted,
                money: 0,
                expected: discountedDebt
            });
            
            await saveStaffData();
            window.showToast(`Logged ${currentType.toUpperCase()} unit(s) for personal use.`);
        };

        window.staffExpense = async () => {
            const desc = prompt("What is this expense for? (e.g., Gas, Food)");
            if(!desc) return;
            const amt = parseFloat(prompt(`How much did you spend on ${desc}? ($)`));
            if(isNaN(amt) || amt <= 0) return;
            
            appData.expenses = (appData.expenses || 0) + amt;
            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: 0, type: 'expense', actualWeight: 0, money: -amt, expected: 0, desc: desc
            });
            await saveStaffData();
            window.showToast("Expense Logged.");
        };

        window.submitStaffBillReq = async () => {
            const desc = document.getElementById('req-bill-desc').value;
            const amt = parseFloat(document.getElementById('req-bill-amt').value);
            if(!desc || isNaN(amt) || amt <= 0) return window.showToast("Enter description and valid amount.");
            
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), { 
                uid: currentUser.uid, name: currentUser.displayName || 'Staff', timestamp: Date.now(), status: 'pending', type: 'bill_request', desc: desc, amount: amt 
            }); 
            
            document.getElementById('staff-bill-modal').classList.add('hidden');
            document.getElementById('req-bill-desc').value = '';
            document.getElementById('req-bill-amt').value = '';
            window.showToast("Bill Request Sent to Admin"); 
        };

        window.requestWeight = async () => { 
            if(confirm("Notify admin you need more weight?")) { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), { 
                    uid: currentUser.uid, name: currentUser.displayName || 'Staff', timestamp: Date.now(), status: 'pending', type: 'weight'
                }); 
                window.showToast("Request Sent"); 
            } 
        };

        // ---------------------------------------------------------
        // ADMIN LOGIC
        // ---------------------------------------------------------
        window.switchAdminTab = (t) => { 
            ['storage','terminal','staff','transfers','finance'].forEach(x => { 
                document.getElementById(`admin-view-${x}`).classList.add('hidden'); 
                document.getElementById(`adm-tab-${x}`).classList.remove('bg-gray-800','text-white','shadow'); 
                document.getElementById(`adm-tab-${x}`).classList.add('bg-white','dark:bg-gray-800','text-gray-600','dark:text-gray-300');
            }); 
            document.getElementById(`admin-view-${t}`).classList.remove('hidden'); 
            document.getElementById(`adm-tab-${t}`).classList.add('bg-gray-800','text-white','shadow'); 
            document.getElementById(`adm-tab-${t}`).classList.remove('bg-white','dark:bg-gray-800','text-gray-600','dark:text-gray-300');
        };

        function initAdminDashboard(user) {
            document.getElementById('admin-app').classList.remove('hidden');
            
            // Listen to Admin's own state
            unsubUserData = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state'), (snap) => { 
                if(snap.exists()) { 
                    const d = JSON.parse(snap.data().json);
                    adminData = { soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, borrowings: 0, transactions: [], ...d };
                    renderAdminTerminalUI(); 
                } else { saveAdminData(); } 
            });

            // Show admin settings in modal
            const adminSet = document.getElementById('admin-settings-section');
            if(adminSet) adminSet.classList.remove('hidden');

            unsubRoster = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), (snap) => {
                const list = document.getElementById('admin-staff-list'); 
                const select = document.getElementById('transfer-staff-select');
                const pendingList = document.getElementById('admin-pending-users');
                const staffTab = document.getElementById('adm-tab-staff');
                
                list.innerHTML=''; select.innerHTML='<option value="">Select Staff...</option>'; pendingList.innerHTML='';
                globalRoster=[]; 
                
                let totExp = 0, totCol = 0, activeCount = 0, pendCount = 0;
                let globalRaw = 0, globalFull = 0, globalUsual = 0;

                snap.forEach(d => {
                    const u = { id: d.id, ...d.data() }; 
                    globalRoster.push(u);
                    
                    if(u.status === 'pending') {
                        if (u.role !== 'admin') {
                            pendCount++;
                            pendingList.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-orange-50 dark:bg-orange-900/20 rounded border border-orange-100 dark:border-orange-800">
                                <span class="font-bold text-orange-800 dark:text-orange-300">${u.name}</span>
                                <div><button onclick="window.adminSetStatus('${u.id}', 'active')" class="bg-green-500 text-white text-xs px-3 py-1 rounded font-bold mr-1 hover:bg-green-600 btn-interactive">Approve</button>
                                <button onclick="window.adminDelUser('${u.id}')" class="text-red-500 text-xs px-2 hover:underline">Deny</button></div>
                            </div>`;
                        }
                    } else {
                        activeCount++;
                        totExp += (u.expected || 0);
                        totCol += (u.collected || 0);
                        
                        if (u.role !== 'admin') {
                            globalRaw += (u.weight || 0);
                            globalFull += (u.unitsFull || 0);
                            globalUsual += (u.unitsUsual || 0);
                        }
                        
                        const diff = (u.expected || 0) - (u.collected || 0);
                        const diffColor = diff > 0 ? 'text-red-500 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50' : (diff < 0 ? 'text-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-500 bg-gray-50 dark:bg-gray-800');
                        const diffSign = diff > 0 ? `-$${diff.toFixed(2)}` : (diff < 0 ? `+$${Math.abs(diff).toFixed(2)}` : '$0');

                        const badge = u.role === 'admin' ? '<span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full ml-2">ADMIN</span>' : '';

                        list.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-blue-400 transition" onclick="window.viewDriverDetails('${u.id}')">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold dark:text-white flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs mr-2 border border-blue-200">${u.name[0]}</div>
                                    ${u.name} ${badge}
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-500">${u.role === 'admin' ? 'Total Sold' : 'Holding'}</div>
                                    <div class="font-black dark:text-white">${u.role === 'admin' ? (u.soldWeight||0).toFixed(1) : (u.weight||0).toFixed(1)} u</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-end border-t dark:border-gray-700 pt-2">
                                <div class="text-xs text-gray-500">
                                    Exp: <span class="font-bold text-gray-800 dark:text-gray-300">$${(u.expected||0).toFixed(2)}</span><br>
                                    Col: <span class="font-bold text-green-600">$${(u.collected||0).toFixed(2)}</span>
                                </div>
                                <div class="text-xs font-bold px-2 py-1 rounded ${diffColor}">
                                    Diff: ${diffSign}
                                </div>
                            </div>
                        </div>`;
                        
                        if (u.role !== 'admin') {
                            const opt = document.createElement('option'); opt.value=u.id; opt.innerText=`${u.name} (${(u.weight||0).toFixed(1)} u)`; 
                            select.appendChild(opt); 
                        }
                    }
                });
                
                document.getElementById('admin-active-count').innerText = `${activeCount} Active`;
                document.getElementById('admin-total-expected').innerText = `$${totExp.toFixed(2)}`;
                document.getElementById('admin-total-collected').innerText = `$${totCol.toFixed(2)}`;
                
                // Update Global Assets in Vault tab
                document.getElementById('global-stock-raw').innerText = ((masterData.rawWeight || 0) + globalRaw).toFixed(1);
                document.getElementById('global-stock-full').innerText = ((masterData.unitsFull || 0) + globalFull);
                document.getElementById('global-stock-usual').innerText = ((masterData.unitsUsual || 0) + globalUsual);
                
                // Update Charts
                updateAdminOverallChart(globalRoster);
                updateFinanceUI(); 
                
                if(pendCount === 0) {
                    pendingList.innerHTML = '<div class="text-gray-400 italic text-xs">No pending users.</div>';
                    staffTab.innerHTML = `<i data-lucide="users" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Team</span>`;
                } else {
                    staffTab.innerHTML = `<i data-lucide="users" class="w-4 h-4 mb-1"></i> <span class="hidden sm:inline">Team</span> <span class="absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full"></span>`;
                }
                lucide.createIcons();
            });

            unsubReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                const section = document.getElementById('admin-requests-section'); 
                const list = document.getElementById('admin-requests-list'); 
                list.innerHTML = ''; let count = 0;
                snap.forEach(d => { 
                    const req = d.data(); 
                    if(req.status === 'pending') { 
                        count++; 
                        if(req.type === 'bill_request') {
                            list.innerHTML += `<div class="bg-white dark:bg-gray-800 p-3 rounded-lg flex flex-col sm:flex-row sm:justify-between sm:items-center text-sm shadow-sm border border-gray-100 dark:border-gray-700">
                                <div class="mb-2 sm:mb-0">
                                    <span class="font-bold dark:text-white">${req.name} <span class="text-xs font-normal text-purple-500 ml-1 border border-purple-200 bg-purple-50 px-1 rounded">Bill Request</span></span>
                                    <div class="text-xs text-gray-500 mt-1">${req.desc} <span class="font-bold text-gray-800 dark:text-gray-300">($${req.amount})</span></div>
                                </div>
                                <div class="space-x-1 flex">
                                    <button onclick="window.prepareApproveBill('${d.id}', '${req.desc}', ${req.amount})" class="flex-1 bg-purple-600 text-white text-xs px-3 py-1.5 rounded font-bold hover:bg-purple-700 btn-interactive text-center">Approve</button>
                                    <button onclick="window.dismissReq('${d.id}')" class="flex-1 bg-gray-200 text-gray-700 text-xs px-2 py-1.5 rounded hover:bg-gray-300 btn-interactive text-center">Dismiss</button>
                                </div>
                            </div>`; 
                        } else {
                            list.innerHTML += `<div class="bg-white dark:bg-gray-800 p-2 rounded-lg flex justify-between items-center text-sm shadow-sm border border-gray-100 dark:border-gray-700">
                                <span class="font-bold dark:text-white">${req.name} <span class="text-xs font-normal text-gray-500 ml-2">Needs weight</span></span>
                                <div class="space-x-1">
                                    <button onclick="window.fulfillReq('${d.id}', '${req.uid}')" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded font-bold hover:bg-blue-700 btn-interactive">Fulfill</button>
                                    <button onclick="window.dismissReq('${d.id}')" class="bg-gray-200 text-gray-700 text-xs px-2 py-1.5 rounded hover:bg-gray-300 btn-interactive">Dismiss</button>
                                </div>
                            </div>`;
                        }
                    }
                });
                if(count > 0) {
                    section.classList.remove('hidden');
                    document.getElementById('admin-req-badge').classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                    document.getElementById('admin-req-badge').classList.add('hidden');
                }
            });
        }

        function updateAdminOverallChart(roster) {
            const ctx = document.getElementById('adminOverallChart');
            if(!ctx) return;
            
            const activeStaff = roster.filter(u => u.status === 'active' || u.role === 'admin');
            const labels = activeStaff.map(u => u.role === 'admin' ? `${u.name} (Admin)` : u.name);
            const data = activeStaff.map(u => u.collected || 0);

            if(adminOverallChartInst) adminOverallChartInst.destroy();
            adminOverallChartInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Collected ($)',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- NEW FINANCE TAB LOGIC ---
        function updateFinanceUI() {
            if (!document.getElementById('admin-view-finance')) return;
            
            // 1. Gather Totals
            let staffFull = 0, staffUsual = 0, teamCollected = 0;
            globalRoster.forEach(u => {
                if (u.role !== 'admin') {
                    staffFull += (u.unitsFull || 0);
                    staffUsual += (u.unitsUsual || 0);
                }
                teamCollected += (u.collected || 0);
            });

            const totalFull = (masterData.unitsFull || 0) + staffFull;
            const totalUsual = (masterData.unitsUsual || 0) + staffUsual;

            // Display Unit Counts
            document.getElementById('proj-full-count').innerText = totalFull;
            document.getElementById('proj-usual-count').innerText = totalUsual;

            // Calculations
            const priceFull = masterData.pricePerUnit;
            const priceUsual = masterData.pricePerUnit * masterData.usualRatio;
            
            // Standard Projection
            const projFullStd = totalFull * priceFull;
            const projUsualStd = totalUsual * priceUsual;
            const totalProjStd = projFullStd + projUsualStd;

            // What If Projection (Both x100)
            const totalWhatIf = (totalFull * priceFull) + (totalUsual * priceFull); 
            
            document.getElementById('proj-std-total').innerText = `$${totalProjStd.toLocaleString()}`;
            document.getElementById('proj-whatif-total').innerText = `$${totalWhatIf.toLocaleString()}`;

            // Balance Manager DOM
            document.getElementById('finance-cash-balance').innerText = `$${(masterData.cashBalance || 0).toFixed(2)}`;
            
            const liabList = document.getElementById('finance-liabilities-list');
            liabList.innerHTML = '';
            
            let unpaidTotal = 0;

            if (masterData.liabilities && masterData.liabilities.length > 0) {
                masterData.liabilities.forEach(l => {
                    if(!l.isPaid) unpaidTotal += l.amount;
                    const recurringBadge = l.isRecurring ? `<span class="bg-blue-100 text-blue-600 text-[9px] px-1.5 py-0.5 rounded ml-2 uppercase tracking-wide">Recurring</span>` : '';
                    const dateDisplay = l.dueDate ? `<div class="text-[10px] text-gray-500 mt-1">Due: ${new Date(l.dueDate).toLocaleDateString()}</div>` : '';

                    liabList.innerHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg border ${l.isPaid ? 'bg-gray-50 border-gray-200 dark:bg-gray-800 dark:border-gray-700 opacity-60' : 'bg-white border-purple-200 dark:bg-gray-700 dark:border-purple-800'} shadow-sm">
                        <div class="flex items-start">
                            <input type="checkbox" ${l.isPaid ? 'checked' : ''} onchange="window.adminToggleLiability(${l.id})" class="w-4 h-4 mr-3 mt-1 accent-purple-600 cursor-pointer">
                            <div>
                                <span class="font-bold ${l.isPaid ? 'line-through text-gray-400' : 'dark:text-white'} text-sm">${l.name} ${recurringBadge}</span>
                                ${dateDisplay}
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-black ${l.isPaid ? 'text-gray-400' : 'text-purple-600 dark:text-purple-400'} mr-3">$${l.amount.toFixed(2)}</span>
                            <button onclick="window.adminRemoveLiability(${l.id})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`;
                });
            } else {
                liabList.innerHTML = '<div class="text-center py-4 text-xs text-gray-400 italic">No priorities added yet.</div>';
            }

            document.getElementById('finance-unpaid-total').innerText = `-$${unpaidTotal.toFixed(2)}`;
            const netAfterBills = (masterData.cashBalance || 0) - unpaidTotal;
            document.getElementById('finance-net-after-bills').innerText = `$${netAfterBills.toFixed(2)}`;
            if(netAfterBills < 0) document.getElementById('finance-net-after-bills').classList.replace('text-green-600', 'text-red-500');
            else document.getElementById('finance-net-after-bills').classList.replace('text-red-500', 'text-green-600');

            // 7-Day Revenue Forecast Chart
            const ctxPred = document.getElementById('financePredictionChart');
            if(ctxPred) {
                // Simplistic daily average assuming the current shift is 1 day, extrapolated to 7 days
                const dailyAvg = teamCollected; 
                const labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
                const data = labels.map((_, i) => dailyAvg * (i + 1));

                if(financePredictionChartInst) financePredictionChartInst.destroy();
                financePredictionChartInst = new Chart(ctxPred, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Projected Revenue ($)',
                            data: data,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2, fill: true, tension: 0.2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            lucide.createIcons();
        }

        window.adminUpdateCash = async () => {
            const current = masterData.cashBalance || 0;
            const amt = parseFloat(prompt(`Current Master Cash: $${current}\n\nEnter amount to add/subtract (use negative number to subtract):`, "0"));
            if(isNaN(amt)) return;
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { cashBalance: current + amt }, {merge:true});
        };

        window.prepareApproveBill = (reqId, desc, amount) => {
            document.getElementById('bill-name').value = desc;
            document.getElementById('bill-amt').value = amount;
            document.getElementById('bill-request-id').value = reqId; // Store link to dismiss after
            document.getElementById('admin-bill-modal').classList.remove('hidden');
        };

        window.saveAdminBill = async () => {
            const name = document.getElementById('bill-name').value;
            const amt = parseFloat(document.getElementById('bill-amt').value);
            const date = document.getElementById('bill-date').value;
            const isRecurring = document.getElementById('bill-recurring').checked;
            const reqId = document.getElementById('bill-request-id').value;

            if(!name || isNaN(amt) || amt <= 0) return window.showToast("Enter valid bill details.");
            
            const newLiabs = [...(masterData.liabilities || []), { id: Date.now(), name, amount: amt, dueDate: date, isRecurring, isPaid: false }];
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { liabilities: newLiabs }, {merge:true});
            
            if(reqId) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId));
            }

            document.getElementById('admin-bill-modal').classList.add('hidden');
            document.getElementById('bill-name').value = '';
            document.getElementById('bill-amt').value = '';
            document.getElementById('bill-date').value = '';
            document.getElementById('bill-recurring').checked = false;
            document.getElementById('bill-request-id').value = '';
            window.showToast("Bill Priority Added!");
        };

        window.adminToggleLiability = async (id) => {
            const liabs = (masterData.liabilities || []).map(l => l.id === id ? { ...l, isPaid: !l.isPaid } : l);
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { liabilities: liabs }, {merge:true});
        };

        window.adminRemoveLiability = async (id) => {
            if(!confirm("Remove this liability from list?")) return;
            const liabs = (masterData.liabilities || []).filter(l => l.id !== id);
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { liabilities: liabs }, {merge:true});
        };


        // Admin Master Controls
        window.adminAddWeight = async () => { 
            const q = prompt("Add weight to Master Vault (Units):"); 
            if(q && !isNaN(q)) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{rawWeight:increment(parseFloat(q))},{merge:true}); 
        };

        window.adminPurchaseStock = async (weight, cost) => {
            if (weight === 'custom') {
                weight = parseFloat(prompt("Enter custom weight amount (units):"));
                if (isNaN(weight) || weight <= 0) return;
                cost = parseFloat(prompt("Enter total cost of purchase ($):"));
                if (isNaN(cost) || cost < 0) return;
            }
            if(!confirm(`Confirm Purchase: Add ${weight} units for $${cost}?`)) return;
            
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{
                rawWeight: increment(weight),
                totalExpenses: increment(cost)
            }, {merge:true});
            
            window.showToast(`Restocked ${weight} units for $${cost}.`);
        };

        window.adminSetVariable = async (field, label) => {
            const v = prompt(`Set ${label}:`, masterData[field]);
            if(v && !isNaN(v)) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[field]: parseFloat(v)},{merge:true});
        };

        window.adminProcessUnits = async () => {
            const type = document.getElementById('process-type').value;
            const qty = parseInt(document.getElementById('process-qty').value);
            
            if(isNaN(qty) || qty <= 0) return window.showToast("Enter valid quantity");
            
            const wpu = type === 'full' ? 1.0 : masterData.usualRatio;
            const totalW = qty * wpu;
            
            if(masterData.rawWeight < totalW) return window.showToast("Not enough raw weight in vault!");

            const updateData = { rawWeight: increment(-totalW) };
            if (type === 'full') updateData.unitsFull = increment(qty);
            else updateData.unitsUsual = increment(qty);

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), updateData, {merge:true});
            
            document.getElementById('process-qty').value = '';
            window.showToast(`Processed ${qty} ${type} units.`);
        };

        // ADMIN TERMINAL SALE LOGIC
        window.admUpdateMasterLabels = () => {
            const labelFull = document.getElementById('adm-label-full-weight');
            const labelUsual = document.getElementById('adm-label-usual-weight');
            const expHint = document.getElementById('adm-expected-money-hint');
            
            if(labelFull) labelFull.innerText = `(${(admCurrentQty * 1.0).toFixed(1)} units)`;
            if(labelUsual) labelUsual.innerText = `(${(admCurrentQty * masterData.usualRatio).toFixed(1)} units)`;
            
            const unitPrice = admCurrentType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            if(expHint) expHint.innerText = `Expected: $${admCurrentQty * unitPrice}`;
        };

        window.admSelectQty = (q) => {
            admCurrentQty = q;
            document.querySelectorAll('.adm-qty-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`adm-btn-qty-${q}`).classList.add('active');
            window.admUpdateMasterLabels();
            window.admCheckPriceColor();
        };

        window.admSelectType = (t) => {
            admCurrentType = t;
            document.querySelectorAll('.adm-type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`adm-btn-type-${t}`).classList.add('active');
            window.admUpdateMasterLabels();
            window.admCheckPriceColor();
        };

        window.admCheckPriceColor = () => {
            const input = document.getElementById('adm-money-input');
            const val = parseFloat(input.value) || 0;
            const perUnit = val / admCurrentQty;
            
            input.classList.remove('text-gray-400', 'text-red-500', 'text-orange-500', 'text-green-500', 'dark:text-white', 'dark:text-red-500', 'dark:text-orange-500', 'dark:text-green-500');

            if (val === 0) {
                input.classList.add('dark:text-white', 'text-gray-800');
                return;
            }

            if (admCurrentType === 'usual') {
                const usualPrice = masterData.pricePerUnit * masterData.usualRatio;
                if (perUnit < usualPrice) input.classList.add('text-red-500', 'dark:text-red-500');
                else if (perUnit < masterData.pricePerUnit) input.classList.add('text-orange-500', 'dark:text-orange-500');
                else input.classList.add('text-green-500', 'dark:text-green-500');
            } else {
                if (perUnit < masterData.pricePerUnit) input.classList.add('text-red-500', 'dark:text-red-500');
                else input.classList.add('text-green-500', 'dark:text-green-500');
            }
        };

        window.admSetQuickPrice = (pricePerUnit) => {
            const input = document.getElementById('adm-money-input');
            input.value = pricePerUnit * admCurrentQty;
            window.admCheckPriceColor();
        };

        window.adminProcessSale = async () => {
            const source = document.getElementById('adm-sale-source').value;
            const moneyInput = document.getElementById('adm-money-input');
            const money = parseFloat(moneyInput.value);
            if(isNaN(money) || money < 0) return window.showToast("Enter valid money received");

            let actualWeightDeducted = 0;
            const unitPrice = admCurrentType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);

            const updateMaster = {};

            if (source === 'raw') {
                actualWeightDeducted = admCurrentType === 'full' ? admCurrentQty * 1.0 : admCurrentQty * masterData.usualRatio;
                if(masterData.rawWeight < actualWeightDeducted) return window.showToast(`Not enough Master Raw weight! Need ${actualWeightDeducted.toFixed(1)}`);
                updateMaster.rawWeight = increment(-actualWeightDeducted);
            } else if (source === 'processed' && admCurrentType === 'full') {
                if(masterData.unitsFull < admCurrentQty) return window.showToast("Not enough Full Pre-Packs in Master Vault!");
                updateMaster.unitsFull = increment(-admCurrentQty);
                actualWeightDeducted = admCurrentQty * 1.0;
            } else if (source === 'processed' && admCurrentType === 'usual') {
                if(masterData.unitsUsual < admCurrentQty) return window.showToast("Not enough Usual Pre-Packs in Master Vault!");
                updateMaster.unitsUsual = increment(-admCurrentQty);
                actualWeightDeducted = admCurrentQty * masterData.usualRatio;
            }

            // Deduct from Master Vault
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), updateMaster, {merge:true});

            const expectedMoney = admCurrentQty * unitPrice;

            if (source === 'raw') {
                adminData.soldWeight += actualWeightDeducted;
            } else if (source === 'processed' && admCurrentType === 'full') {
                adminData.soldUnitsFull += admCurrentQty;
            } else if (source === 'processed' && admCurrentType === 'usual') {
                adminData.soldUnitsUsual += admCurrentQty;
            }

            adminData.collected += money;
            adminData.expected += expectedMoney;

            adminData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: admCurrentQty,
                type: admCurrentType,
                actualWeight: actualWeightDeducted,
                money: money,
                expected: expectedMoney
            });

            moneyInput.value = '';
            await saveAdminData();
            window.showToast("Admin Sale Complete!");
        };

        window.adminPersonalUseUnified = async () => {
            const source = document.getElementById('adm-sale-source').value;
            const unitPrice = admCurrentType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            
            if(!confirm(`Log Personal Use for ${admCurrentQty} ${admCurrentType.toUpperCase()} units from Master ${source.toUpperCase()} inventory?\n\nYou will be charged standard price at ${masterData.personalUseDiscount}% discount.`)) return;

            let actualWeightDeducted = 0;
            let standardCost = admCurrentQty * unitPrice;
            const updateMaster = {};

            if (source === 'raw') {
                actualWeightDeducted = admCurrentType === 'full' ? admCurrentQty * 1.0 : admCurrentQty * masterData.usualRatio;
                if(masterData.rawWeight < actualWeightDeducted) return window.showToast("Not enough Master Raw weight!");
                updateMaster.rawWeight = increment(-actualWeightDeducted);
            } else if (source === 'processed' && admCurrentType === 'full') {
                if(masterData.unitsFull < admCurrentQty) return window.showToast("Not enough Full Pre-Packs in Master!");
                updateMaster.unitsFull = increment(-admCurrentQty);
                actualWeightDeducted = admCurrentQty * 1.0;
            } else if (source === 'processed' && admCurrentType === 'usual') {
                if(masterData.unitsUsual < admCurrentQty) return window.showToast("Not enough Usual Pre-Packs in Master!");
                updateMaster.unitsUsual = increment(-admCurrentQty);
                actualWeightDeducted = admCurrentQty * masterData.usualRatio;
            }

            // Deduct Master Vault
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), updateMaster, {merge:true});

            const discountMultiplier = 1 - (masterData.personalUseDiscount / 100);
            const discountedDebt = standardCost * discountMultiplier;
            
            adminData.personalUseWeight = (adminData.personalUseWeight || 0) + actualWeightDeducted;
            adminData.expected += discountedDebt;
            adminData.personalUseOwed = (adminData.personalUseOwed || 0) + discountedDebt;
            
            adminData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: admCurrentQty,
                type: 'personal',
                actualWeight: actualWeightDeducted,
                money: 0,
                expected: discountedDebt
            });
            
            await saveAdminData();
            window.showToast(`Admin Personal Use Logged (${admCurrentType.toUpperCase()}).`);
        };

        async function saveAdminData() { 
            if(!currentUser) return; 
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state'), { json: JSON.stringify(adminData), lastUpdated: Date.now() }); 
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid), { 
                    soldWeight: adminData.soldWeight,
                    soldUnitsFull: adminData.soldUnitsFull || 0,
                    soldUnitsUsual: adminData.soldUnitsUsual || 0,
                    personalUseWeight: adminData.personalUseWeight || 0,
                    personalUseOwed: adminData.personalUseOwed || 0,
                    borrowings: adminData.borrowings || 0,
                    collected: adminData.collected,
                    expected: adminData.expected,
                    recentLogs: adminData.transactions.slice(-10).reverse(),
                    lastSync: Date.now() 
                }, { merge: true }); 
            } catch(e){} 
        }

        function renderAdminTerminalUI() {
            document.getElementById('admin-stat-sold-raw').innerText = (adminData.soldWeight || 0).toFixed(1);
            document.getElementById('admin-stat-sold-full').innerText = (adminData.soldUnitsFull || 0);
            document.getElementById('admin-stat-sold-usual').innerText = (adminData.soldUnitsUsual || 0);
            
            document.getElementById('admin-stat-money').innerText = `$${adminData.collected || 0}`;
            document.getElementById('admin-stat-debt').innerText = `$${adminData.personalUseOwed || 0}`;
            
            const diff = (adminData.expected || 0) - (adminData.collected || 0);
            const warn = document.getElementById('admin-shortage-warning');
            if(diff > 0) {
                warn.classList.remove('hidden');
                document.getElementById('admin-shortage-amount').innerText = `$${diff.toFixed(2)}`;
            } else {
                warn.classList.add('hidden');
            }

            // Chart
            const ctx = document.getElementById('adminTerminalChart');
            if(ctx) {
                const sales = adminData.transactions.filter(t => t.type !== 'personal' && t.type !== 'expense' && t.type !== 'borrowing').reverse(); 
                const labels = sales.map(t => t.time);
                const data = sales.map(t => t.money);

                if(adminTerminalChartInst) adminTerminalChartInst.destroy();
                adminTerminalChartInst = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sale ($)',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2, fill: true, tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            // Logs
            const list = document.getElementById('admin-log-list');
            list.innerHTML = '';
            const reversed = [...adminData.transactions].reverse();
            reversed.forEach(t => {
                if(t.type === 'personal') {
                    list.innerHTML += `<div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-2 border border-purple-100 dark:border-purple-800"><div><div class="font-bold text-purple-800 dark:text-purple-300"><i data-lucide="user" class="inline w-3 h-3 mr-1"></i> Personal Debt</div><div class="text-xs text-gray-500">${t.time}  ${masterData.personalUseDiscount}% Discount</div></div><div class="text-right"><div class="font-black text-purple-600 dark:text-purple-400">+$${t.expected} Owed</div></div></div>`;
                } else {
                    const color = t.type === 'full' ? 'text-green-600' : (t.type === 'usual' ? 'text-orange-500' : 'text-blue-500');
                    const label = t.type === 'full' ? 'Full' : (t.type === 'raw' ? 'Raw' : 'Usual');
                    list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-xl mb-2 border border-gray-200 dark:border-gray-600"><div><div class="font-bold dark:text-white">Sold ${t.qty} <span class="text-[10px] ${color} uppercase tracking-wider ml-1">(${label})</span></div><div class="text-xs text-gray-500">${t.time}  Used: ${t.actualWeight.toFixed(1)} u</div></div><div class="text-right"><div class="font-black text-green-600">+$${t.money}</div></div></div>`;
                }
            });
            if(reversed.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>';
            lucide.createIcons();
        }

        // Admin Staff Approval
        window.adminSetStatus = async (uid, status) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid), { status }); window.showToast("Status updated"); };
        window.adminDelUser = async (uid) => { if(confirm("Delete user?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid)); };

        // Admin Transfers
        window.fulfillReq = async (reqId, uid) => { 
            window.switchAdminTab('transfers');
            document.getElementById('transfer-staff-select').value = uid; 
            window.updateTransferPreview(); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId), { status: 'completed' }); 
        };
        window.dismissReq = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id)); };

        window.updateTransferPreview = () => {
            const uid = document.getElementById('transfer-staff-select').value;
            const el = document.getElementById('transfer-preview');
            const u = globalRoster.find(x => x.id === uid);
            if(u) {
                const type = document.getElementById('transfer-item-type').value;
                let h = 0; let label = "";
                if(type === 'raw') { h = u.weight||0; label = 'g'; }
                else if(type === 'full') { h = u.unitsFull||0; label = 'units'; }
                else if(type === 'usual') { h = u.unitsUsual||0; label = 'units'; }
                el.innerText = `Current Staff Holding: ${h.toFixed(1)} ${label}`;
            } else { el.innerText = ''; }
        };

        window.adminTransferWeight = async (action) => {
            const uid = document.getElementById('transfer-staff-select').value;
            const amt = parseFloat(document.getElementById('transfer-amount').value);
            const type = document.getElementById('transfer-item-type').value; // 'raw', 'full', 'usual'

            if(!uid || isNaN(amt) || amt <= 0) return window.showToast("Select staff and valid amount");
            
            const r = doc(db,'artifacts',appId,'users',uid,'data','app_state'); 
            const sn = await getDoc(r); 
            let dat = sn.exists() ? JSON.parse(sn.data().json) : {weight:0, unitsFull:0, unitsUsual:0, soldWeight:0, personalUseWeight:0, personalUseOwed:0, collected:0, expected:0, expenses:0, borrowings: 0, transactions:[]}; 

            // Map keys
            let adminKey = type === 'raw' ? 'rawWeight' : (type === 'full' ? 'unitsFull' : 'unitsUsual');
            let staffKey = type === 'raw' ? 'weight' : (type === 'full' ? 'unitsFull' : 'unitsUsual');

            if (action === 'send') {
                if((masterData[adminKey] || 0) < amt) {
                    if(!confirm(`Warning: Master vault only has ${(masterData[adminKey]||0).toFixed(1)} of this item. Proceed anyway?`)) return;
                }
                // Deduct Master, Add to Staff
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[adminKey]:increment(-amt)},{merge:true}); 
                dat[staffKey] = (dat[staffKey]||0) + amt;
                window.showToast(`Sent ${amt} to staff.`);
            } else if (action === 'reclaim') {
                if((dat[staffKey] || 0) < amt) return window.showToast("Staff does not have that much inventory to reclaim!");
                // Add to Master, Deduct from Staff
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[adminKey]:increment(amt)},{merge:true}); 
                dat[staffKey] = (dat[staffKey]||0) - amt;
                window.showToast(`Reclaimed ${amt} from staff.`);
            }
            
            // Save private
            await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
            // Save public
            await setDoc(doc(db,'artifacts',appId,'public','data','roster',uid), {
                weight: dat.weight, unitsFull: dat.unitsFull, unitsUsual: dat.unitsUsual
            }, {merge:true}); 
            
            document.getElementById('transfer-amount').value = '';
            window.updateTransferPreview();
        };

        // Admin Log Cash Advance / Debt
        window.adminAddBorrowing = async () => {
            if(!currentDetailUid) return;
            const desc = prompt("What is this Debt / Cash Advance for?");
            if(!desc) return;
            const amt = parseFloat(prompt(`How much debt to add to this staff member? ($)`));
            if(isNaN(amt) || amt <= 0) return;

            const r = doc(db,'artifacts',appId,'users',currentDetailUid,'data','app_state'); 
            const sn = await getDoc(r); 
            if(sn.exists()) {
                let dat = JSON.parse(sn.data().json);
                dat.borrowings = (dat.borrowings || 0) + amt;
                dat.expected = (dat.expected || 0) + amt;
                
                dat.transactions.push({
                    id: Date.now(),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    qty: 0, type: 'borrowing', actualWeight: 0, money: 0, expected: amt, desc: desc
                });

                await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
                await setDoc(doc(db,'artifacts',appId,'public','data','roster',currentDetailUid), {
                    borrowings: dat.borrowings,
                    expected: dat.expected,
                    recentLogs: dat.transactions.slice(-10).reverse()
                }, {merge:true}); 
                
                window.showToast("Debt added to staff member.");
                window.viewDriverDetails(currentDetailUid); // Refresh view
            }
        };

        // Admin Detail View
        window.viewDriverDetails = (uid) => { 
            const d = globalRoster.find(x => x.id === uid); 
            if(!d) return; 
            currentDetailUid = uid; 
            document.getElementById('admin-user-detail').classList.remove('hidden'); 
            document.getElementById('detail-user-name').innerText = d.name; 
            
            // Holdings
            document.getElementById('det-holding-raw').innerText = (d.weight||0).toFixed(1);
            document.getElementById('det-holding-full').innerText = (d.unitsFull||0);
            document.getElementById('det-holding-usual').innerText = (d.unitsUsual||0);
            
            // Sold Totals
            document.getElementById('det-sold-raw').innerText = (d.soldWeight||0).toFixed(1);
            document.getElementById('det-sold-full').innerText = (d.soldUnitsFull||0);
            document.getElementById('det-sold-usual').innerText = (d.soldUnitsUsual||0);
            
            document.getElementById('det-expected').innerText = `$${(d.expected||0).toFixed(2)}`;
            document.getElementById('det-personal-owed').innerText = `$${(d.personalUseOwed||0).toFixed(2)}`;
            document.getElementById('det-borrowings').innerText = `$${(d.borrowings||0).toFixed(2)}`;
            
            document.getElementById('det-collected').innerText = `$${(d.collected||0).toFixed(2)}`;
            document.getElementById('det-expenses').innerText = `-$${(d.expenses||0).toFixed(2)}`;
            
            // Commission & Debt Calculation
            const grossComm = (d.collected || 0) * ((masterData.staffCommission || 0) / 100);
            const totalDebt = (d.personalUseOwed || 0) + (d.borrowings || 0);
            
            const appliedToDebt = Math.min(grossComm, totalDebt);
            const netComm = grossComm - appliedToDebt;
            const remainingDebt = totalDebt - appliedToDebt;

            document.getElementById('det-calc-gross-comm').innerText = `$${grossComm.toFixed(2)}`;
            document.getElementById('det-calc-total-debt').innerText = `$${totalDebt.toFixed(2)}`;
            document.getElementById('det-calc-applied').innerText = `-$${appliedToDebt.toFixed(2)}`;
            document.getElementById('det-calc-net-comm').innerText = `$${netComm.toFixed(2)}`;
            document.getElementById('det-calc-rem-debt').innerText = `$${remainingDebt.toFixed(2)}`;

            const netCash = (d.collected||0) - (d.expenses||0) - netComm;
            document.getElementById('det-net-cash').innerText = `$${netCash.toFixed(2)}`;

            const diff = (d.expected||0) - (d.collected||0);
            const box = document.getElementById('det-diff-box');
            const diffEl = document.getElementById('det-diff');
            
            if(diff > 0) {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 mb-4";
                diffEl.innerText = `-$${diff.toFixed(2)} (Short)`;
            } else if (diff < 0) {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 mb-4";
                diffEl.innerText = `+$${Math.abs(diff).toFixed(2)} (Over)`;
            } else {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 mb-4";
                diffEl.innerText = `$0 (Perfect)`;
            }
            
            // Update Detail Chart
            const ctx = document.getElementById('adminDetailChart');
            if(ctx && d.recentLogs) {
                const sales = d.recentLogs.filter(t => t.type !== 'personal' && t.type !== 'expense' && t.type !== 'borrowing').reverse();
                const labels = sales.map(t => t.time);
                const data = sales.map(t => t.money);

                if(adminDetailChartInst) adminDetailChartInst.destroy();
                adminDetailChartInst = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sale ($)',
                            data: data,
                            backgroundColor: '#8b5cf6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        };

        window.adminClearStaffData = async () => {
            if(!currentDetailUid) return;
            if(!confirm("Are you sure? This sets their expected, collected, and sold items to 0. (Does not affect Holding Inventory)")) return;

            const r = doc(db,'artifacts',appId,'users',currentDetailUid,'data','app_state'); 
            const sn = await getDoc(r); 
            if(sn.exists()) {
                let dat = JSON.parse(sn.data().json);
                dat.soldWeight = 0; dat.soldUnitsFull = 0; dat.soldUnitsUsual = 0; dat.collected = 0; dat.expected = 0; dat.personalUseOwed = 0; dat.borrowings = 0; dat.expenses = 0; dat.transactions = [];
                await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
                await setDoc(doc(db,'artifacts',appId,'public','data','roster',currentDetailUid), {soldWeight:0, soldUnitsFull:0, soldUnitsUsual:0, collected:0, expected:0, personalUseOwed:0, borrowings: 0, expenses:0, recentLogs:[]}, {merge:true}); 
                window.showToast("Data Cleared.");
                document.getElementById('admin-user-detail').classList.add('hidden');
            }
        };

        // ADMIN FACTORY RESET
        window.adminFactoryReset = async () => {
            if(!confirm("WARNING: This will reset all Master Vault inventory AND all Staff balances/sales history to 0.\n\nUser accounts and roles will remain intact.\n\nProceed?")) return;
            if(!confirm("Are you ABSOLUTELY sure? This cannot be undone.")) return;

            window.showToast("Resetting data...");

            // 1. Reset Master
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { rawWeight: 0, unitsFull: 0, unitsUsual: 0, pricePerUnit: masterData.pricePerUnit, usualRatio: masterData.usualRatio, personalUseDiscount: masterData.personalUseDiscount, staffCommission: masterData.staffCommission, totalExpenses: 0, cashBalance: 0, liabilities: [] });

            // 2. Reset All Staff & Admin self
            for(const u of globalRoster) {
                const r = doc(db,'artifacts',appId,'users',u.id,'data','app_state');
                const emptyData = { weight:0, unitsFull:0, unitsUsual:0, soldWeight:0, soldUnitsFull:0, soldUnitsUsual:0, personalUseWeight:0, personalUseOwed:0, borrowings:0, collected:0, expected:0, expenses:0, transactions:[] };
                await setDoc(r, { json: JSON.stringify(emptyData), lastUpdated: Date.now() });

                await setDoc(doc(db,'artifacts',appId,'public','data','roster',u.id), {
                    weight: 0, unitsFull:0, unitsUsual:0, soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, borrowings: 0, collected: 0, expected: 0, expenses: 0, recentLogs: []
                }, {merge: true});
            }

            // 3. Clear pending requests
            const reqsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'requests'));
            reqsSnap.forEach(async (d) => { await deleteDoc(d.ref); });

            window.showToast("Factory Reset Complete.");
        };

    </script>
</body>
</html>