<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WeightOps | Revenue & Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .hidden { display: none !important; }
        
        /* Custom Selectable Buttons */
        .btn-select { transition: all 0.2s; border: 2px solid transparent; }
        .btn-select.active { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .btn-interactive:active { transform: scale(0.95); }
    </style>
    <script>
        if (localStorage.theme === 'light') { document.documentElement.classList.remove('dark'); } 
        else { document.documentElement.classList.add('dark'); }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200 min-h-screen pb-6">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal-overlay z-[150]">
        <div class="text-white flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p class="font-bold tracking-wide">Loading Database...</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-white shadow-lg">
                <i data-lucide="scale" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">WeightOps</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-8">Secure Access Portal</p>
            
            <button onclick="window.handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-4 rounded-xl shadow-sm flex justify-center items-center hover:bg-gray-50 dark:hover:bg-gray-600 transition btn-interactive">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Approval Pending Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 id="approval-title" class="text-2xl font-bold dark:text-white">Access Pending</h2>
            <p id="approval-msg" class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">Sign in Pending, please contact an administrator for help.</p>
            <div class="flex flex-col gap-2">
                <button onclick="window.location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Refresh Status</button>
                <button onclick="window.logout()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-xl text-gray-700 dark:text-gray-300">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Options</h2>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="window.toggleTheme()" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                    <span class="font-medium dark:text-white">Toggle Dark Mode</span>
                    <i data-lucide="moon" class="w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                </button>
                <button onclick="window.logout()" class="w-full flex justify-center items-center p-4 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- STAFF UI -->
    <div id="staff-app" class="hidden">
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold">Staff Terminal</h1>
                <div class="text-xs text-blue-200" id="staff-name-display">Guest</div>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-4">
            
            <!-- Stock Card -->
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl shadow-lg p-5 text-white relative overflow-hidden">
                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <h2 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-1">My Current Weight</h2>
                        <div class="flex items-baseline">
                            <span class="text-5xl font-black mr-2" id="staff-stock">0.0</span>
                            <span class="text-gray-400 text-sm font-bold">g</span>
                        </div>
                    </div>
                    <button onclick="window.requestWeight()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 px-4 rounded-xl shadow-md transition active:scale-95 flex items-center">
                        <i data-lucide="bell" class="w-4 h-4 mr-1"></i> Request
                    </button>
                </div>
            </div>

            <!-- Terminal Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                <h2 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center justify-between">
                    <div class="flex items-center"><i data-lucide="calculator" class="w-5 h-5 mr-2 text-blue-500"></i> Record Sale</div>
                </h2>
                
                <!-- Qty Selection -->
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">1. Select Quantity</label>
                    <div class="flex space-x-2">
                        <button onclick="window.selectQty(0.5)" id="btn-qty-0.5" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white">.5</button>
                        <button onclick="window.selectQty(1)" id="btn-qty-1" class="qty-btn btn-select active flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white">1</button>
                        <button onclick="window.selectQty(2)" id="btn-qty-2" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white">2</button>
                        <button onclick="window.selectQty(3)" id="btn-qty-3" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white">3</button>
                        <button onclick="window.selectQty(4)" id="btn-qty-4" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white">4</button>
                    </div>
                </div>

                <!-- Type Selection -->
                <div class="mb-5">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">2. Select Weight Standard</label>
                    <div class="flex space-x-2">
                        <button onclick="window.selectType('full')" id="btn-type-full" class="type-btn btn-select active flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center">
                            <span class="dark:text-white">Full Weight</span>
                            <span class="text-[10px] text-gray-400 mt-1 font-normal" id="label-full-weight">(1.0g per unit)</span>
                        </button>
                        <button onclick="window.selectType('usual')" id="btn-type-usual" class="type-btn btn-select flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center">
                            <span class="dark:text-white">Usual Weight</span>
                            <span class="text-[10px] text-gray-400 mt-1 font-normal" id="label-usual-weight">(0.8g per unit)</span>
                        </button>
                    </div>
                </div>

                <!-- Money Collection -->
                <div class="mb-4 bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100 dark:border-green-900/30">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-green-700 dark:text-green-400 uppercase tracking-widest">3. Money Received</label>
                        <span class="text-xs font-bold text-gray-500" id="expected-money-hint">Expected: $100</span>
                    </div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-green-600 dark:text-green-500">$</span>
                        <input type="number" id="money-input" placeholder="0.00" class="w-full bg-white dark:bg-gray-800 border-2 border-green-200 dark:border-green-700 rounded-xl py-3 pl-10 pr-4 text-2xl font-black outline-none focus:border-green-500 dark:text-white transition">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="window.processSale()" class="flex-1 bg-blue-600 text-white font-black text-sm py-4 rounded-xl shadow-md hover:bg-blue-700 btn-interactive transition uppercase tracking-wide">
                        Log Sale
                    </button>
                    <button onclick="window.staffPersonalUse()" class="bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 font-bold text-xs py-4 px-4 rounded-xl shadow-sm hover:bg-purple-200 btn-interactive transition flex flex-col items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 mb-1"></i> Use
                    </button>
                </div>
            </div>

            <!-- Stats/Logs -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2">Shift Performance</h3>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-[10px] text-gray-500 uppercase font-bold">Collected</div>
                        <div class="text-xl font-bold text-green-600" id="staff-stat-money">$0</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-[10px] text-gray-500 uppercase font-bold">Expected</div>
                        <div class="text-xl font-bold text-gray-800 dark:text-gray-200" id="staff-stat-expected">$0</div>
                    </div>
                </div>
                
                <!-- Shortage Warning -->
                <div id="staff-shortage-warning" class="hidden mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-2 rounded-lg text-xs font-bold text-center border border-red-200 dark:border-red-800">
                    Warning: You are short by <span id="staff-shortage-amount">$0</span>
                </div>

                <div id="staff-log-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar text-sm">
                    <div class="text-center text-gray-400 py-4 text-xs">No sales recorded yet.</div>
                </div>
            </div>

        </main>
    </div>

    <!-- ADMIN UI -->
    <div id="admin-app" class="hidden">
        <header class="bg-gray-900 text-white p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">BOSS DASHBOARD</h1>
                <p class="text-xs text-gray-400">Inventory & Revenue Command</p>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-2xl mx-auto">
            
            <!-- Admin Navigation -->
            <div class="flex space-x-2 mb-6">
                <button onclick="window.switchAdminTab('storage')" id="adm-tab-storage" class="flex-1 py-2 rounded-xl font-bold text-sm bg-gray-800 text-white shadow transition flex justify-center items-center"><i data-lucide="database" class="w-4 h-4 mr-1"></i> Vault</button>
                <button onclick="window.switchAdminTab('terminal')" id="adm-tab-terminal" class="flex-1 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex justify-center items-center"><i data-lucide="calculator" class="w-4 h-4 mr-1"></i> Sell</button>
                <button onclick="window.switchAdminTab('staff')" id="adm-tab-staff" class="flex-1 py-2 rounded-xl font-bold text-sm bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex justify-center items-center relative">
                    <i data-lucide="users" class="w-4 h-4 mr-1"></i> Team
                    <div id="admin-req-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                </button>
            </div>

            <!-- TAB: MASTER STORAGE -->
            <div id="admin-view-storage" class="admin-tab-content active">
                
                <!-- Raw Weight Vault -->
                <div class="bg-gradient-to-br from-gray-800 to-black rounded-3xl p-6 shadow-xl mb-4 text-white relative overflow-hidden">
                    <div class="relative z-10 flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-gray-400 text-xs uppercase tracking-widest font-bold mb-1">Master Raw Weight</h2>
                            <div class="flex items-baseline">
                                <span class="text-5xl font-black mr-2" id="admin-master-weight">0.0</span>
                                <span class="text-gray-400 font-bold">g</span>
                            </div>
                        </div>
                        <button onclick="window.adminAddWeight()" class="bg-white/10 hover:bg-white/20 p-3 rounded-full transition border border-white/20 backdrop-blur-sm btn-interactive">
                            <i data-lucide="plus" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>

                    <!-- Processing Tool -->
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 backdrop-blur-sm">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-blue-300 flex items-center"><i data-lucide="layers" class="w-4 h-4 mr-2"></i> Process into Units</h3>
                        </div>
                        <div class="flex space-x-2">
                            <input type="number" id="process-qty" placeholder="# Units" class="w-1/2 p-2 bg-black/50 border border-gray-600 rounded-lg text-sm text-white font-bold outline-none">
                            <input type="number" step="0.1" id="process-weight" placeholder="g per unit" class="w-1/2 p-2 bg-black/50 border border-gray-600 rounded-lg text-sm text-white font-bold outline-none">
                            <button onclick="window.adminProcessUnits()" class="bg-blue-600 px-4 rounded-lg font-bold text-sm hover:bg-blue-500 btn-interactive">Make</button>
                        </div>
                    </div>
                </div>

                <!-- Processed Units Vault -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-2xl p-5 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-blue-800 dark:text-blue-300 text-xs uppercase font-bold tracking-widest mb-1">Ready Units</h2>
                        <div class="text-3xl font-black text-blue-900 dark:text-white" id="admin-processed-units">0</div>
                    </div>
                    <i data-lucide="package" class="w-10 h-10 text-blue-300 dark:text-blue-700 opacity-50"></i>
                </div>

                <!-- Configuration & Potential -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <div class="grid grid-cols-2 gap-4 border-b dark:border-gray-700 pb-4 mb-4">
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Price per 1.0 Unit</div>
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-green-600 dark:text-green-400 mr-2" id="admin-price-display">$0</span>
                                <button onclick="window.adminSetVariable('pricePerUnit', 'Price per 1.0 Unit ($)')" class="text-gray-400 hover:text-blue-500"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">"Usual" Ratio</div>
                            <div class="flex items-center">
                                <span class="text-lg font-bold text-orange-500 mr-2" id="admin-ratio-display">0.8x</span>
                                <button onclick="window.adminSetVariable('usualRatio', 'Usual Ratio (e.g. 0.8 for 80%)')" class="text-gray-400 hover:text-blue-500"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </div>

                    <h3 class="font-bold text-gray-800 dark:text-white mb-3">Potential Raw Vault Value</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div><div class="font-bold text-sm dark:text-gray-200">Sold at Full Weight</div></div>
                            <div class="text-lg font-black text-green-600" id="admin-pot-full">$0</div>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div><div class="font-bold text-sm dark:text-gray-200">Sold at Usual Weight</div></div>
                            <div class="text-lg font-black text-orange-500" id="admin-pot-usual">$0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ADMIN TERMINAL -->
            <div id="admin-view-terminal" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 space-y-6">
                    
                    <!-- Sell Raw Weight -->
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white mb-3 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide">
                            <i data-lucide="scale" class="w-4 h-4 inline mr-1 text-blue-500"></i> Sell Raw Weight
                        </h3>
                        <div class="flex space-x-2">
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">Weight (g)</label><input type="number" step="0.1" id="adm-sell-raw-w" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white"></div>
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">Money ($)</label><input type="number" id="adm-sell-raw-m" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white"></div>
                        </div>
                        <button onclick="window.adminSellRaw()" class="w-full mt-3 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 btn-interactive transition">Record Sale</button>
                    </div>

                    <!-- Sell Processed Units -->
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white mb-3 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide">
                            <i data-lucide="package" class="w-4 h-4 inline mr-1 text-purple-500"></i> Sell Processed Units
                        </h3>
                        <div class="flex space-x-2">
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">Quantity</label><input type="number" id="adm-sell-unit-q" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white"></div>
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">Money ($)</label><input type="number" id="adm-sell-unit-m" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white"></div>
                        </div>
                        <button onclick="window.adminSellUnit()" class="w-full mt-3 bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700 btn-interactive transition">Record Sale</button>
                    </div>

                    <!-- Admin Personal Use -->
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white mb-3 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide text-red-500">
                            <i data-lucide="user" class="w-4 h-4 inline mr-1"></i> Admin Personal Use
                        </h3>
                        <div class="flex space-x-2">
                            <input type="number" step="0.1" id="adm-use-w" placeholder="Weight (g)" class="w-1/2 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white">
                            <button onclick="window.adminPersonalUse('weight')" class="w-1/4 bg-gray-800 text-white text-xs font-bold rounded-xl btn-interactive">Use Wgt</button>
                            
                            <input type="number" id="adm-use-u" placeholder="# Units" class="w-1/4 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-center">
                            <button onclick="window.adminPersonalUse('unit')" class="w-1/4 bg-gray-800 text-white text-xs font-bold rounded-xl btn-interactive">Use Unit</button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2">Deducts from Master Storage without adding to expected revenue.</p>
                    </div>

                </div>
            </div>

            <!-- TAB: STAFF / TRANSFERS -->
            <div id="admin-view-staff" class="admin-tab-content hidden">
                
                <!-- Stock Requests Alert -->
                <div id="admin-requests-section" class="hidden mb-6 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-200 dark:border-blue-800 shadow-sm">
                    <h3 class="font-bold text-blue-800 dark:text-blue-300 text-xs uppercase mb-3 flex items-center tracking-wide">
                        <i data-lucide="bell" class="w-4 h-4 mr-2 animate-bounce"></i> Staff Requests
                    </h3>
                    <div id="admin-requests-list" class="space-y-2"></div>
                </div>

                <!-- Transfer To Staff -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center text-sm uppercase tracking-wide border-b dark:border-gray-700 pb-2">
                        <i data-lucide="truck" class="w-4 h-4 mr-2 text-blue-500"></i> Distribute Weight
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Select Staff</label>
                            <select id="transfer-staff-select" onchange="window.updateTransferPreview()" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none text-sm font-bold dark:text-white">
                                <option value="">Select...</option>
                            </select>
                            <div id="transfer-preview" class="text-xs text-blue-600 dark:text-blue-400 mt-1 ml-1 h-4 font-medium"></div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Raw Weight to Send (g)</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="number" step="0.1" id="transfer-amount" placeholder="0.0" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none font-black text-lg dark:text-white">
                                <button onclick="window.adminTransferWeight()" class="bg-blue-600 text-white font-bold px-6 rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Performance List -->
                <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3 ml-1 text-sm uppercase flex justify-between">
                    <span>Staff Analytics</span>
                    <span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded" id="admin-active-count">0 Active</span>
                </h3>
                <div id="admin-staff-list" class="space-y-3 mb-8">
                    <div class="text-center py-8 text-gray-400 animate-pulse text-sm">Loading staff data...</div>
                </div>

                <!-- Employee Approvals -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-3 text-sm uppercase">Access Management</h3>
                    <div id="admin-pending-users" class="space-y-2 text-sm">
                        <div class="text-gray-400 italic text-xs">No pending users.</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- User Detail Modal (Admin) -->
    <div id="admin-user-detail" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 overflow-y-auto hidden">
        <div class="bg-white dark:bg-gray-800 p-4 sticky top-0 shadow-md flex justify-between items-center z-10">
            <button onclick="document.getElementById('admin-user-detail').classList.add('hidden')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h2 class="font-bold text-lg dark:text-white" id="detail-user-name">Staff Details</h2>
            <div class="w-9"></div>
        </div>
        <div class="p-4 max-w-2xl mx-auto space-y-4">
            
            <div class="grid grid-cols-2 gap-3 mb-2">
                <div class="bg-gray-800 text-white p-4 rounded-2xl shadow-sm">
                    <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-1">Holding Weight</div>
                    <div class="text-3xl font-black" id="det-holding">0.0</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-1">Weight Sold</div>
                    <div class="text-3xl font-black dark:text-white" id="det-sold">0.0</div>
                </div>
            </div>

            <!-- Revenue Analysis -->
            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-4 border-b dark:border-gray-700 pb-2">Revenue Tracking</h3>
                
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm font-bold dark:text-gray-300">Expected Value</span>
                    <span class="text-lg font-bold dark:text-white" id="det-expected">$0</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm font-bold dark:text-gray-300">Actual Collected</span>
                    <span class="text-lg font-bold text-green-600" id="det-collected">$0</span>
                </div>
                
                <div id="det-diff-box" class="p-3 rounded-lg flex justify-between items-center font-bold">
                    <span class="text-sm uppercase tracking-wide">Money Lost</span>
                    <span class="text-xl" id="det-diff">$0</span>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold text-purple-600 dark:text-purple-400"><i data-lucide="user" class="inline w-4 h-4 mr-1"></i> Personal Use Logged:</span>
                    <span class="text-lg font-black dark:text-white" id="det-personal">0.0g</span>
                </div>
            </div>

            <!-- Danger / Clear -->
            <button onclick="window.adminClearStaffData()" class="w-full mt-4 bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400 font-bold py-4 rounded-xl border border-red-200 dark:border-red-800/50 hover:bg-red-200 dark:hover:bg-red-900/40 transition btn-interactive">
                Collect Cash & Reset Stats to 0
            </button>
            <p class="text-center text-[10px] text-gray-500">This resets Expected/Collected to $0. It does NOT remove their holding weight.</p>

        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, updateDoc, increment, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // ---------------------------------------------------------
        // FIREBASE CONFIGURATION
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDz4iG5KZy3JAxBhubaGEaMKTY7jcObRDE",
            authDomain: "deals-bcfea.firebaseapp.com",
            projectId: "deals-bcfea",
            storageBucket: "deals-bcfea.firebasestorage.app",
            messagingSenderId: "686014043249",
            appId: "1:686014043249:web:8dcc93549cdb265269b7d0"
        };
        const appId = "weight-tracker-v2"; // Using fresh ID for clean start
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app); 
        const googleProvider = new GoogleAuthProvider();

        // ---------------------------------------------------------
        // GLOBAL STATE
        // ---------------------------------------------------------
        let currentUser = null; 
        let userRole = 'staff'; 
        
        // Staff State
        let appData = { weight: 0, soldWeight: 0, personalUseWeight: 0, collected: 0, expected: 0, transactions: [] };
        let currentQty = 1;
        let currentType = 'full';

        // Admin State
        let masterData = { rawWeight: 0, processedUnits: 0, pricePerUnit: 100, usualRatio: 0.8 };
        let globalRoster = []; 
        let currentDetailUid = null;

        // Listeners
        let unsubUserData, unsubRoster, unsubMaster, unsubReqs, unsubAuthCheck;

        // ---------------------------------------------------------
        // UTILS
        // ---------------------------------------------------------
        window.showToast = (msg) => { 
            const t = document.getElementById('toast'); 
            t.innerText = msg; 
            t.className = "show"; 
            setTimeout(() => t.className = "", 3000); 
        };
        
        window.toggleTheme = () => { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        };

        // ---------------------------------------------------------
        // AUTH LOGIC
        // ---------------------------------------------------------
        window.handleGoogleLogin = async () => { 
            try { 
                const res = await signInWithPopup(auth, googleProvider);
                const profRef = doc(db, 'artifacts', appId, 'users', res.user.uid, 'settings', 'profile');
                const snap = await getDoc(profRef);
                
                // If New User -> Auto assign pending staff
                if(!snap.exists()) {
                    await setDoc(profRef, { name: res.user.displayName, email: res.user.email, role: 'staff', status: 'pending', createdAt: Date.now() });
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', res.user.uid), { name: res.user.displayName, role: 'staff', status: 'pending', uid: res.user.uid }, {merge:true});
                }
            } catch (e) { 
                console.error("Auth Error:", e);
                window.showToast("Login Failed: " + e.message); 
            }
        };

        window.logout = async () => { 
            if(unsubUserData) unsubUserData(); if(unsubRoster) unsubRoster(); if(unsubMaster) unsubMaster(); if(unsubAuthCheck) unsubAuthCheck();
            await signOut(auth); window.location.reload(); 
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', user.uid);
                
                unsubAuthCheck = onSnapshot(rosterRef, (snap) => {
                    const data = snap.data() || {};
                    const role = data.role || 'staff';
                    const status = data.status || 'pending';
                    userRole = role;
                    
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('login-modal').classList.add('hidden');

                    if (role === 'admin') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        initAdminDashboard();
                    } else if (status === 'active') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        initStaffApp(user);
                    } else {
                        // Pending or Suspended
                        document.getElementById('approval-modal').classList.remove('hidden');
                        document.getElementById('staff-app').classList.add('hidden');
                        document.getElementById('admin-app').classList.add('hidden');
                        
                        const title = document.getElementById('approval-title');
                        const msg = document.getElementById('approval-msg');
                        if(status === 'suspended') {
                            title.innerText = "Account Suspended";
                            msg.innerText = "Your access has been restricted by management.";
                        } else {
                            title.innerText = "Access Pending";
                            msg.innerText = "Waiting for Admin to approve your account.";
                        }
                    }
                }, (error) => {
                    console.error("Roster Access Denied:", error);
                    document.getElementById('loading-overlay').classList.add('hidden');
                    window.showToast("Permission denied. Check Firebase Rules.");
                });

                // Master data listener (Pricing configs needed for both Admin and Staff)
                unsubMaster = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), (s) => {
                    if(s.exists()) {
                        masterData = { rawWeight: 0, processedUnits: 0, pricePerUnit: 100, usualRatio: 0.8, ...s.data() };
                        updateMasterLabels();
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), masterData).catch(e => console.log(e));
                    }
                });

            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });

        function updateMasterLabels() {
            // Staff Pricing Labels
            const labelFull = document.getElementById('label-full-weight');
            const labelUsual = document.getElementById('label-usual-weight');
            const expHint = document.getElementById('expected-money-hint');
            
            if(labelFull) labelFull.innerText = `(${(currentQty * 1.0).toFixed(1)}g per unit)`;
            if(labelUsual) labelUsual.innerText = `(${(currentQty * masterData.usualRatio).toFixed(1)}g per unit)`;
            if(expHint) expHint.innerText = `Expected: $${currentQty * masterData.pricePerUnit}`;

            // Admin Display Updates
            const wRaw = document.getElementById('admin-master-weight');
            const wUnit = document.getElementById('admin-processed-units');
            const pDisp = document.getElementById('admin-price-display');
            const rDisp = document.getElementById('admin-ratio-display');
            const pFull = document.getElementById('admin-pot-full');
            const pUsual = document.getElementById('admin-pot-usual');
            const hRat = document.getElementById('hint-ratio-txt');

            if(wRaw) wRaw.innerText = masterData.rawWeight.toFixed(1);
            if(wUnit) wUnit.innerText = masterData.processedUnits;
            if(pDisp) pDisp.innerText = `$${masterData.pricePerUnit}`;
            if(rDisp) rDisp.innerText = `${masterData.usualRatio}x`;
            
            // Calculate potential value of raw vault
            if(pFull) pFull.innerText = `$${(masterData.rawWeight * masterData.pricePerUnit).toLocaleString()}`;
            if(pUsual) {
                const usualSales = Math.floor(masterData.rawWeight / masterData.usualRatio);
                pUsual.innerText = `$${(usualSales * masterData.pricePerUnit).toLocaleString()}`;
            }
            if(hRat) hRat.innerText = masterData.usualRatio;
        }

        // ---------------------------------------------------------
        // STAFF TERMINAL LOGIC
        // ---------------------------------------------------------
        function initStaffApp(user) {
            document.getElementById('staff-app').classList.remove('hidden');
            document.getElementById('staff-name-display').innerText = user.displayName || user.email;

            unsubUserData = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state'), (snap) => { 
                if(snap.exists()) { 
                    const d = JSON.parse(snap.data().json);
                    appData = { weight: 0, soldWeight: 0, personalUseWeight: 0, collected: 0, expected: 0, transactions: [], ...d };
                    renderStaffUI(); 
                } else { saveStaffData(); } 
            });
        }

        function renderStaffUI() {
            document.getElementById('staff-stock').innerText = appData.weight.toFixed(1);
            document.getElementById('staff-stat-weight').innerText = appData.soldWeight.toFixed(1);
            document.getElementById('staff-stat-money').innerText = `$${appData.collected}`;
            
            const list = document.getElementById('staff-log-list');
            list.innerHTML = '';
            
            const reversed = [...appData.transactions].reverse();
            reversed.forEach(t => {
                if(t.type === 'personal') {
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-2 border border-purple-100 dark:border-purple-800">
                        <div>
                            <div class="font-bold text-purple-800 dark:text-purple-300"><i data-lucide="user" class="inline w-3 h-3 mr-1"></i> Personal Use</div>
                            <div class="text-xs text-gray-500">${t.time} • Removed: ${t.actualWeight.toFixed(1)}g</div>
                        </div>
                        <div class="text-right"><div class="font-black text-gray-400">-$0</div></div>
                    </div>`;
                } else {
                    const color = t.type === 'full' ? 'text-green-600' : 'text-orange-500';
                    const label = t.type === 'full' ? 'Full' : 'Usual';
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-xl mb-2">
                        <div>
                            <div class="font-bold dark:text-white">Sold ${t.qty} <span class="text-[10px] ${color} uppercase tracking-wider ml-1">(${label})</span></div>
                            <div class="text-xs text-gray-500">${t.time} • Used: ${t.actualWeight.toFixed(1)}g</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-green-600">+$${t.money}</div>
                        </div>
                    </div>`;
                }
            });
            if(reversed.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>';
            lucide.createIcons();
        }

        async function saveStaffData() { 
            if(!currentUser) return; 
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state'), { json: JSON.stringify(appData), lastUpdated: Date.now() }); 
            
            // Sync summary to public roster
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid), { 
                    weight: appData.weight,
                    soldWeight: appData.soldWeight,
                    personalUseWeight: appData.personalUseWeight || 0,
                    collected: appData.collected,
                    expected: appData.expected,
                    recentLogs: appData.transactions.slice(-10).reverse(), // Admin sees last 10
                    lastSync: Date.now() 
                }, { merge: true }); 
            } catch(e){} 
        }

        window.selectQty = (q) => {
            currentQty = q;
            document.querySelectorAll('.qty-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-qty-${q}`).classList.add('active');
            updateMasterLabels();
        };

        window.selectType = (t) => {
            currentType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-type-${t}`).classList.add('active');
            updateMasterLabels();
        };

        window.processSale = async () => {
            const moneyInput = document.getElementById('money-input');
            const money = parseFloat(moneyInput.value);
            if(isNaN(money) || money < 0) return window.showToast("Enter valid money received");

            const actualWeight = currentType === 'full' ? currentQty * 1.0 : currentQty * masterData.usualRatio;
            if(appData.weight < actualWeight) return window.showToast(`Not enough weight! Need ${actualWeight.toFixed(1)}g`);

            const expectedMoney = currentQty * masterData.pricePerUnit;

            appData.weight -= actualWeight;
            appData.soldWeight += actualWeight;
            appData.collected += money;
            appData.expected += expectedMoney;

            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: currentQty,
                type: currentType,
                actualWeight: actualWeight,
                money: money,
                expected: expectedMoney
            });

            moneyInput.value = '';
            await saveStaffData();
            window.showToast("Sale Complete!");
        };

        window.staffPersonalUse = async () => {
            const w = parseFloat(prompt("Enter weight used for personal (g):"));
            if(isNaN(w) || w <= 0) return;
            if(appData.weight < w) return window.showToast("Not enough weight!");
            
            appData.weight -= w;
            appData.personalUseWeight = (appData.personalUseWeight || 0) + w;
            
            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: 0,
                type: 'personal',
                actualWeight: w,
                money: 0,
                expected: 0
            });
            
            await saveStaffData();
            window.showToast("Personal Use Logged.");
        };

        window.requestWeight = async () => { 
            if(confirm("Notify admin you need more weight?")) { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), { 
                    uid: currentUser.uid, name: currentUser.displayName || 'Staff', timestamp: Date.now(), status: 'pending' 
                }); 
                window.showToast("Request Sent"); 
            } 
        };

        // ---------------------------------------------------------
        // ADMIN LOGIC
        // ---------------------------------------------------------
        window.switchAdminTab = (t) => { 
            ['storage','terminal','staff','transfers'].forEach(x => { 
                document.getElementById(`admin-view-${x}`).classList.add('hidden'); 
                document.getElementById(`adm-tab-${x}`).classList.remove('bg-gray-800','text-white','shadow'); 
                document.getElementById(`adm-tab-${x}`).classList.add('bg-white','dark:bg-gray-800','text-gray-600','dark:text-gray-300');
            }); 
            document.getElementById(`admin-view-${t}`).classList.remove('hidden'); 
            document.getElementById(`adm-tab-${t}`).classList.add('bg-gray-800','text-white','shadow'); 
            document.getElementById(`adm-tab-${t}`).classList.remove('bg-white','dark:bg-gray-800','text-gray-600','dark:text-gray-300');
        };

        function initAdminDashboard() {
            document.getElementById('admin-app').classList.remove('hidden');

            // Listen to Roster for Staff Stats
            unsubRoster = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), (snap) => {
                const list = document.getElementById('admin-staff-list'); 
                const select = document.getElementById('transfer-staff-select');
                const pendingList = document.getElementById('admin-pending-users');
                
                list.innerHTML=''; select.innerHTML='<option value="">Select Staff...</option>'; pendingList.innerHTML='';
                globalRoster=[]; 
                
                let activeCount = 0, pendCount = 0;

                snap.forEach(d => {
                    const u = { id: d.id, ...d.data() }; 
                    globalRoster.push(u);
                    
                    if(u.role !== 'admin') {
                        if(u.status === 'pending') {
                            pendCount++;
                            pendingList.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-orange-50 dark:bg-orange-900/20 rounded border border-orange-100 dark:border-orange-800">
                                <span class="font-bold text-orange-800 dark:text-orange-300">${u.name}</span>
                                <div><button onclick="window.adminSetStatus('${u.id}', 'active')" class="bg-green-500 text-white text-xs px-3 py-1 rounded font-bold mr-1 hover:bg-green-600">Approve</button>
                                <button onclick="window.adminDelUser('${u.id}')" class="text-red-500 text-xs px-2 hover:underline">Deny</button></div>
                            </div>`;
                        } else {
                            activeCount++;
                            
                            const diff = (u.expected || 0) - (u.collected || 0);
                            const diffColor = diff > 0 ? 'text-red-500 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800' : (diff < 0 ? 'text-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-500 bg-gray-50 dark:bg-gray-800');
                            const diffSign = diff > 0 ? `-$${diff}` : (diff < 0 ? `+$${Math.abs(diff)}` : '$0');

                            list.innerHTML += `
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-blue-400 transition" onclick="window.viewDriverDetails('${u.id}')">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="font-bold dark:text-white flex items-center">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs mr-2 border border-blue-200">${u.name[0]}</div>
                                        ${u.name}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-500">Holding</div>
                                        <div class="font-black dark:text-white">${(u.weight||0).toFixed(1)}g</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-end border-t dark:border-gray-700 pt-2">
                                    <div class="text-xs text-gray-500">
                                        Exp: <span class="font-bold text-gray-800 dark:text-gray-300">$${u.expected||0}</span><br>
                                        Col: <span class="font-bold text-green-600">$${u.collected||0}</span>
                                    </div>
                                    <div class="text-xs font-bold px-2 py-1 rounded ${diffColor}">
                                        Lost: ${diffSign}
                                    </div>
                                </div>
                            </div>`;
                            
                            const opt = document.createElement('option'); opt.value=u.id; opt.innerText=`${u.name} (${(u.weight||0).toFixed(1)}g)`; 
                            select.appendChild(opt); 
                        }
                    }
                });
                
                document.getElementById('admin-active-count').innerText = `${activeCount} Active`;
                if(pendCount === 0) pendingList.innerHTML = '<div class="text-gray-400 italic text-xs">No pending users.</div>';
            });

            // Listen to Weight Requests
            unsubReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                const section = document.getElementById('admin-requests-section'); 
                const list = document.getElementById('admin-requests-list'); 
                list.innerHTML = ''; let count = 0;
                snap.forEach(d => { 
                    const req = d.data(); 
                    if(req.status === 'pending') { 
                        count++; 
                        list.innerHTML += `<div class="bg-white dark:bg-gray-800 p-2 rounded-lg flex justify-between items-center text-sm shadow-sm"><span class="font-bold dark:text-white">${req.name} <span class="text-xs font-normal text-gray-500 ml-2">Needs weight</span></span><div class="space-x-1"><button onclick="window.fulfillReq('${d.id}', '${req.uid}')" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded font-bold hover:bg-blue-700">Fulfill</button><button onclick="window.dismissReq('${d.id}')" class="text-gray-400 text-xs px-2 hover:text-gray-600">Dismiss</button></div></div>`; 
                    }
                });
                if(count > 0) {
                    section.classList.remove('hidden');
                    document.getElementById('admin-req-badge').classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                    document.getElementById('admin-req-badge').classList.add('hidden');
                }
            });
        }

        // --- Admin Storage & Config ---
        window.adminAddWeight = async () => { 
            const q = prompt("Add weight to Master Vault (g):"); 
            if(q && !isNaN(q)) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{rawWeight:increment(parseFloat(q))},{merge:true}); 
        };
        
        window.adminSetVariable = async (field, label) => {
            const v = prompt(`Set ${label}:`, masterData[field]);
            if(v && !isNaN(v)) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[field]: parseFloat(v)},{merge:true});
        };

        window.adminProcessUnits = async () => {
            const qty = parseInt(document.getElementById('process-qty').value);
            const wpu = parseFloat(document.getElementById('process-weight').value);
            
            if(isNaN(qty) || qty <= 0 || isNaN(wpu) || wpu <= 0) return window.showToast("Enter valid amounts");
            
            const totalW = qty * wpu;
            if(masterData.rawWeight < totalW) return window.showToast("Not enough raw weight in vault!");

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), {
                rawWeight: increment(-totalW),
                processedUnits: increment(qty)
            }, {merge:true});
            
            document.getElementById('process-qty').value = '';
            document.getElementById('process-weight').value = '';
            window.showToast(`Processed ${qty} units.`);
        };

        // --- Admin Terminal Selling ---
        window.adminSellRaw = async () => {
            const w = parseFloat(document.getElementById('adm-sell-raw-w').value);
            const m = parseFloat(document.getElementById('adm-sell-raw-m').value);
            if(isNaN(w) || isNaN(m)) return window.showToast("Enter valid numbers");
            if(masterData.rawWeight < w) return window.showToast("Not enough raw weight!");

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { rawWeight: increment(-w) }, {merge:true});
            document.getElementById('adm-sell-raw-w').value = ''; document.getElementById('adm-sell-raw-m').value = '';
            window.showToast(`Sold ${w}g for $${m}`);
        };

        window.adminSellUnit = async () => {
            const q = parseInt(document.getElementById('adm-sell-unit-q').value);
            const m = parseFloat(document.getElementById('adm-sell-unit-m').value);
            if(isNaN(q) || isNaN(m)) return window.showToast("Enter valid numbers");
            if(masterData.processedUnits < q) return window.showToast("Not enough processed units!");

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { processedUnits: increment(-q) }, {merge:true});
            document.getElementById('adm-sell-unit-q').value = ''; document.getElementById('adm-sell-unit-m').value = '';
            window.showToast(`Sold ${q} units for $${m}`);
        };

        window.adminPersonalUse = async (type) => {
            if(type === 'weight') {
                const w = parseFloat(document.getElementById('adm-use-w').value);
                if(isNaN(w) || w <= 0) return;
                if(masterData.rawWeight < w) return window.showToast("Not enough raw weight!");
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { rawWeight: increment(-w) }, {merge:true});
                document.getElementById('adm-use-w').value = '';
            } else {
                const u = parseInt(document.getElementById('adm-use-u').value);
                if(isNaN(u) || u <= 0) return;
                if(masterData.processedUnits < u) return window.showToast("Not enough processed units!");
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { processedUnits: increment(-u) }, {merge:true});
                document.getElementById('adm-use-u').value = '';
            }
            window.showToast("Personal Use Logged");
        };

        // --- Admin Transfers ---
        window.updateTransferPreview = () => {
            const uid = document.getElementById('transfer-staff-select').value;
            const el = document.getElementById('transfer-preview');
            const u = globalRoster.find(x => x.id === uid);
            if(u) el.innerText = `Currently Holding: ${(u.weight||0).toFixed(1)}g`;
            else el.innerText = '';
        };

        window.adminTransferWeight = async () => {
            const uid = document.getElementById('transfer-staff-select').value;
            const amt = parseFloat(document.getElementById('transfer-amount').value);
            if(!uid || isNaN(amt) || amt <= 0) return window.showToast("Select staff and valid amount");
            
            if(masterData.rawWeight < amt) {
                if(!confirm(`Warning: Master vault only has ${masterData.rawWeight.toFixed(1)}g. Proceed anyway?`)) return;
            }

            // Deduct Master
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{rawWeight:increment(-amt)},{merge:true}); 

            // Fetch absolute latest staff data to prevent overwrite
            const r = doc(db,'artifacts',appId,'users',uid,'data','app_state'); 
            const sn = await getDoc(r); 
            let dat = sn.exists() ? JSON.parse(sn.data().json) : {weight:0, soldWeight:0, collected:0, expected:0, transactions:[]}; 
            
            dat.weight = (dat.weight||0) + amt;
            
            // Save private
            await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
            // Save public
            await setDoc(doc(db,'artifacts',appId,'public','data','roster',uid), {weight: dat.weight}, {merge:true}); 
            
            document.getElementById('transfer-amount').value = '';
            window.updateTransferPreview();
            window.showToast(`Sent ${amt}g to staff.`);
        };

        window.fulfillReq = async (reqId, uid) => { 
            document.getElementById('transfer-staff-select').value = uid; 
            window.updateTransferPreview(); 
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId)); 
            window.showToast("Staff selected below."); 
        };
        window.dismissReq = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id)); };

        // --- Admin Staff Approvals ---
        window.adminSetStatus = async (uid, status) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid), { status }); };
        window.adminDelUser = async (uid) => { if(confirm("Deny/Delete user?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid)); };

        // --- Admin Detail View ---
        window.viewDriverDetails = (uid) => { 
            const d = globalRoster.find(x => x.id === uid); 
            if(!d) return; 
            currentDetailUid = uid; 
            document.getElementById('admin-user-detail').classList.remove('hidden'); 
            document.getElementById('detail-user-name').innerText = d.name; 
            
            document.getElementById('det-holding').innerText = (d.weight||0).toFixed(1);
            document.getElementById('det-sold').innerText = (d.soldWeight||0).toFixed(1);
            document.getElementById('det-expected').innerText = `$${d.expected||0}`;
            document.getElementById('det-collected').innerText = `$${d.collected||0}`;
            document.getElementById('det-personal').innerText = `${(d.personalUseWeight||0).toFixed(1)}g`;
            
            const diff = (d.expected||0) - (d.collected||0);
            const box = document.getElementById('det-diff-box');
            const diffEl = document.getElementById('det-diff');
            
            if(diff > 0) {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400";
                diffEl.innerText = `-$${diff} (Short)`;
            } else if (diff < 0) {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400";
                diffEl.innerText = `+$${Math.abs(diff)} (Over)`;
            } else {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300";
                diffEl.innerText = `$0 (Perfect)`;
            }
        };

        window.adminClearStaffData = async () => {
            if(!currentDetailUid) return;
            if(!confirm("Are you sure? This sets their Expected and Collected money, and Sold Weight to 0. \n\n(It does NOT remove their Holding Weight or Personal Use total).")) return;

            const r = doc(db,'artifacts',appId,'users',currentDetailUid,'data','app_state'); 
            const sn = await getDoc(r); 
            if(sn.exists()) {
                let dat = JSON.parse(sn.data().json);
                dat.soldWeight = 0; dat.collected = 0; dat.expected = 0; dat.transactions = [];
                await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
                await setDoc(doc(db,'artifacts',appId,'public','data','roster',currentDetailUid), {soldWeight:0, collected:0, expected:0, recentLogs:[]}, {merge:true}); 
                window.showToast("Data Cleared.");
                document.getElementById('admin-user-detail').classList.add('hidden');
            }
        };

    </script>
</body>
</html>