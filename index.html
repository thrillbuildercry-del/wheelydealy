<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales & Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .hidden { display: none !important; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
    <script>
        if (localStorage.theme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal-overlay z-[150]">
        <div class="text-white flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p class="font-bold tracking-wide">Loading Profile...</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Portal Login</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Drivers & Admins</p>
            </div>
            <button onclick="window.handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-3 rounded-lg shadow-sm flex justify-center items-center hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Approval Pending / Suspended Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold dark:text-white">Access Restricted</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">Your account is pending approval or has been suspended by the Admin. Please contact management.</p>
            <button onclick="window.logout()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-lg text-gray-700 dark:text-gray-300">Sign Out</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Options</h2>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <!-- Quick Stats in Settings -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">My Snapshot</h3>
                <div class="flex justify-between text-sm">
                    <span>Total Sales (Lifetime)</span>
                    <span class="font-bold" id="setting-stat-total">0</span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                    <span>Current Debt</span>
                    <span class="font-bold text-red-500" id="setting-stat-debt">$0</span>
                </div>
            </div>

            <div class="space-y-3">
                <button onclick="window.toggleTheme()" class="w-full flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <span class="font-medium dark:text-white">Dark Mode</span>
                    <i data-lucide="moon" class="w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                </button>
                <hr class="border-gray-200 dark:border-gray-700 my-2">
                <button onclick="window.logout()" class="w-full flex justify-center items-center p-3 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg font-bold">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- DRIVER REPORTS MODAL -->
    <div id="driver-stats-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-0 rounded-2xl shadow-2xl w-11/12 max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 bg-blue-600 dark:bg-gray-700 text-white flex justify-between items-center">
                <h2 class="text-lg font-bold">My Performance</h2>
                <button onclick="document.getElementById('driver-stats-modal').classList.add('hidden')" class="p-1 hover:bg-blue-700 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase">This Week</div>
                        <div class="text-xl font-bold text-green-600" id="drv-stat-week">$0</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase">This Month</div>
                        <div class="text-xl font-bold text-blue-600" id="drv-stat-month">$0</div>
                    </div>
                </div>
                <div class="h-64 bg-white dark:bg-gray-900 rounded-lg p-2 border border-gray-100 dark:border-gray-700 mb-4">
                    <canvas id="driverProfitChart"></canvas>
                </div>
                <h3 class="font-bold text-sm mb-2 dark:text-white">Breakdown</h3>
                <div class="space-y-2 text-sm" id="drv-stat-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- DRIVER SCHEDULE MODAL -->
    <div id="driver-schedule-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-0 rounded-2xl shadow-2xl w-11/12 max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 bg-purple-600 dark:bg-purple-800 text-white flex justify-between items-center">
                <h2 class="text-lg font-bold">Work Schedule</h2>
                <button onclick="document.getElementById('driver-schedule-modal').classList.add('hidden')" class="p-1 hover:bg-purple-700 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-4 overflow-y-auto space-y-6">
                <!-- My Upcoming Shifts -->
                <div>
                    <h3 class="font-bold text-gray-800 dark:text-white text-sm uppercase tracking-wide mb-2">My Shifts</h3>
                    <div id="drv-my-shifts" class="space-y-2">
                        <div class="text-center text-gray-400 text-xs py-2">Loading...</div>
                    </div>
                </div>

                <!-- Cover Request Form -->
                <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border border-purple-100 dark:border-purple-800">
                    <h3 class="font-bold text-purple-800 dark:text-purple-300 text-xs uppercase mb-2">Request Cover</h3>
                    <p class="text-[10px] text-gray-500 mb-2">Select one of your shifts to request cover for.</p>
                    <select id="drv-cover-select" class="w-full p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg text-sm mb-2">
                        <option value="">Select Shift...</option>
                    </select>
                    <button onclick="window.driverRequestCover()" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 rounded-lg transition">Post Request</button>
                </div>

                <!-- Available Overtime -->
                <div>
                    <h3 class="font-bold text-gray-800 dark:text-white text-sm uppercase tracking-wide mb-2 flex items-center">
                        Available Overtime <span class="bg-green-100 text-green-800 text-[10px] px-1.5 py-0.5 rounded-full ml-2 font-bold" id="drv-ot-count">0</span>
                    </h3>
                    <div id="drv-ot-list" class="space-y-2">
                        <div class="text-center text-gray-400 text-xs py-2">No overtime available.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DRIVER UI -->
    <div id="driver-app" class="hidden pb-24">
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300" id="driver-header">
            <div>
                <h1 class="text-lg font-bold">Driver Portal</h1>
                <div class="flex items-center text-xs text-blue-200 mt-1 space-x-2">
                    <span id="driver-name-display">Guest</span>
                    <span>â€¢</span>
                    <!-- Status Toggle -->
                    <button onclick="window.toggleDriverStatus()" id="status-badge" class="flex items-center bg-black/20 px-2 py-0.5 rounded-full hover:bg-black/30 transition">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400 mr-1.5"></div>
                        <span id="status-text">Offline</span>
                    </button>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="window.openSchedule()" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition relative">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <div id="sched-notify-dot" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-blue-700 dark:border-gray-700"></div>
                </button>
                <button onclick="window.openDriverStats()" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                </button>
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto">
            <!-- Stock Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 relative overflow-hidden">
                <div class="flex justify-between items-center relative z-10">
                    <div>
                        <h2 class="text-gray-500 text-xs uppercase tracking-wide">My Stock</h2>
                        <div class="flex items-end">
                            <span class="text-4xl font-bold dark:text-white mr-3" id="display-stock">0</span>
                            <button onclick="window.driverRequestStock()" class="text-[10px] bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded-full font-bold mb-2 transition flex items-center">
                                <i data-lucide="plus-circle" class="w-3 h-3 mr-1"></i> Request More
                            </button>
                        </div>
                    </div>
                    <div class="text-right">
                        <h2 class="text-gray-500 text-xs uppercase tracking-wide">Total Debt Owed</h2>
                        <span class="text-2xl font-bold text-red-500" id="display-debt">$0</span>
                    </div>
                </div>
            </div>

            <!-- New Sale Card (Split) -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700">
                
                <!-- Standard Price Section -->
                <h2 class="text-gray-500 text-xs uppercase tracking-wide mb-2 flex items-center">
                    <i data-lucide="tag" class="w-3 h-3 mr-1 text-green-500"></i> Standard Price ($80/ea)
                </h2>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="window.sellItem(1, 'full')" class="p-2 rounded-lg border border-green-200 dark:border-green-900 bg-green-50 dark:bg-green-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-green-700 dark:text-green-400">1</div><div class="text-[10px] text-gray-500">$80</div></button>
                    <button onclick="window.sellItem(2, 'full')" class="p-2 rounded-lg border border-green-200 dark:border-green-900 bg-green-50 dark:bg-green-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-green-700 dark:text-green-400">2</div><div class="text-[10px] text-gray-500">$160</div></button>
                    <button onclick="window.sellItem(3, 'full')" class="p-2 rounded-lg border border-green-200 dark:border-green-900 bg-green-50 dark:bg-green-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-green-700 dark:text-green-400">3</div><div class="text-[10px] text-gray-500">$240</div></button>
                    <button onclick="window.sellItem(4, 'full')" class="p-2 rounded-lg border border-green-200 dark:border-green-900 bg-green-50 dark:bg-green-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-green-700 dark:text-green-400">4</div><div class="text-[10px] text-gray-500">$320</div></button>
                </div>

                <!-- Deal Price Section -->
                <h2 class="text-gray-500 text-xs uppercase tracking-wide mb-2 flex items-center">
                    <i data-lucide="percent" class="w-3 h-3 mr-1 text-orange-500"></i> Deal Price (Discount)
                </h2>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="window.sellItem(1, 'deal')" class="p-2 rounded-lg border border-orange-200 dark:border-orange-900 bg-orange-50 dark:bg-orange-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-orange-600 dark:text-orange-400">1</div><div class="text-[10px] text-gray-500">$80</div></button>
                    <button onclick="window.sellItem(2, 'deal')" class="p-2 rounded-lg border border-orange-200 dark:border-orange-900 bg-orange-50 dark:bg-orange-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-orange-600 dark:text-orange-400">2</div><div class="text-[10px] text-gray-500">$150</div></button>
                    <button onclick="window.sellItem(3, 'deal')" class="p-2 rounded-lg border border-orange-200 dark:border-orange-900 bg-orange-50 dark:bg-orange-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-orange-600 dark:text-orange-400">3</div><div class="text-[10px] text-gray-500">$220</div></button>
                    <button onclick="window.sellItem(4, 'deal')" class="p-2 rounded-lg border border-orange-200 dark:border-orange-900 bg-orange-50 dark:bg-orange-900/10 active:scale-95 transition hover:shadow-md"><div class="text-sm font-bold text-orange-600 dark:text-orange-400">4</div><div class="text-[10px] text-gray-500">$280</div></button>
                </div>
            </div>

            <!-- Today's Stats -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-gray-500 text-xs uppercase tracking-wide">Today's Shift</h2>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold" id="today-profit-badge">$0 Profit</span>
                </div>
                <div id="transaction-list" class="space-y-2 max-h-64 overflow-y-auto hide-scrollbar text-sm">
                    <div class="text-center text-gray-400 py-2">No sales yet today</div>
                </div>
                <button onclick="window.endDay()" class="mt-4 w-full bg-gray-900 dark:bg-gray-700 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">End Shift & Save</button>
            </div>
        </main>
    </div>

    <!-- ADMIN UI -->
    <div id="admin-app" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900 pb-20">
        <header class="bg-gray-900 text-white p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">BOSS DASHBOARD</h1>
                <p class="text-xs text-gray-400" id="admin-date-display"></p>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-2xl mx-auto">
            
            <!-- Admin Navigation -->
            <div class="flex space-x-1 mb-6 bg-white dark:bg-gray-800 p-1 rounded-xl shadow-sm overflow-x-auto hide-scrollbar">
                <button onclick="window.switchAdminTab('team')" id="adm-tab-team" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm whitespace-nowrap px-2 transition bg-gray-100 dark:bg-gray-700 text-blue-600">Team Sales</button>
                <button onclick="window.switchAdminTab('transfer')" id="adm-tab-transfer" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm whitespace-nowrap px-2 text-gray-500 dark:text-gray-400 transition hover:bg-gray-50 dark:hover:bg-gray-700">Manage</button>
                <button onclick="window.switchAdminTab('schedule')" id="adm-tab-schedule" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm whitespace-nowrap px-2 text-gray-500 dark:text-gray-400 transition hover:bg-gray-50 dark:hover:bg-gray-700">Schedule</button>
                <button onclick="window.switchAdminTab('employees')" id="adm-tab-employees" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm whitespace-nowrap px-2 text-gray-500 dark:text-gray-400 transition hover:bg-gray-50 dark:hover:bg-gray-700">Employees</button>
                <button onclick="window.switchAdminTab('reports')" id="adm-tab-reports" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm whitespace-nowrap px-2 text-gray-500 dark:text-gray-400 transition hover:bg-gray-50 dark:hover:bg-gray-700">Reports</button>
            </div>

            <!-- TAB: TEAM OVERVIEW -->
            <div id="admin-view-team" class="admin-tab-content">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase">Total Team Profit</div>
                        <div class="text-2xl font-bold text-green-600" id="admin-total-profit">$0</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase">Items Sold Today</div>
                        <div class="text-2xl font-bold text-blue-600" id="admin-total-sold">0</div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-3 ml-1">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300">Driver Status & Debt</h3>
                    <div class="text-xs text-gray-400">Green = Active</div>
                </div>
                <div id="admin-driver-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400 animate-pulse">Loading team data...</div>
                </div>
            </div>

            <!-- TAB: TRANSFERS (UNIFIED) -->
            <div id="admin-view-transfer" class="admin-tab-content hidden">
                
                <!-- Stock Requests Section -->
                <div id="admin-stock-requests" class="hidden mb-6 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800">
                    <h3 class="font-bold text-blue-800 dark:text-blue-300 text-xs uppercase mb-3 flex items-center">
                        <i data-lucide="bell" class="w-4 h-4 mr-2"></i> Pending Stock Requests
                    </h3>
                    <div id="admin-stock-requests-list" class="space-y-2"></div>
                </div>

                <!-- Master Stock Card -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-4 text-white mb-6 shadow-lg flex justify-between items-center">
                     <div>
                        <div class="text-xs uppercase text-gray-400">Warehouse Stock</div>
                        <div class="text-2xl font-bold" id="admin-master-stock">--</div>
                    </div>
                    <div class="space-x-2">
                         <button onclick="window.adminAddMasterStock()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-gray-600">+ Restock</button>
                         <button onclick="window.adminDistributeStock()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-xs font-bold shadow">Distribute</button>
                    </div>
                </div>

                <!-- 1. Peer-to-Peer Transfer -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center text-sm uppercase tracking-wide">
                        <i data-lucide="arrow-right-left" class="w-4 h-4 mr-2 text-purple-600"></i> Driver to Driver Transfer
                    </h3>
                    <div class="space-y-4">
                        <div class="flex space-x-2 items-start">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-gray-500 uppercase">From</label>
                                <select id="transfer-from" onchange="window.updateTransferStats('from')" class="w-full mt-1 p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm admin-driver-select"></select>
                                <div id="transfer-stats-from" class="text-[10px] text-gray-500 dark:text-gray-400 mt-1 pl-1 min-h-[15px]"></div>
                            </div>
                            <div class="pt-7 text-gray-400"><i data-lucide="arrow-right" class="w-4 h-4"></i></div>
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-gray-500 uppercase">To</label>
                                <select id="transfer-to" onchange="window.updateTransferStats('to')" class="w-full mt-1 p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm admin-driver-select"></select>
                                <div id="transfer-stats-to" class="text-[10px] text-gray-500 dark:text-gray-400 mt-1 pl-1 min-h-[15px]"></div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Items</label><input type="number" id="p2p-stock" placeholder="0" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg font-bold"></div>
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Debt ($)</label><input type="number" id="p2p-debt" placeholder="$0" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg font-bold"></div>
                        </div>
                        <button onclick="window.adminP2PTransfer()" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-purple-700 active:scale-95 transition">Transfer Assets</button>
                    </div>
                </div>

                <!-- 2. Manager Actions -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center text-sm uppercase tracking-wide">
                        <i data-lucide="download" class="w-4 h-4 mr-2 text-green-600"></i> Manager Collection / Returns
                    </h3>
                    <div class="space-y-4">
                        <div>
                             <label class="text-[10px] font-bold text-gray-500 uppercase">Select Target Driver</label>
                             <select id="collect-driver" onchange="window.updateTransferStats('collect')" class="w-full mt-1 p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm admin-driver-select"></select>
                             <div id="collect-stats" class="text-[10px] text-gray-500 dark:text-gray-400 mt-1 pl-1 min-h-[15px]"></div>
                        </div>
                        <div class="flex space-x-2">
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Return Stock</label><input type="number" id="collect-stock" placeholder="0" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg font-bold text-blue-600"></div>
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Collect Debt ($)</label><input type="number" id="collect-debt" placeholder="$0" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg font-bold text-green-600"></div>
                        </div>
                        <button onclick="window.adminManageDriver()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg shadow-md hover:bg-gray-700 active:scale-95 transition">Process Collection</button>
                    </div>
                </div>
            </div>

            <!-- TAB: SCHEDULE -->
            <div id="admin-view-schedule" class="admin-tab-content hidden">
                <!-- Assign Shift -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 text-sm uppercase tracking-wide">Assign Shift</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <select id="sched-driver" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm admin-driver-select"></select>
                        <input type="date" id="sched-date" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm dark:text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="time" id="sched-start" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm dark:text-white">
                        <input type="time" id="sched-end" class="w-full p-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm dark:text-white">
                    </div>
                    <button onclick="window.adminAssignShift()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">Add to Schedule</button>
                </div>

                <!-- Cover Requests -->
                <div class="mb-6">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-2">Cover Requests</h3>
                    <div id="admin-cover-list" class="space-y-2">
                        <div class="text-center text-gray-400 text-sm py-2">No active cover requests.</div>
                    </div>
                </div>

                <!-- Upcoming Schedule List -->
                <div>
                    <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-2">Upcoming Shifts</h3>
                    <div id="admin-schedule-list" class="space-y-2">
                        <div class="text-center text-gray-400 text-sm py-4">Loading schedule...</div>
                    </div>
                </div>
            </div>

            <!-- TAB: EMPLOYEES (NEW) -->
            <div id="admin-view-employees" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2 text-blue-600"></i> Employee Management
                    </h3>
                    <div id="admin-employee-list" class="space-y-3">
                        <!-- Populated by JS -->
                        <div class="text-center text-gray-400 text-sm">Loading employees...</div>
                    </div>
                </div>
            </div>

            <!-- TAB: REPORTS -->
            <div id="admin-view-reports" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4">Team Performance (Last 7 Days)</h3>
                    <div class="h-64">
                        <canvas id="adminTeamChart"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase mb-1">Gross Revenue (7d)</div>
                        <div class="text-xl font-bold text-gray-800 dark:text-white" id="adm-report-week-gross">$0</div>
                        <div class="text-sm text-green-600 font-bold" id="adm-report-week-profit">$0 Profit</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase mb-1">Gross Revenue (Mo)</div>
                        <div class="text-xl font-bold text-gray-800 dark:text-white" id="adm-report-month-gross">$0</div>
                        <div class="text-sm text-blue-600 font-bold" id="adm-report-month-profit">$0 Profit</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: USER DETAIL -->
            <div id="admin-user-detail" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 overflow-y-auto hidden">
                <div class="bg-white dark:bg-gray-800 p-4 sticky top-0 shadow-md flex items-center justify-between z-10">
                    <button onclick="document.getElementById('admin-user-detail').classList.add('hidden')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <h2 class="font-bold text-lg dark:text-white" id="detail-user-name">Driver Stats</h2>
                    <div class="w-8"></div>
                </div>
                <div class="p-4 max-w-2xl mx-auto space-y-4">
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900 p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-xs font-bold text-red-500 uppercase">Owed to Boss</div>
                            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="detail-debt">$0</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Stock</div>
                            <div class="text-xl font-bold dark:text-white" id="detail-stock">0</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Profit Today</div>
                            <div class="text-xl font-bold text-green-600" id="detail-profit">0</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-sm mb-3 border-b pb-2 dark:border-gray-700 dark:text-white">Recent Transactions</h3>
                        <div id="detail-log-list" class="space-y-2 text-sm max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-sm mb-2 border-b pb-2 dark:border-gray-700 dark:text-white">Shift History</h3>
                        <div class="flex space-x-2 mb-2 border-b dark:border-gray-700">
                            <button onclick="window.renderHistory('daily')" id="hist-tab-daily" class="pb-1 text-sm font-bold border-b-2 border-blue-500 text-blue-500">Daily</button>
                            <button onclick="window.renderHistory('weekly')" id="hist-tab-weekly" class="pb-1 text-sm font-bold text-gray-400">Weekly</button>
                            <button onclick="window.renderHistory('monthly')" id="hist-tab-monthly" class="pb-1 text-sm font-bold text-gray-400">Monthly</button>
                        </div>
                        <div id="detail-history-list" class="space-y-2 text-sm"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- MAIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, updateDoc, increment, getDocs, addDoc, query, where, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgX9tL8zEaPvaZIcqDdk8XHzz4y7MvCeU",
            authDomain: "salesonwheels-f6eec.firebaseapp.com",
            projectId: "salesonwheels-f6eec",
            storageBucket: "salesonwheels-f6eec.firebasestorage.app",
            messagingSenderId: "432785821226",
            appId: "1:432785821226:web:96b34cc3d0526160b0bd53"
        };
        const appId = "sales-tracker-v1"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userRole = 'driver'; 
        let appData = { stock: 0, debt: 0, status: 'inactive', currentTransactions: [], history: [], stockLogs: [] };
        let currentDetailUid = null;
        let currentDriverData = null; 
        let globalRoster = []; 
        let driverShifts = [];
        
        let driverChartInstance = null;
        let adminChartInstance = null;

        // Listeners
        let unsubUserData = null;
        let unsubProfile = null;
        let unsubRoster = null; 
        let unsubMasterStock = null; 
        let unsubStockReqs = null;
        let unsubCoverReqs = null;
        let unsubMyShifts = null;
        let unsubAuthCheck = null;

        // --- UTILS ---
        window.showToast = (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); };
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); };

        // --- AUTH ---
        window.handleGoogleLogin = async () => { try { await signInWithPopup(auth, googleProvider); } catch (e) { window.showToast("Login Failed: " + e.message); } };
        window.logout = async () => { 
            if(unsubUserData) unsubUserData(); 
            if(unsubProfile) unsubProfile(); 
            if(unsubRoster) unsubRoster(); 
            if(unsubAuthCheck) unsubAuthCheck();
            await signOut(auth); window.location.reload(); 
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                // 1. Create/Ensure Profile Exists
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const profileSnap = await getDoc(profileRef);
                if (!profileSnap.exists()) {
                    await setDoc(profileRef, { name: user.displayName || user.email, email: user.email, role: 'driver', createdAt: Date.now() });
                }

                // 2. Ensure Roster Entry (Auth Source of Truth)
                const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', user.uid);
                await setDoc(rosterRef, { name: user.displayName || user.email, email: user.email, uid: user.uid, lastLogin: Date.now() }, { merge: true });

                // 3. Listen to Roster for Permission
                unsubAuthCheck = onSnapshot(rosterRef, (snap) => {
                    const data = snap.data();
                    const status = data.status || 'pending'; // Default to pending if not set
                    const role = data.role || 'driver';
                    
                    userRole = role;
                    document.getElementById('loading-overlay').classList.add('hidden');

                    if (role === 'admin') {
                        initAdminDashboard();
                    } else if (status === 'active' || status === 'approved') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        initDriverApp(user);
                    } else {
                        // Pending or Suspended
                        document.getElementById('approval-modal').classList.remove('hidden');
                        document.getElementById('driver-app').classList.add('hidden');
                        document.getElementById('admin-app').classList.add('hidden');
                    }
                });

            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('driver-app').classList.add('hidden');
                document.getElementById('admin-app').classList.add('hidden');
            }
        });

        // --- DRIVER LOGIC ---
        function initDriverApp(user) {
            document.getElementById('driver-app').classList.remove('hidden');
            document.getElementById('driver-name-display').innerText = user.displayName ? user.displayName.split(' ')[0] : 'Driver';
            
            // Listen to private data
            unsubUserData = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state'), (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if(data.json) appData = JSON.parse(data.json);
                    // Defaults
                    appData.stock = appData.stock || 0; appData.debt = appData.debt || 0; 
                    appData.currentTransactions = appData.currentTransactions || []; appData.history = appData.history || [];
                    renderDriverUI();
                } else { saveDriverData(); }
            });

            // Listen to Public Roster for Shifts (Admin updates this)
            unsubMyShifts = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'roster', user.uid), (snap) => {
                if(snap.exists()) {
                    driverShifts = snap.data().shifts || [];
                    renderDriverSchedule();
                }
            });

            // Listen to Cover Requests
            const coverRef = collection(db, 'artifacts', appId, 'public', 'data', 'cover_requests');
            onSnapshot(coverRef, (snap) => {
                const list = document.getElementById('drv-ot-list');
                const badge = document.getElementById('drv-ot-count');
                const dot = document.getElementById('sched-notify-dot');
                list.innerHTML = '';
                let count = 0;

                snap.forEach(d => {
                    const req = d.data();
                    if(req.status === 'open' && req.requesterUid !== currentUser.uid) {
                        count++;
                        const card = document.createElement('div');
                        card.className = "bg-white dark:bg-gray-700 p-2 rounded border border-gray-200 dark:border-gray-600 flex justify-between items-center";
                        card.innerHTML = `
                            <div>
                                <div class="font-bold text-sm dark:text-white">${req.date} (${req.start}-${req.end})</div>
                                <div class="text-xs text-gray-500">${req.requesterName} needs cover</div>
                            </div>
                            <button onclick="window.driverAcceptCover('${d.id}')" class="bg-green-600 text-white text-[10px] font-bold px-2 py-1 rounded hover:bg-green-700">Take Shift</button>
                        `;
                        list.appendChild(card);
                    }
                });
                badge.innerText = count;
                if(count > 0) dot.classList.remove('hidden'); else dot.classList.add('hidden');
                if(count === 0) list.innerHTML = '<div class="text-center text-gray-400 text-xs py-2">No overtime available.</div>';
            });
        }

        function renderDriverUI() {
            document.getElementById('display-stock').innerText = appData.stock;
            document.getElementById('display-debt').innerText = `$${appData.debt.toLocaleString()}`;
            document.getElementById('setting-stat-debt').innerText = `$${appData.debt.toLocaleString()}`;
            const totalSales = appData.history.reduce((a,b) => a + (b.sold || 0), 0) + appData.currentTransactions.reduce((a,b) => a + b.qty, 0);
            document.getElementById('setting-stat-total').innerText = totalSales;
            const todayTotals = appData.currentTransactions.reduce((acc, t) => ({ profit: acc.profit + t.profit }), {profit:0});
            document.getElementById('today-profit-badge').innerText = `+$${todayTotals.profit} Profit`;

            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            appData.currentTransactions.map((t, i) => ({...t, originalIndex: i})).reverse().forEach(t => {
                let badge = t.type === 'full' ? `<span class="text-[10px] text-green-500 font-bold ml-1">(STD)</span>` : `<span class="text-[10px] text-orange-500 font-bold ml-1">(DEAL)</span>`;
                list.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded group">
                    <div><div class="text-sm dark:text-gray-200"><span class="font-bold">${t.qty}</span> items ${badge}</div><div class="text-xs text-gray-400">${t.time}</div></div>
                    <div class="flex items-center space-x-3"><span class="font-bold text-green-600">+$${t.profit}</span><button onclick="window.deleteSale(${t.originalIndex})" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>
                </div>`;
            });
            if(appData.currentTransactions.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-2">No sales yet today</div>';
            lucide.createIcons();
        }

        async function saveDriverData() {
            if(!currentUser) return;
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state'), { json: JSON.stringify(appData), lastUpdated: Date.now() });
            let todaySold = 0, todayProfit = 0, todayGross = 0;
            appData.currentTransactions.forEach(t => { todaySold += t.qty; todayProfit += t.profit; todayGross += t.price; });
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid), {
                    stock: appData.stock, debt: appData.debt, status: appData.status,
                    todaySold, todayProfit, todayGross, recentLogs: appData.currentTransactions.slice(-20).reverse(), 
                    history: appData.history.slice(-30), lastSync: Date.now()
                }, { merge: true });
            } catch(e) { console.log("Public sync failed", e); }
        }

        window.toggleDriverStatus = async () => {
            appData.status = appData.status === 'active' ? 'inactive' : 'active';
            const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text'); const hdr = document.getElementById('driver-header');
            if(appData.status === 'active') { dot.className="w-2 h-2 rounded-full bg-green-400 mr-1.5 animate-pulse"; txt.innerText="Online"; hdr.className="bg-green-600 dark:bg-green-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300"; }
            else { dot.className="w-2 h-2 rounded-full bg-gray-400 mr-1.5"; txt.innerText="Offline"; hdr.className="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300"; }
            await saveDriverData();
        };

        window.sellItem = async (qty, type) => {
            if(appData.stock < qty) { window.showToast("Not enough stock!"); return; }
            if(appData.status !== 'active') { if(!confirm("You are Offline. Sell anyway?")) return; window.toggleDriverStatus(); }
            
            let price=0, profit=0, owed=0;
            if (type === 'full') { price = 80*qty; profit = 20*qty; owed = 60*qty; }
            else { const tiers = {1:{p:80,prof:20},2:{p:150,prof:40},3:{p:220,prof:60},4:{p:280,prof:80}}; const t=tiers[qty]; price=t.p; profit=t.prof; owed=price-profit; }
            
            appData.stock -= qty; appData.debt += owed;
            appData.currentTransactions.push({ date: Date.now(), qty, price, profit, owed, type, time: new Date().toLocaleTimeString() });
            await saveDriverData(); renderDriverUI(); window.showToast(`Sold ${qty}`);
        };

        window.deleteSale = async (idx) => {
            if(!confirm("Undo?")) return;
            const t = appData.currentTransactions[idx];
            appData.stock += t.qty; appData.debt -= t.owed;
            appData.currentTransactions.splice(idx, 1);
            await saveDriverData(); renderDriverUI();
        };

        window.endDay = async () => {
            if(appData.currentTransactions.length === 0) { window.showToast("No sales."); return; }
            const stats = appData.currentTransactions.reduce((acc, t) => ({ profit: acc.profit+t.profit, sold: acc.sold+t.qty, revenue: acc.price+acc.revenue }), {profit:0, sold:0, revenue:0});
            const d = new Date().toISOString().split('T')[0];
            const exists = appData.history.findIndex(h => h.date === d);
            
            let dayRev = 0; let dayProf = 0; let daySold = 0;
            appData.currentTransactions.forEach(t => { dayRev += t.price; dayProf += t.profit; daySold += t.qty; });

            if(exists >= 0) { 
                appData.history[exists].profit += dayProf; appData.history[exists].sold += daySold; appData.history[exists].revenue += dayRev; 
            } else { 
                appData.history.push({ date: d, profit: dayProf, sold: daySold, revenue: dayRev }); 
            }
            
            appData.currentTransactions = []; appData.status = 'inactive';
            await saveDriverData(); renderDriverUI(); window.showToast("Saved!");
        };

        // --- DRIVER UTILS ---
        window.driverRequestStock = async () => {
            if(!confirm("Notify admin you need stock?")) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stock_requests'), {
                requesterUid: currentUser.uid, requesterName: document.getElementById('driver-name-display').innerText, timestamp: Date.now(), status: 'pending'
            });
            window.showToast("Request Sent");
        };

        window.openSchedule = () => { document.getElementById('driver-schedule-modal').classList.remove('hidden'); renderDriverSchedule(); };
        function renderDriverSchedule() {
            const list = document.getElementById('drv-my-shifts'); const select = document.getElementById('drv-cover-select');
            list.innerHTML = ''; select.innerHTML = '<option value="">Select Shift...</option>';
            const upcoming = driverShifts.filter(s => new Date(s.date + 'T23:59:00') >= new Date()).sort((a,b) => new Date(a.date) - new Date(b.date));
            if(upcoming.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 text-xs py-2">No upcoming shifts.</div>'; return; }
            upcoming.forEach(s => {
                list.innerHTML += `<div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded flex justify-between items-center"><span class="font-bold text-sm dark:text-gray-200">${s.date}</span><span class="text-xs text-gray-500">${s.start} - ${s.end}</span></div>`;
                const opt = document.createElement('option'); opt.value = JSON.stringify(s); opt.innerText = `${s.date} (${s.start}-${s.end})`; select.appendChild(opt);
            });
        }

        window.driverRequestCover = async () => {
            const val = document.getElementById('drv-cover-select').value; if(!val) return window.showToast("Select a shift");
            const shift = JSON.parse(val); if(!confirm(`Request cover for ${shift.date}?`)) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'cover_requests'), {
                requesterUid: currentUser.uid, requesterName: document.getElementById('driver-name-display').innerText, date: shift.date, start: shift.start, end: shift.end, status: 'open', timestamp: Date.now()
            });
            window.showToast("Cover Requested"); document.getElementById('drv-cover-select').value = "";
        };

        window.driverAcceptCover = async (reqId) => {
            if(!confirm("Accept this overtime shift?")) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cover_requests', reqId), { status: 'filled', filledByUid: currentUser.uid, filledByName: document.getElementById('driver-name-display').innerText });
            window.showToast("Shift Accepted!");
        };

        window.openDriverStats = () => { document.getElementById('driver-stats-modal').classList.remove('hidden'); renderDriverCharts(); };
        function renderDriverCharts() { 
            const ctx = document.getElementById('driverProfitChart').getContext('2d'); if(driverChartInstance) driverChartInstance.destroy();
            const data = appData.history.slice(-7);
            driverChartInstance = new Chart(ctx, { type: 'bar', data: { labels: data.map(d=>d.date.slice(5)), datasets: [{ label:'Profit', data: data.map(d=>d.profit), backgroundColor:'#3B82F6', borderRadius:4 }] }, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'#374151'}}, x:{grid:{display:false}}}}});
            const list = document.getElementById('drv-stat-list'); list.innerHTML=''; [...appData.history].reverse().slice(0,7).forEach(h=> list.innerHTML+=`<div class="flex justify-between text-xs py-1 border-b dark:border-gray-700"><span class="text-gray-500">${h.date}</span><span class="text-green-600 font-bold">+$${h.profit}</span></div>`);
        }

        // --- ADMIN LOGIC ---
        function initAdminDashboard() {
            document.getElementById('admin-app').classList.remove('hidden');
            document.getElementById('admin-date-display').innerText = new Date().toDateString();
            
            unsubRoster = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), (snap) => {
                const list = document.getElementById('admin-driver-list'); const selects = document.querySelectorAll('.admin-driver-select');
                list.innerHTML=''; selects.forEach(s=>s.innerHTML='<option value="">Select Driver...</option>');
                globalRoster=[]; let sold=0, prof=0;
                
                snap.forEach(d => {
                    const drv = { id: d.id, ...d.data() };
                    // We store all users in globalRoster for employee management, but filter for sales/transfers
                    globalRoster.push(drv);
                    
                    if(drv.role !== 'admin') {
                        sold += (drv.todaySold||0); prof += (drv.todayProfit||0);
                        
                        const statusColor = (drv.status==='active' || drv.status==='approved') ? 'border-green-500' : 'border-gray-300';
                        
                        // Only add non-admins to the Sales/Team view
                        list.innerHTML += `<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition" onclick="window.viewDriverDetails('${drv.id}')">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold mr-3 border-2 ${statusColor}">${drv.name?drv.name[0]:'U'}</div>
                                <div><div class="font-bold text-gray-800 dark:text-white">${drv.name}</div><div class="text-xs text-gray-500">Stock: ${drv.stock||0} â€¢ Debt: <span class="text-red-500">$${drv.debt||0}</span></div></div>
                            </div>
                            <div class="font-bold text-green-600">+$${drv.todayProfit||0}</div>
                        </div>`;
                        
                        if(drv.status === 'active' || drv.status === 'approved') {
                            const opt = document.createElement('option'); opt.value=drv.id; opt.innerText=drv.name;
                            selects.forEach(s=>s.appendChild(opt.cloneNode(true)));
                        }
                    }
                });
                document.getElementById('admin-total-profit').innerText = `$${prof}`; document.getElementById('admin-total-sold').innerText = sold;
                updateAdminReports(globalRoster);
                renderAdminScheduleList();
                renderEmployeeList(); // Update Employee Tab
            });

            // Listeners for Stocks/Cover/Master (Preserved)
            unsubStockReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stock_requests'), (snap) => {
                const div = document.getElementById('admin-stock-requests'); const list = document.getElementById('admin-stock-requests-list'); list.innerHTML = ''; let count = 0;
                snap.forEach(docSnap => { const req = docSnap.data(); if(req.status === 'pending') { count++; list.innerHTML += `<div class="bg-white dark:bg-gray-800 p-2 rounded flex justify-between items-center text-sm"><span class="dark:text-white">${req.requesterName} <span class="text-xs text-gray-400">needs stock</span></span><div class="space-x-1"><button onclick="window.fulfillStockReq('${docSnap.id}', '${req.requesterUid}')" class="bg-blue-600 text-white text-xs px-2 py-1 rounded">Fulfill</button><button onclick="window.dismissStockReq('${docSnap.id}')" class="text-gray-400 text-xs px-2">Dismiss</button></div></div>`; }});
                if(count > 0) div.classList.remove('hidden'); else div.classList.add('hidden');
            });
            unsubCoverReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'cover_requests'), (snap) => {
                const list = document.getElementById('admin-cover-list'); list.innerHTML = ''; let hasReqs = false;
                snap.forEach(d => { const req = d.data(); if(req.status === 'open') { hasReqs = true; list.innerHTML += `<div class="bg-red-50 dark:bg-red-900/20 p-2 rounded border border-red-100 dark:border-red-900 flex justify-between items-center"><div class="text-sm"><span class="font-bold text-red-600">OPEN:</span> ${req.requesterName} on ${req.date}</div><button onclick="window.adminForceCover('${d.id}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded">Close/Assign</button></div>`; }});
                if(!hasReqs) list.innerHTML = '<div class="text-center text-gray-400 text-sm py-2">No active cover requests.</div>';
            });
            unsubMasterStock = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), (s) => document.getElementById('admin-master-stock').innerText = s.exists()?s.data().qty:0);
        }

        // --- NEW: EMPLOYEE MANAGEMENT TAB ---
        function renderEmployeeList() {
            const list = document.getElementById('admin-employee-list');
            list.innerHTML = '';
            
            // Filter list: Show everyone except current user
            const employees = globalRoster.filter(u => u.id !== currentUser.uid);
            
            if(employees.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400">No employees found.</div>';
                return;
            }

            employees.forEach(u => {
                const status = u.status || 'pending';
                let actions = '';
                
                // Admin Protection Logic
                if (u.role === 'admin') {
                    actions = `<span class="bg-purple-100 text-purple-800 text-[10px] px-2 py-1 rounded font-bold uppercase">Admin Access</span>`;
                } else {
                    // Regular Employee Actions
                    if(status === 'pending') {
                        actions = `<button onclick="window.adminUpdateStatus('${u.id}', 'active')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded mr-2">Approve</button>`;
                    } else if (status === 'active' || status === 'approved') {
                        actions = `<button onclick="window.adminUpdateStatus('${u.id}', 'suspended')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold px-3 py-1.5 rounded mr-2">Suspend</button>`;
                    } else {
                        actions = `<button onclick="window.adminUpdateStatus('${u.id}', 'active')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold px-3 py-1.5 rounded mr-2">Re-Activate</button>`;
                    }
                    actions += `<button onclick="window.adminDeleteUser('${u.id}')" class="text-red-400 hover:text-red-600 p-1 ml-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                }

                list.innerHTML += `
                    <div class="bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center font-bold text-gray-500 mr-3 text-xs">${u.name?u.name[0]:'U'}</div>
                            <div>
                                <div class="font-bold text-sm dark:text-white flex items-center">
                                    ${u.name}
                                    ${u.role==='admin' ? '<i data-lucide="shield" class="w-3 h-3 text-purple-500 ml-1"></i>' : ''}
                                </div>
                                <div class="text-[10px] uppercase font-bold ${status==='pending'?'text-orange-500':(status==='active'||status==='approved'?'text-green-500':'text-red-500')}">${status}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            ${actions}
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        window.adminUpdateStatus = async (uid, newStatus) => {
            if(!confirm(`Change status to ${newStatus}?`)) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid), { status: newStatus });
            window.showToast("Status Updated");
        };

        window.adminDeleteUser = async (uid) => {
            if(!confirm("Permanently delete this user from roster? (Data may persist in private collection)")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid));
            window.showToast("User Removed");
        };

        // --- ADMIN HELPERS (Existing) ---
        window.fulfillStockReq = async (reqId, uid) => { document.getElementById('distribute-select-driver').value = uid; window.updateTransferStats('collect'); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock_requests', reqId), { status: 'completed' }); window.showToast("Driver Selected below"); };
        window.dismissStockReq = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock_requests', id)); };
        window.adminAssignShift = async () => { const uid=document.getElementById('sched-driver').value; const date=document.getElementById('sched-date').value; const start=document.getElementById('sched-start').value; const end=document.getElementById('sched-end').value; if(!uid||!date||!start||!end) return window.showToast("Fill all fields"); const ref=doc(db,'artifacts',appId,'public','data','roster',uid); const snap=await getDoc(ref); let shifts=snap.exists()?(snap.data().shifts||[]):[]; shifts.push({date,start,end}); await updateDoc(ref,{shifts}); window.showToast("Shift Assigned"); renderAdminScheduleList(); };
        function renderAdminScheduleList() { const list=document.getElementById('admin-schedule-list'); list.innerHTML=''; let all=[]; globalRoster.forEach(d=>{ if(d.role!=='admin') (d.shifts||[]).forEach(s=>{ if(new Date(s.date+'T23:59:00')>=new Date()) all.push({...s,name:d.name}); }); }); all.sort((a,b)=>new Date(a.date)-new Date(b.date)); if(all.length===0){list.innerHTML='<div class="text-center text-gray-400 text-sm py-4">No upcoming shifts.</div>'; return;} all.forEach(s=>{list.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm"><div><span class="font-bold dark:text-white">${s.date}</span> <span class="text-gray-500 mx-1">|</span> ${s.name}</div><div class="text-xs text-blue-500 font-bold">${s.start} - ${s.end}</div></div>`;}); }
        window.adminForceCover = async (id) => { if(confirm("Mark resolved?")) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cover_requests', id), { status: 'filled', filledByUid: 'admin', filledByName: 'Admin Assigned' }); };
        window.updateTransferStats = (type) => { let uid,elId; if(type==='from'){uid=document.getElementById('transfer-from').value;elId='transfer-stats-from';} if(type==='to'){uid=document.getElementById('transfer-to').value;elId='transfer-stats-to';} if(type==='collect'){uid=document.getElementById('collect-driver').value;elId='collect-stats';} const drv=globalRoster.find(d=>d.id===uid); const el=document.getElementById(elId); if(drv) el.innerHTML=`<span class="text-blue-500 font-bold">Stock: ${drv.stock||0}</span> <span class="mx-1">|</span> <span class="text-red-500 font-bold">Debt: $${drv.debt||0}</span>`; else el.innerText=''; };
        window.adminDistributeStock = async () => { const l=globalRoster.filter(d=>d.role!=='admin').map((d,i)=>`${i+1}. ${d.name}`).join('\n'); const s=prompt(`Driver Num:\n${l}`); if(!s) return; const drvs=globalRoster.filter(d=>d.role!=='admin'); const d=drvs[parseInt(s)-1]; if(!d) return; const q=parseInt(prompt(`Qty for ${d.name}?`)); if(!q) return; await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{qty:increment(-q)},{merge:true}); await updateDriverAssets(d.id,q,0); window.showToast("Sent"); };
        window.adminP2PTransfer = async () => { const f=document.getElementById('transfer-from').value; const t=document.getElementById('transfer-to').value; const s=parseInt(document.getElementById('p2p-stock').value)||0; const d=parseInt(document.getElementById('p2p-debt').value)||0; if(!f||!t||(s<=0&&d<=0)) return; await updateDriverAssets(f,-s,-d); await updateDriverAssets(t,s,d); window.showToast("Transferred"); };
        window.adminManageDriver = async () => { const u=document.getElementById('collect-driver').value; const s=parseInt(document.getElementById('collect-stock').value)||0; const d=parseInt(document.getElementById('collect-debt').value)||0; if(!u||(s<=0&&d<=0)) return; await updateDriverAssets(u,-s,-d); if(s>0) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{qty:increment(s)},{merge:true}); window.showToast("Processed"); };
        async function updateDriverAssets(uid,s,d) { const r=doc(db,'artifacts',appId,'users',uid,'data','app_state'); const sn=await getDoc(r); let dat=sn.exists()?JSON.parse(sn.data().json):{stock:0,debt:0,history:[],currentTransactions:[]}; dat.stock=(dat.stock||0)+s; dat.debt=(dat.debt||0)+d; if(dat.debt<0) dat.debt=0; await setDoc(r,{json:JSON.stringify(dat),lastUpdated:Date.now()}); await setDoc(doc(db,'artifacts',appId,'public','data','roster',uid),{stock:dat.stock,debt:dat.debt},{merge:true}); }
        window.viewDriverDetails = (uid) => { if(typeof uid==='object') uid=uid.id; const d=globalRoster.find(x=>x.id===uid); if(!d) return; currentDriverData=d; document.getElementById('admin-user-detail').classList.remove('hidden'); document.getElementById('detail-user-name').innerText=d.name; document.getElementById('detail-stock').innerText=d.stock||0; document.getElementById('detail-debt').innerText=`$${d.debt||0}`; document.getElementById('detail-profit').innerText=`$${d.todayProfit||0}`; const l=document.getElementById('detail-log-list'); l.innerHTML=''; (d.recentLogs||[]).forEach(x=>{ l.innerHTML+=`<div class="flex justify-between border-b dark:border-gray-700 pb-1 mb-1 text-xs"><span>Sold ${x.qty} (${x.type})</span> <span class="text-green-600">+$${x.profit}</span></div>`; }); window.renderHistory('daily'); };
        window.renderHistory = (mode) => { if(!currentDriverData||!currentDriverData.history) return; ['daily','weekly','monthly'].forEach(m=>document.getElementById(`hist-tab-${m}`).className=m===mode?"pb-1 text-sm font-bold border-b-2 border-blue-500 text-blue-500":"pb-1 text-sm font-bold text-gray-400 hover:text-gray-600"); const list=document.getElementById('detail-history-list'); list.innerHTML=''; let d=[]; if(mode==='daily') d=[...currentDriverData.history].reverse().map(h=>({l:new Date(h.date).toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}),s:h.sold,b:(h.revenue||0)-(h.profit||0),v:h.profit||0})); else { let agg={}; currentDriverData.history.forEach(h=>{ const dt=new Date(h.date); const k=mode==='weekly'?`Week ${Math.ceil((((dt-new Date(dt.getFullYear(),0,1))/86400000)+new Date(dt.getFullYear(),0,1).getDay()+1)/7)}`:dt.toLocaleDateString(undefined,{month:'long'}); if(!agg[k]) agg[k]={s:0,b:0,v:0}; agg[k].s+=h.sold; agg[k].b+=((h.revenue||0)-(h.profit||0)); agg[k].v+=(h.profit||0); }); d=Object.keys(agg).map(k=>({l:k,s:agg[k].s,b:agg[k].b,v:agg[k].v})).reverse(); } d.forEach(i=>{ list.innerHTML+=`<div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-2 rounded mb-1 text-sm"><div><div class="font-bold dark:text-gray-200">${i.l}</div><div class="text-xs text-gray-500">${i.s} items</div></div><div class="text-right"><div class="text-xs text-gray-500">Boss: <b>$${i.b}</b></div><div class="text-xs text-green-600">Driver: <b>+$${i.v}</b></div></div></div>`; }); };
        window.switchAdminTab = (tab) => { ['team','transfer','schedule','employees','reports'].forEach(t => { document.getElementById(`admin-view-${t}`).classList.add('hidden'); document.getElementById(`adm-tab-${t}`).classList.remove('bg-gray-100','dark:bg-gray-700','text-blue-600'); document.getElementById(`adm-tab-${t}`).classList.add('text-gray-500','dark:text-gray-400'); }); document.getElementById(`admin-view-${tab}`).classList.remove('hidden'); document.getElementById(`adm-tab-${tab}`).classList.add('bg-gray-100','dark:bg-gray-700','text-blue-600'); document.getElementById(`adm-tab-${tab}`).classList.remove('text-gray-500','dark:text-gray-400'); };
        function updateAdminReports(roster) { let m={}; let wG=0,wP=0,mG=0,mP=0; const now=new Date(); const sW=new Date(now.setDate(now.getDate()-7)); const sM=new Date(new Date().getFullYear(),new Date().getMonth(),1); roster.forEach(d=>{ (d.history||[]).forEach(h=>{ const dt=new Date(h.date); if(!m[h.date]) m[h.date]={p:0,r:0}; m[h.date].p+=(h.profit||0); m[h.date].r+=(h.revenue||0); if(dt>=sW){wG+=(h.revenue||0);wP+=(h.profit||0);} if(dt>=sM){mG+=(h.revenue||0);mP+=(h.profit||0);} }); if(d.todaySold>0){wG+=d.todayGross;wP+=d.todayProfit;mG+=d.todayGross;mP+=d.todayProfit;} }); document.getElementById('adm-report-week-gross').innerText=`$${wG}`; document.getElementById('adm-report-week-profit').innerText=`$${wP} Profit`; document.getElementById('adm-report-month-gross').innerText=`$${mG}`; document.getElementById('adm-report-month-profit').innerText=`$${mP} Profit`; const d=Object.keys(m).sort().slice(-7); const ctx=document.getElementById('adminTeamChart').getContext('2d'); if(adminChartInstance) adminChartInstance.destroy(); adminChartInstance=new Chart(ctx,{type:'line',data:{labels:d.map(x=>x.slice(5)),datasets:[{label:'Gross',data:d.map(x=>m[x].r),borderColor:'#3B82F6',fill:false},{label:'Profit',data:d.map(x=>m[x].p),borderColor:'#10B981',fill:false}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,grid:{color:'#374151'}},x:{grid:{display:false}}}}}); }
        window.adminAddMasterStock = async () => { const q=prompt("Qty:"); if(q) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{qty:increment(parseInt(q))},{merge:true}); };
    </script>
</body>
</html>