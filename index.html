<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WeightOps | Revenue & Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .hidden { display: none !important; }
        
        /* Custom Selectable Buttons */
        .btn-select { transition: all 0.2s; border: 2px solid transparent; }
        .btn-select.active { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .btn-interactive:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200 min-h-screen pb-6">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal-overlay z-[150]">
        <div class="text-white flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p class="font-bold tracking-wide">Loading Database...</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-white shadow-lg">
                <i data-lucide="scale" class="w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">WeightOps</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-8">Secure Access Portal</p>
            
            <button onclick="window.handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-4 rounded-xl shadow-sm flex justify-center items-center hover:bg-gray-50 dark:hover:bg-gray-600 transition btn-interactive">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Approval Pending Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 id="approval-title" class="text-2xl font-bold dark:text-white">Access Pending</h2>
            <p id="approval-msg" class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">Sign in Pending, please contact an administrator for help.</p>
            <div class="flex flex-col gap-2">
                <button onclick="window.location.reload()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition btn-interactive">Refresh Status</button>
                <button onclick="window.logout()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-xl text-gray-700 dark:text-gray-300 btn-interactive">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Settings</h2>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <!-- Driver Vehicle Info -->
            <div id="settings-vehicle-section" class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 hidden">
                <h3 class="text-xs font-bold text-blue-600 dark:text-blue-300 uppercase mb-2">My Vehicle</h3>
                <input type="text" id="set-vehicle-color" placeholder="Color (e.g. Red)" class="w-full mb-2 p-2 rounded border bg-white dark:bg-gray-800 dark:border-gray-600 text-sm dark:text-white">
                <input type="text" id="set-vehicle-desc" placeholder="Make & Model (e.g. Toyota Camry)" class="w-full mb-2 p-2 rounded border bg-white dark:bg-gray-800 dark:border-gray-600 text-sm dark:text-white">
                <button onclick="window.saveVehicleInfo()" class="w-full bg-blue-600 text-white text-xs font-bold py-2 rounded shadow hover:bg-blue-700 btn-interactive">Save Vehicle Details</button>
            </div>

            <!-- Admin Factory Reset Area -->
            <div id="admin-settings-section" class="mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-800 hidden">
                <h3 class="text-xs font-bold text-red-600 dark:text-red-400 uppercase mb-2 flex items-center">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> Admin Danger Zone
                </h3>
                <button onclick="window.adminFactoryReset()" class="w-full bg-red-600 text-white text-xs font-bold py-2 rounded shadow hover:bg-red-700 btn-interactive">Factory Reset Inventory</button>
                <p class="text-[10px] text-gray-500 mt-2">Wipes all stock & sales to 0. Keeps user accounts.</p>
            </div>

            <div class="space-y-3">
                <button onclick="window.toggleTheme()" class="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl btn-interactive">
                    <span class="font-medium dark:text-white">Toggle Dark Mode</span>
                    <i data-lucide="moon" class="w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                </button>
                <hr class="border-gray-200 dark:border-gray-700 my-2">
                <button onclick="window.logout()" class="w-full flex justify-center items-center p-4 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold btn-interactive">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- STAFF UI -->
    <div id="staff-app" class="hidden">
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold">Staff Terminal</h1>
                <div class="text-xs text-blue-200" id="staff-name-display">Guest</div>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-md mx-auto space-y-4">
            
            <!-- Stock Card -->
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl shadow-lg p-5 text-white relative overflow-hidden">
                <div class="flex justify-between items-start relative z-10 mb-4 border-b border-gray-700 pb-3">
                    <div>
                        <h2 class="text-gray-400 text-xs uppercase font-bold tracking-widest mb-1">Raw Weight</h2>
                        <div class="flex items-baseline">
                            <span class="text-3xl font-black mr-1" id="staff-stock">0.0</span>
                            <span class="text-gray-400 text-xs font-bold">u</span>
                        </div>
                    </div>
                    <button onclick="window.requestWeight()" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold py-2 px-3 rounded-xl shadow-md transition active:scale-95 flex items-center">
                        <i data-lucide="bell" class="w-3 h-3 mr-1"></i> Request
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4 relative z-10">
                    <div>
                        <h2 class="text-blue-400 text-[10px] uppercase font-bold tracking-widest mb-1">Full Units</h2>
                        <span class="text-2xl font-black" id="staff-stock-full">0</span>
                    </div>
                    <div>
                        <h2 class="text-orange-400 text-[10px] uppercase font-bold tracking-widest mb-1">Usual Units</h2>
                        <span class="text-2xl font-black" id="staff-stock-usual">0</span>
                    </div>
                </div>
            </div>

            <!-- Terminal Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                <h2 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center justify-between">
                    <div class="flex items-center"><i data-lucide="calculator" class="w-5 h-5 mr-2 text-blue-500"></i> Record Sale</div>
                </h2>

                <!-- Source Selection -->
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">1. Inventory Source</label>
                    <select id="staff-sale-source" onchange="window.updateMasterLabels()" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-sm outline-none">
                        <option value="processed">Processed Pre-Packs</option>
                        <option value="raw">Raw Weight</option>
                    </select>
                </div>
                
                <!-- Qty Selection -->
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">2. Quantity</label>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="window.selectQty(0.5)" id="btn-qty-0.5" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">.5</button>
                        <button onclick="window.selectQty(1)" id="btn-qty-1" class="qty-btn btn-select active flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">1</button>
                        <button onclick="window.selectQty(2)" id="btn-qty-2" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">2</button>
                        <button onclick="window.selectQty(3)" id="btn-qty-3" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">3</button>
                        <button onclick="window.selectQty(4)" id="btn-qty-4" class="qty-btn btn-select flex-1 py-3 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold dark:text-white btn-interactive">4</button>
                    </div>
                </div>

                <!-- Type Selection -->
                <div class="mb-5" id="staff-type-selection">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 block">3. Weight Standard</label>
                    <div class="flex space-x-2">
                        <button onclick="window.selectType('full')" id="btn-type-full" class="type-btn btn-select active flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center btn-interactive">
                            <span class="dark:text-white">Full Weight</span>
                            <span class="text-[10px] text-gray-400 mt-1 font-normal" id="label-full-weight">(1.0 units)</span>
                        </button>
                        <button onclick="window.selectType('usual')" id="btn-type-usual" class="type-btn btn-select flex-1 py-4 rounded-xl bg-gray-50 dark:bg-gray-700 font-bold flex flex-col items-center btn-interactive">
                            <span class="dark:text-white">Usual Weight</span>
                            <span class="text-[10px] text-gray-400 mt-1 font-normal" id="label-usual-weight">(0.8 units)</span>
                        </button>
                    </div>
                </div>

                <!-- Money Collection -->
                <div class="mb-4 bg-gray-50 dark:bg-gray-900/40 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">4. Money Received</label>
                        <span class="text-xs font-bold text-gray-500" id="expected-money-hint">Expected: $100</span>
                    </div>
                    <div class="relative mb-2">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-gray-400">$</span>
                        <input type="number" id="money-input" placeholder="0.00" oninput="window.checkPriceColor()" class="w-full bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-xl py-3 pl-10 pr-4 text-2xl font-black outline-none focus:border-blue-500 dark:text-white transition">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.setQuickPrice(80)" class="flex-1 bg-orange-100 dark:bg-orange-900/40 text-orange-800 dark:text-orange-200 py-2 rounded-lg font-bold text-sm hover:bg-orange-200 btn-interactive transition shadow-sm border border-orange-200 dark:border-orange-800">$80 (Usual)</button>
                        <button onclick="window.setQuickPrice(100)" class="flex-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 py-2 rounded-lg font-bold text-sm hover:bg-green-200 btn-interactive transition shadow-sm border border-green-200 dark:border-green-800">$100 (Full)</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">Usual Standard: Red &lt;$80, Orange $80-$99, Green $100+</p>
                </div>

                <div class="flex gap-2">
                    <button onclick="window.processSale()" class="flex-[2] bg-blue-600 text-white font-black text-sm py-4 rounded-xl shadow-md hover:bg-blue-700 btn-interactive transition uppercase tracking-wide">
                        Log Sale
                    </button>
                    <button onclick="window.staffPersonalUse()" class="flex-1 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400 font-bold text-xs py-2 rounded-xl shadow-sm hover:bg-purple-200 btn-interactive transition flex flex-col items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 mb-1"></i> Use
                    </button>
                    <button onclick="window.staffExpense()" class="flex-1 bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400 font-bold text-xs py-2 rounded-xl shadow-sm hover:bg-orange-200 btn-interactive transition flex flex-col items-center justify-center">
                        <i data-lucide="fuel" class="w-4 h-4 mb-1"></i> Expense
                    </button>
                </div>
            </div>

            <!-- Stats/Logs -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2">Shift Financials</h3>
                
                <div class="grid grid-cols-3 gap-2 mb-3 text-center">
                    <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div class="text-[9px] text-gray-500 uppercase font-bold">Raw Sold</div>
                        <div class="text-sm font-bold dark:text-white" id="staff-stat-sold-raw">0</div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg border border-blue-200 dark:border-blue-800">
                        <div class="text-[9px] text-blue-600 uppercase font-bold">Full Sold</div>
                        <div class="text-sm font-bold text-blue-600 dark:text-blue-400" id="staff-stat-sold-full">0</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-2 rounded-lg border border-orange-200 dark:border-orange-800">
                        <div class="text-[9px] text-orange-600 uppercase font-bold">Usual Sold</div>
                        <div class="text-sm font-bold text-orange-600 dark:text-orange-400" id="staff-stat-sold-usual">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border border-green-200 dark:border-green-800">
                        <div class="text-[10px] text-green-700 dark:text-green-400 uppercase font-bold">Gross Cash</div>
                        <div class="text-xl font-bold text-green-600 dark:text-green-400" id="staff-stat-money">$0</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 p-3 rounded-lg border border-orange-200 dark:border-orange-800">
                        <div class="text-[10px] text-orange-700 dark:text-orange-400 uppercase font-bold">Logged Expenses</div>
                        <div class="text-xl font-bold text-orange-600 dark:text-orange-400" id="staff-stat-expenses">$0</div>
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800 mb-4 flex justify-between items-center">
                    <div class="text-[10px] text-blue-700 dark:text-blue-400 uppercase font-bold tracking-widest">Net Cash to Return</div>
                    <div class="text-2xl font-black text-blue-600 dark:text-blue-400" id="staff-stat-net">$0</div>
                </div>
                
                <div class="flex justify-between items-center mb-4 text-sm px-2">
                    <span class="font-bold text-gray-500">Personal Debt (20% Off):</span>
                    <span class="font-black text-purple-600 dark:text-purple-400" id="staff-stat-debt">$0</span>
                </div>

                <div id="staff-shortage-warning" class="hidden mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-2 rounded-lg text-xs font-bold text-center border border-red-200 dark:border-red-800">
                    Warning: Short by <span id="staff-shortage-amount">$0</span> against standard prices.
                </div>
                
                <div class="h-32 mb-4 border-b dark:border-gray-700 pb-4">
                    <canvas id="staffChart"></canvas>
                </div>

                <div id="staff-log-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar text-sm">
                    <div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>
                </div>
            </div>

        </main>
    </div>

    <!-- ADMIN UI -->
    <div id="admin-app" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900 pb-20">
        <header class="bg-gray-900 text-white p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">BOSS DASHBOARD</h1>
                <p class="text-xs text-gray-400">Weight & Revenue Manager</p>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-2xl mx-auto">
            
            <!-- Admin Navigation -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="window.switchAdminTab('storage')" id="adm-tab-storage" class="flex-1 py-2 px-1 rounded-xl font-bold text-xs sm:text-sm bg-gray-800 text-white shadow transition flex justify-center items-center"><i data-lucide="database" class="w-4 h-4 sm:mr-1"></i> <span class="hidden sm:inline">Vault</span></button>
                <button onclick="window.switchAdminTab('terminal')" id="adm-tab-terminal" class="flex-1 py-2 px-1 rounded-xl font-bold text-xs sm:text-sm bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex justify-center items-center"><i data-lucide="calculator" class="w-4 h-4 sm:mr-1"></i> <span class="hidden sm:inline">Sell</span></button>
                <button onclick="window.switchAdminTab('staff')" id="adm-tab-staff" class="flex-1 py-2 px-1 rounded-xl font-bold text-xs sm:text-sm bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition flex justify-center items-center relative">
                    <i data-lucide="users" class="w-4 h-4 sm:mr-1"></i> Team
                </button>
                <button onclick="window.switchAdminTab('transfers')" id="adm-tab-transfers" class="flex-1 py-2 px-1 rounded-xl font-bold text-xs sm:text-sm bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 transition relative flex justify-center items-center">
                    <i data-lucide="arrow-right-left" class="w-4 h-4 sm:mr-1"></i> Move
                    <div id="admin-req-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></div>
                </button>
            </div>

            <!-- TAB: MASTER STORAGE -->
            <div id="admin-view-storage" class="admin-tab-content active">
                
                <div class="bg-gradient-to-br from-gray-800 to-black rounded-3xl p-6 shadow-xl mb-6 text-white relative overflow-hidden">
                    <div class="relative z-10 flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-gray-400 text-xs uppercase tracking-widest font-bold mb-1">Master Vault Weight</h2>
                            <div class="flex items-baseline">
                                <span class="text-5xl font-black mr-2" id="admin-master-weight">0.0</span>
                                <span class="text-gray-400 font-bold">units</span>
                            </div>
                        </div>
                        <button onclick="window.adminAddWeight()" class="bg-white/10 hover:bg-white/20 p-3 rounded-full transition border border-white/20 backdrop-blur-sm btn-interactive">
                            <i data-lucide="plus" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>

                    <!-- Processing Tool -->
                    <div class="bg-white/5 border border-white/10 rounded-xl p-4 backdrop-blur-sm mt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold text-blue-300 flex items-center"><i data-lucide="layers" class="w-4 h-4 mr-2"></i> Process into Units</h3>
                        </div>
                        <div class="flex space-x-2">
                            <select id="process-type" class="w-1/3 p-2 bg-black/50 border border-gray-600 rounded-lg text-sm text-white font-bold outline-none">
                                <option value="full">Full (1.0)</option>
                                <option value="usual">Usual</option>
                            </select>
                            <input type="number" id="process-qty" placeholder="# Units" class="w-1/3 p-2 bg-black/50 border border-gray-600 rounded-lg text-sm text-white font-bold outline-none">
                            <button onclick="window.adminProcessUnits()" class="w-1/3 bg-blue-600 rounded-lg font-bold text-sm hover:bg-blue-500 btn-interactive">Make</button>
                        </div>
                    </div>
                </div>

                <!-- Processed Units Vault -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-2xl p-4 flex flex-col justify-center items-center text-center">
                        <h2 class="text-blue-800 dark:text-blue-300 text-[10px] uppercase font-bold tracking-widest mb-1">Full Units (1.0)</h2>
                        <div class="text-3xl font-black text-blue-900 dark:text-white" id="admin-stock-full">0</div>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-2xl p-4 flex flex-col justify-center items-center text-center">
                        <h2 class="text-orange-800 dark:text-orange-300 text-[10px] uppercase font-bold tracking-widest mb-1">Usual Units</h2>
                        <div class="text-3xl font-black text-orange-900 dark:text-white" id="admin-stock-usual">0</div>
                    </div>
                </div>

                <!-- Prices -->
                <div class="grid grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Price per 1.0 Unit</div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-green-400 mr-2" id="admin-price-display">$0</span>
                            <button onclick="window.adminSetVariable('pricePerUnit', 'Price per 1.0 Unit ($)')" class="text-gray-500 hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">"Usual" Ratio</div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-orange-400 mr-2" id="admin-ratio-display">0.8x</span>
                            <button onclick="window.adminSetVariable('usualRatio', 'Usual Ratio (e.g. 0.8 for 80%)')" class="text-gray-500 hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Purchase Stock Card -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 flex items-center">
                        <i data-lucide="shopping-bag" class="w-5 h-5 mr-2 text-blue-500"></i> Purchase Restock
                    </h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="window.adminPurchaseStock(3.5, 200)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">3.5 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $200</div>
                        </button>
                        <button onclick="window.adminPurchaseStock(7, 300)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">7 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $300 <span class="text-[10px] text-gray-400">(Wknd)</span></div>
                        </button>
                        <button onclick="window.adminPurchaseStock(7, 350)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">7 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $350 <span class="text-[10px] text-gray-400">(Wkday)</span></div>
                        </button>
                        <button onclick="window.adminPurchaseStock(14, 600)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">14 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $600</div>
                        </button>
                        <button onclick="window.adminPurchaseStock(28, 1100)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive text-left">
                            <div class="font-black text-lg dark:text-white">28 <span class="text-xs text-gray-500 font-bold uppercase">units</span></div>
                            <div class="text-sm text-red-500 font-bold">Cost: $1100</div>
                        </button>
                        <button onclick="window.adminPurchaseStock('custom', 0)" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl hover:border-blue-500 transition btn-interactive flex flex-col justify-center items-center text-gray-500">
                            <i data-lucide="plus-circle" class="w-6 h-6 mb-1"></i>
                            <span class="text-xs font-bold uppercase tracking-wider">Custom</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2">Financial Projection</h3>
                    
                    <div class="mb-4 flex justify-between items-center bg-red-50 dark:bg-red-900/20 p-3 rounded-xl border border-red-100 dark:border-red-800/50">
                        <span class="font-bold text-red-700 dark:text-red-400 text-sm">Total Expenses</span>
                        <span class="font-black text-lg text-red-600 dark:text-red-400" id="admin-total-expenses">-$0</span>
                    </div>

                    <div class="space-y-4">
                        <!-- Full Weight -->
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between items-center mb-2 border-b dark:border-gray-600 pb-2">
                                <div class="font-bold text-sm dark:text-gray-200">Full Weight (1.0)</div>
                                <div class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded font-bold" id="admin-units-full">0 units</div>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-gray-500">Expected Revenue:</span>
                                <span class="font-bold text-gray-800 dark:text-gray-300" id="admin-rev-full">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold dark:text-gray-300">Projected Profit:</span>
                                <span class="font-black text-green-600" id="admin-prof-full">$0</span>
                            </div>
                        </div>

                        <!-- Usual Weight -->
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between items-center mb-2 border-b dark:border-gray-600 pb-2">
                                <div class="font-bold text-sm dark:text-gray-200">Usual Weight (<span id="hint-ratio-txt">0.8</span>)</div>
                                <div class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded font-bold" id="admin-units-usual">0 units</div>
                            </div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-gray-500">Expected Revenue:</span>
                                <span class="font-bold text-gray-800 dark:text-gray-300" id="admin-rev-usual">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold dark:text-gray-300">Projected Profit:</span>
                                <span class="font-black text-orange-500" id="admin-prof-usual">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ADMIN TERMINAL -->
            <div id="admin-view-terminal" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700 space-y-6">
                    
                    <!-- Sell Raw Weight -->
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white mb-3 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide">
                            <i data-lucide="scale" class="w-4 h-4 inline mr-1 text-blue-500"></i> Sell Raw Weight
                        </h3>
                        <div class="flex space-x-2">
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">Weight</label><input type="number" step="0.1" id="adm-sell-raw-w" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white"></div>
                            <div class="w-1/2">
                                <label class="text-[10px] font-bold text-gray-500 uppercase">Money ($)</label>
                                <input type="number" id="adm-sell-raw-m" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white mb-2">
                                <div class="flex gap-1">
                                    <button onclick="document.getElementById('adm-sell-raw-m').value = masterData.pricePerUnit * masterData.usualRatio" class="flex-1 bg-orange-100 text-orange-700 text-xs py-1 rounded font-bold hover:bg-orange-200 btn-interactive border border-orange-200">Usual Base</button>
                                    <button onclick="document.getElementById('adm-sell-raw-m').value = masterData.pricePerUnit" class="flex-1 bg-green-100 text-green-700 text-xs py-1 rounded font-bold hover:bg-green-200 btn-interactive border border-green-200">Full Base</button>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.adminSellRaw()" class="w-full mt-3 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 btn-interactive transition">Record Sale</button>
                    </div>

                    <!-- Sell Processed Units -->
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white mb-3 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide">
                            <i data-lucide="package" class="w-4 h-4 inline mr-1 text-purple-500"></i> Sell Processed Units
                        </h3>
                        <select id="adm-sell-unit-type" onchange="window.updateMasterLabels()" class="w-full p-3 mb-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-sm outline-none">
                            <option value="full">Full Unit (1.0)</option>
                            <option value="usual">Usual Unit</option>
                        </select>
                        <div class="flex space-x-2">
                            <div class="w-1/2"><label class="text-[10px] font-bold text-gray-500 uppercase">Quantity</label><input type="number" id="adm-sell-unit-q" oninput="window.updateMasterLabels()" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white"></div>
                            <div class="w-1/2">
                                <label class="text-[10px] font-bold text-gray-500 uppercase">Money ($)</label>
                                <input type="number" id="adm-sell-unit-m" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white mb-2">
                                <div class="flex gap-1">
                                    <button id="adm-btn-quick-usual" onclick="document.getElementById('adm-sell-unit-m').value = (masterData.pricePerUnit * masterData.usualRatio) * (document.getElementById('adm-sell-unit-q').value || 1)" class="flex-1 bg-orange-100 text-orange-700 text-xs py-1 rounded font-bold hover:bg-orange-200 btn-interactive border border-orange-200">$80 (Usual)</button>
                                    <button id="adm-btn-quick-full" onclick="document.getElementById('adm-sell-unit-m').value = masterData.pricePerUnit * (document.getElementById('adm-sell-unit-q').value || 1)" class="flex-1 bg-green-100 text-green-700 text-xs py-1 rounded font-bold hover:bg-green-200 btn-interactive border border-green-200">$100 (Full)</button>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.adminSellUnit()" class="w-full mt-3 bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700 btn-interactive transition">Record Sale</button>
                    </div>

                    <!-- Admin Personal Use -->
                    <div>
                        <h3 class="font-bold text-gray-800 dark:text-white mb-3 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide text-red-500">
                            <i data-lucide="user" class="w-4 h-4 inline mr-1"></i> Admin Personal Use
                        </h3>
                        <div class="flex space-x-2 mb-2">
                            <input type="number" step="0.1" id="adm-use-w" placeholder="Weight to use" class="w-2/3 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white">
                            <button onclick="window.adminPersonalUse('weight')" class="w-1/3 bg-gray-800 text-white text-xs font-bold rounded-xl btn-interactive hover:bg-gray-900">Use Wgt</button>
                        </div>
                        <div class="flex space-x-2">
                            <select id="adm-use-u-type" class="w-1/3 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-xs outline-none">
                                <option value="full">Full</option>
                                <option value="usual">Usual</option>
                            </select>
                            <input type="number" id="adm-use-u" placeholder="# Units" class="w-1/3 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl font-bold dark:text-white text-center">
                            <button onclick="window.adminPersonalUse('unit')" class="w-1/3 bg-gray-800 text-white text-xs font-bold rounded-xl btn-interactive hover:bg-gray-900">Use Unit</button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2">Deducts from Master Storage without tracking revenue.</p>
                    </div>
                    
                    <!-- Admin Activity / Stats -->
                    <div class="border-t dark:border-gray-700 pt-6 mt-6">
                        <h3 class="font-bold text-gray-800 dark:text-white mb-4 border-b dark:border-gray-700 pb-2 text-sm uppercase tracking-wide">My Activity (Admin)</h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="text-[10px] text-gray-500 uppercase font-bold">Weight Sold</div>
                                <div class="text-xl font-bold dark:text-white" id="admin-stat-weight">0</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                                <div class="text-[10px] text-gray-500 uppercase font-bold">Money Collected</div>
                                <div class="text-xl font-bold text-green-600" id="admin-stat-money">$0</div>
                            </div>
                        </div>

                        <div id="admin-shortage-warning" class="hidden mb-4 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 p-2 rounded-lg text-xs font-bold text-center border border-red-200 dark:border-red-800">
                            Warning: Short by <span id="admin-shortage-amount">$0</span> against standard prices.
                        </div>

                        <div class="h-32 mb-4 border-b dark:border-gray-700 pb-4">
                            <canvas id="adminTerminalChart"></canvas>
                        </div>

                        <div id="admin-log-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar text-sm">
                            <div class="text-center text-gray-400 py-4 text-xs">No sales recorded yet.</div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB: STAFF PERFORMANCE -->
            <div id="admin-view-staff" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-4 border border-gray-100 dark:border-gray-700 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 dark:text-white text-sm uppercase tracking-wide">Team Summary</h3>
                        <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300" id="admin-active-count">0 Active</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-xl border border-gray-200 dark:border-gray-600">
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Total Expected $</div>
                            <div class="text-lg font-bold dark:text-white" id="admin-total-expected">$0</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-xl border border-green-200 dark:border-green-800">
                            <div class="text-[10px] text-green-700 dark:text-green-400 uppercase font-bold">Total Collected $</div>
                            <div class="text-lg font-bold text-green-600 dark:text-green-400" id="admin-total-collected">$0</div>
                        </div>
                    </div>
                    
                    <!-- Admin Overall Graph -->
                    <div class="border-t dark:border-gray-700 pt-4">
                        <h3 class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mb-2">Revenue Contribution</h3>
                        <div class="h-40"><canvas id="adminOverallChart"></canvas></div>
                    </div>
                </div>

                <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3 ml-1 text-sm uppercase">Staff List</h3>
                <div id="admin-staff-list" class="space-y-3 mb-6">
                    <div class="text-center py-8 text-gray-400 animate-pulse text-sm">Loading staff data...</div>
                </div>

                <!-- Pending Approvals in Staff Tab -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-3 text-sm uppercase">Pending Approvals</h3>
                    <div id="admin-pending-users" class="space-y-2 text-sm">
                        <div class="text-gray-400 italic text-xs">No pending users.</div>
                    </div>
                </div>
            </div>

            <!-- TAB: TRANSFERS -->
            <div id="admin-view-transfers" class="admin-tab-content hidden">
                
                <!-- Stock Requests -->
                <div id="admin-requests-section" class="hidden mb-6 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-200 dark:border-blue-800">
                    <h3 class="font-bold text-blue-800 dark:text-blue-300 text-xs uppercase mb-3 flex items-center tracking-wide">
                        <i data-lucide="bell" class="w-4 h-4 mr-2"></i> Weight Requests
                    </h3>
                    <div id="admin-requests-list" class="space-y-2"></div>
                </div>

                <!-- Transfer Tool -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center text-sm uppercase tracking-wide border-b dark:border-gray-700 pb-2">
                        <i data-lucide="arrow-right-left" class="w-4 h-4 mr-2 text-purple-600"></i> Move Inventory
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Staff Member</label>
                            <select id="transfer-staff-select" onchange="window.updateTransferPreview()" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none text-sm font-bold dark:text-white">
                                <option value="">Select Staff...</option>
                            </select>
                            <div id="transfer-preview" class="text-xs text-blue-600 dark:text-blue-400 mt-1 ml-1 h-4 font-medium"></div>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Item to Move</label>
                            <select id="transfer-item-type" onchange="window.updateTransferPreview()" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none text-sm font-bold dark:text-white">
                                <option value="raw">Raw Weight</option>
                                <option value="full">Full Units (1.0)</option>
                                <option value="usual">Usual Units</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Amount to Send/Reclaim</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="number" step="0.1" id="transfer-amount" placeholder="0.0" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl outline-none font-black text-lg dark:text-white">
                            </div>
                            <div class="flex space-x-2 mt-2">
                                <button onclick="window.adminTransferWeight('send')" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition flex justify-center items-center"><i data-lucide="arrow-up-right" class="w-4 h-4 mr-1"></i> Send</button>
                                <button onclick="window.adminTransferWeight('reclaim')" class="flex-1 bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-orange-600 active:scale-95 transition flex justify-center items-center"><i data-lucide="arrow-down-left" class="w-4 h-4 mr-1"></i> Reclaim</button>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-2">* Adjusts Master Vault and Staff's inventory.</p>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- User Detail Modal (Admin) -->
    <div id="admin-user-detail" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 overflow-y-auto hidden">
        <div class="bg-white dark:bg-gray-800 p-4 sticky top-0 shadow-md flex justify-between items-center z-10">
            <button onclick="document.getElementById('admin-user-detail').classList.add('hidden')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <h2 class="font-bold text-lg dark:text-white" id="detail-user-name">Staff Details</h2>
            <div class="w-9"></div>
        </div>
        <div class="p-4 max-w-2xl mx-auto space-y-4">
            
            <div class="bg-gray-800 text-white p-4 rounded-2xl shadow-sm mb-2">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-2 border-b border-gray-700 pb-1">Holding Inventory</div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><div class="text-[10px] text-gray-400 uppercase">Raw Weight</div><div class="text-xl font-black" id="det-holding-raw">0</div></div>
                    <div><div class="text-[10px] text-blue-400 uppercase">Full Units</div><div class="text-xl font-black" id="det-holding-full">0</div></div>
                    <div><div class="text-[10px] text-orange-400 uppercase">Usual Units</div><div class="text-xl font-black" id="det-holding-usual">0</div></div>
                </div>
            </div>

            <div class="bg-gray-800 text-white p-4 rounded-2xl shadow-sm mb-4">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-2 border-b border-gray-700 pb-1">Total Sold Items</div>
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><div class="text-[10px] text-gray-400 uppercase">Raw Sold</div><div class="text-xl font-black" id="det-sold-raw">0</div></div>
                    <div><div class="text-[10px] text-blue-400 uppercase">Full Sold</div><div class="text-xl font-black" id="det-sold-full">0</div></div>
                    <div><div class="text-[10px] text-orange-400 uppercase">Usual Sold</div><div class="text-xl font-black" id="det-sold-usual">0</div></div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-4 border-b dark:border-gray-700 pb-2">Revenue Analysis</h3>
                
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold dark:text-gray-300">Total Expected Value</span>
                    <span class="text-lg font-bold dark:text-white" id="det-expected">$0</span>
                </div>
                <div class="flex justify-between items-center mb-2 text-xs text-purple-600 dark:text-purple-400">
                    <span class="font-bold flex items-center"><i data-lucide="user" class="w-3 h-3 mr-1"></i> Personal Debt (Incl. above)</span>
                    <span class="font-bold" id="det-personal-owed">$0</span>
                </div>
                
                <div class="border-t border-gray-100 dark:border-gray-700 my-3"></div>
                
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold dark:text-gray-300">Gross Cash Collected</span>
                    <span class="text-lg font-bold text-green-600" id="det-collected">$0</span>
                </div>
                <div class="flex justify-between items-center mb-4 text-xs text-orange-600 dark:text-orange-400">
                    <span class="font-bold flex items-center"><i data-lucide="fuel" class="w-3 h-3 mr-1"></i> Logged Expenses</span>
                    <span class="font-bold" id="det-expenses">-$0</span>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg flex justify-between items-center font-bold border border-blue-200 dark:border-blue-800 mb-3">
                    <span class="text-sm text-blue-800 dark:text-blue-300 uppercase tracking-wide">Net Cash In Hand</span>
                    <span class="text-xl text-blue-600 dark:text-blue-400" id="det-net-cash">$0</span>
                </div>

                <div id="det-diff-box" class="p-3 rounded-lg flex justify-between items-center font-bold mb-4">
                    <span class="text-sm uppercase tracking-wide">Shortage / Difference</span>
                    <span class="text-xl" id="det-diff">$0</span>
                </div>
                
                <h3 class="text-xs text-gray-500 uppercase font-bold tracking-widest mb-2 border-b dark:border-gray-700 pb-2">Recent Sales</h3>
                <div class="h-32">
                    <canvas id="adminDetailChart"></canvas>
                </div>
            </div>

            <!-- Danger / Clear -->
            <button onclick="window.adminClearStaffData()" class="w-full mt-4 bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400 font-bold py-3 rounded-xl border border-red-200 dark:border-red-800/50 btn-interactive">
                Clear Staff Balances (Reset to 0)
            </button>
            <p class="text-center text-[10px] text-gray-500">Use this after collecting money and zeroing out their stock.</p>

        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, updateDoc, increment, addDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // ---------------------------------------------------------
        // FIREBASE CONFIGURATION
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDz4iG5KZy3JAxBhubaGEaMKTY7jcObRDE",
            authDomain: "deals-bcfea.firebaseapp.com",
            projectId: "deals-bcfea",
            storageBucket: "deals-bcfea.firebasestorage.app",
            messagingSenderId: "686014043249",
            appId: "1:686014043249:web:8dcc93549cdb265269b7d0"
        };
        const appId = "weight-tracker-v2"; 
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app); 
        const googleProvider = new GoogleAuthProvider();

        // ---------------------------------------------------------
        // GLOBAL STATE
        // ---------------------------------------------------------
        let currentUser = null; 
        let userRole = 'staff'; 
        
        // Staff State
        let appData = { weight: 0, unitsFull: 0, unitsUsual: 0, soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, transactions: [] };
        let currentQty = 1;
        let currentType = 'full';

        // Admin State
        let masterData = { rawWeight: 0, unitsFull: 0, unitsUsual: 0, pricePerUnit: 100, usualRatio: 0.8, totalExpenses: 0 };
        let adminData = { soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, transactions: [] };
        let globalRoster = []; 
        let currentDetailUid = null;

        // Chart Instances
        let staffChartInst = null;
        let adminOverallChartInst = null;
        let adminDetailChartInst = null;
        let adminTerminalChartInst = null;

        // Chart Default Styling
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        // Listeners
        let unsubUserData, unsubRoster, unsubMaster, unsubReqs, unsubAuthCheck;

        // ---------------------------------------------------------
        // UTILS
        // ---------------------------------------------------------
        window.showToast = (msg) => { 
            const t = document.getElementById('toast'); 
            t.innerText = msg; 
            t.className = "show"; 
            setTimeout(() => t.className = "", 3000); 
        };
        
        window.toggleTheme = () => { 
            document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
        };

        // ---------------------------------------------------------
        // AUTH LOGIC
        // ---------------------------------------------------------
        window.handleGoogleLogin = async () => { 
            try { 
                const res = await signInWithPopup(auth, googleProvider);
                const profRef = doc(db, 'artifacts', appId, 'users', res.user.uid, 'settings', 'profile');
                const snap = await getDoc(profRef);
                
                // If New User -> Auto assign pending staff
                if(!snap.exists()) {
                    await setDoc(profRef, { name: res.user.displayName, email: res.user.email, role: 'staff', status: 'pending', createdAt: Date.now() });
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', res.user.uid), { name: res.user.displayName, role: 'staff', status: 'pending', uid: res.user.uid }, {merge:true});
                }
            } catch (e) { 
                console.error("Auth Error:", e);
                window.showToast("Login Failed: " + e.message); 
            }
        };

        window.logout = async () => { 
            if(unsubUserData) unsubUserData(); if(unsubRoster) unsubRoster(); if(unsubMaster) unsubMaster(); if(unsubAuthCheck) unsubAuthCheck();
            
            document.getElementById('staff-app').classList.add('hidden');
            document.getElementById('admin-app').classList.add('hidden');
            document.getElementById('approval-modal').classList.add('hidden');
            
            await signOut(auth); 
            window.location.reload(); 
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', user.uid);
                
                unsubAuthCheck = onSnapshot(rosterRef, (snap) => {
                    const data = snap.data() || {};
                    const role = data.role || 'staff';
                    const status = data.status || 'pending';
                    userRole = role;
                    
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('login-modal').classList.add('hidden');

                    if (role === 'admin') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        document.getElementById('staff-app').classList.add('hidden');
                        initAdminDashboard(user);
                    } else if (status === 'active') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        document.getElementById('admin-app').classList.add('hidden');
                        initStaffApp(user);
                    } else {
                        // Pending or Suspended
                        document.getElementById('approval-modal').classList.remove('hidden');
                        document.getElementById('staff-app').classList.add('hidden');
                        document.getElementById('admin-app').classList.add('hidden');
                        
                        const title = document.getElementById('approval-title');
                        const msg = document.getElementById('approval-msg');
                        if(status === 'suspended') {
                            title.innerText = "Account Suspended";
                            msg.innerText = "Your access has been restricted by management.";
                        } else {
                            title.innerText = "Access Pending";
                            msg.innerText = "Waiting for Admin to approve your account.";
                        }
                    }
                }, (error) => {
                    console.error("Roster Access Denied:", error);
                    document.getElementById('loading-overlay').classList.add('hidden');
                    window.showToast("Permission denied. Check Firebase Rules.");
                });

                // Always listen to master data for calculations
                unsubMaster = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), (s) => {
                    if(s.exists()) {
                        masterData = { rawWeight: 0, unitsFull: 0, unitsUsual: 0, pricePerUnit: 100, usualRatio: 0.8, totalExpenses: 0, ...s.data() };
                        updateMasterLabels();
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master'), masterData).catch(e => console.log(e));
                    }
                });

            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });

        function updateMasterLabels() {
            // Staff Pricing Labels
            const labelFull = document.getElementById('label-full-weight');
            const labelUsual = document.getElementById('label-usual-weight');
            const expHint = document.getElementById('expected-money-hint');
            
            if(labelFull) labelFull.innerText = `(${(currentQty * 1.0).toFixed(1)} units)`;
            if(labelUsual) labelUsual.innerText = `(${(currentQty * masterData.usualRatio).toFixed(1)} units)`;
            
            // Dynamic Expected Calculation
            const source = document.getElementById('staff-sale-source') ? document.getElementById('staff-sale-source').value : 'raw';
            const effectiveType = source === 'raw' ? currentType : source;
            const unitPrice = effectiveType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            
            if(expHint) expHint.innerText = `Expected: $${currentQty * unitPrice}`;

            // Sync Buttons
            const btnUsual = document.getElementById('btn-quick-usual');
            const btnFull = document.getElementById('btn-quick-full');
            if(btnUsual) btnUsual.innerText = `$${masterData.pricePerUnit * masterData.usualRatio} (Usual)`;
            if(btnFull) btnFull.innerText = `$${masterData.pricePerUnit} (Full)`;

            const admBtnUsual = document.getElementById('adm-btn-quick-usual');
            const admBtnFull = document.getElementById('adm-btn-quick-full');
            if(admBtnUsual) admBtnUsual.innerText = `$${masterData.pricePerUnit * masterData.usualRatio} (Usual)`;
            if(admBtnFull) admBtnFull.innerText = `$${masterData.pricePerUnit} (Full)`;

            // Admin Display Updates
            const wRaw = document.getElementById('admin-master-weight');
            const pDisp = document.getElementById('admin-price-display');
            const rDisp = document.getElementById('admin-ratio-display');
            
            const expDisp = document.getElementById('admin-total-expenses');
            const uFull = document.getElementById('admin-units-full');
            const rFull = document.getElementById('admin-rev-full');
            const pFull = document.getElementById('admin-prof-full');
            const uUsual = document.getElementById('admin-units-usual');
            const rUsual = document.getElementById('admin-rev-usual');
            const pUsual = document.getElementById('admin-prof-usual');
            const hRat = document.getElementById('hint-ratio-txt');

            const stockFull = document.getElementById('admin-stock-full');
            const stockUsual = document.getElementById('admin-stock-usual');

            const rawW = masterData.rawWeight || 0;
            const price = masterData.pricePerUnit || 0;
            const ratio = masterData.usualRatio || 1;
            const expenses = masterData.totalExpenses || 0;

            if(wRaw) wRaw.innerText = rawW.toFixed(1);
            if(pDisp) pDisp.innerText = `$${price}`;
            if(rDisp) rDisp.innerText = `${ratio}x`;
            if(expDisp) expDisp.innerText = `-$${expenses}`;
            
            if(stockFull) stockFull.innerText = masterData.unitsFull || 0;
            if(stockUsual) stockUsual.innerText = masterData.unitsUsual || 0;
            
            // Calculate potential value and units
            const fullUnits = Math.floor(rawW / 1.0);
            const usualUnits = Math.floor(rawW / ratio);
            
            const fullRev = fullUnits * price;
            const usualRev = usualUnits * price;
            
            const fullProfit = fullRev - expenses;
            const usualProfit = usualRev - expenses;

            if(uFull) uFull.innerText = `${fullUnits} units`;
            if(rFull) rFull.innerText = `$${fullRev.toLocaleString()}`;
            if(pFull) {
                pFull.innerText = `${fullProfit >= 0 ? '+' : '-'}$${Math.abs(fullProfit).toLocaleString()}`;
                pFull.className = `font-black ${fullProfit >= 0 ? 'text-green-600' : 'text-red-500'}`;
            }

            if(uUsual) uUsual.innerText = `${usualUnits} units`;
            if(rUsual) rUsual.innerText = `$${usualRev.toLocaleString()}`;
            if(pUsual) {
                pUsual.innerText = `${usualProfit >= 0 ? '+' : '-'}$${Math.abs(usualProfit).toLocaleString()}`;
                pUsual.className = `font-black ${usualProfit >= 0 ? 'text-orange-500' : 'text-red-500'}`;
            }
            
            if(hRat) hRat.innerText = ratio;
        }

        // ---------------------------------------------------------
        // STAFF TERMINAL LOGIC
        // ---------------------------------------------------------
        function initStaffApp(user) {
            document.getElementById('staff-app').classList.remove('hidden');
            document.getElementById('staff-name-display').innerText = user.displayName || user.email;

            unsubUserData = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state'), (snap) => { 
                if(snap.exists()) { 
                    const d = JSON.parse(snap.data().json);
                    appData = { weight: 0, unitsFull: 0, unitsUsual: 0, soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, personalUseOwed: 0, collected: 0, expected: 0, expenses: 0, transactions: [], ...d };
                    renderStaffUI(); 
                } else { saveStaffData(); } 
            });
        }

        function renderStaffUI() {
            // Stock
            document.getElementById('staff-stock').innerText = (appData.weight || 0).toFixed(1);
            document.getElementById('staff-stock-full').innerText = (appData.unitsFull || 0);
            document.getElementById('staff-stock-usual').innerText = (appData.unitsUsual || 0);
            
            // Stats Breakdown
            document.getElementById('staff-stat-sold-raw').innerText = (appData.soldWeight || 0).toFixed(1);
            document.getElementById('staff-stat-sold-full').innerText = (appData.soldUnitsFull || 0);
            document.getElementById('staff-stat-sold-usual').innerText = (appData.soldUnitsUsual || 0);
            
            document.getElementById('staff-stat-money').innerText = `$${appData.collected || 0}`;
            document.getElementById('staff-stat-expenses').innerText = `-$${appData.expenses || 0}`;
            
            const netCash = (appData.collected || 0) - (appData.expenses || 0);
            document.getElementById('staff-stat-net').innerText = `$${netCash}`;
            document.getElementById('staff-stat-debt').innerText = `$${appData.personalUseOwed || 0}`;
            
            // Shortage checking (Expected includes the discounted personal debt)
            const diff = (appData.expected || 0) - (appData.collected || 0);
            const warn = document.getElementById('staff-shortage-warning');
            if(diff > 0) {
                warn.classList.remove('hidden');
                document.getElementById('staff-shortage-amount').innerText = `$${diff}`;
            } else {
                warn.classList.add('hidden');
            }

            // Update Staff Chart
            updateStaffChart(appData.transactions);

            const list = document.getElementById('staff-log-list');
            list.innerHTML = '';
            
            const reversed = [...appData.transactions].reverse();
            reversed.forEach(t => {
                if(t.type === 'personal') {
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-2 border border-purple-100 dark:border-purple-800">
                        <div>
                            <div class="font-bold text-purple-800 dark:text-purple-300"><i data-lucide="user" class="inline w-3 h-3 mr-1"></i> Personal Debt</div>
                            <div class="text-xs text-gray-500">${t.time}  20% Discount Logged</div>
                        </div>
                        <div class="text-right"><div class="font-black text-purple-600 dark:text-purple-400">+$${t.expected} Owed</div></div>
                    </div>`;
                } else if(t.type === 'expense') {
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded-xl mb-2 border border-orange-100 dark:border-orange-800">
                        <div>
                            <div class="font-bold text-orange-800 dark:text-orange-300"><i data-lucide="fuel" class="inline w-3 h-3 mr-1"></i> Expense: ${t.desc}</div>
                            <div class="text-xs text-gray-500">${t.time}</div>
                        </div>
                        <div class="text-right"><div class="font-black text-orange-600 dark:text-orange-400">-$${Math.abs(t.money)}</div></div>
                    </div>`;
                } else {
                    const color = t.type === 'full' ? 'text-green-600' : (t.type === 'usual' ? 'text-orange-500' : 'text-blue-500');
                    const label = t.type === 'full' ? 'Full' : (t.type === 'raw' ? 'Raw' : 'Usual');
                    list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-xl mb-2 border border-gray-200 dark:border-gray-600">
                        <div>
                            <div class="font-bold dark:text-white">Sold ${t.qty} <span class="text-[10px] ${color} uppercase tracking-wider ml-1">(${label})</span></div>
                            <div class="text-xs text-gray-500">${t.time}  Used: ${t.actualWeight.toFixed(1)} u</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-green-600">+$${t.money}</div>
                        </div>
                    </div>`;
                }
            });
            if(reversed.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>';
            lucide.createIcons();
        }

        function updateStaffChart(transactions) {
            const ctx = document.getElementById('staffChart');
            if(!ctx) return;
            
            const sales = transactions.filter(t => t.type !== 'personal' && t.type !== 'expense').reverse(); 
            const labels = sales.map(t => t.time);
            const data = sales.map(t => t.money);

            if(staffChartInst) staffChartInst.destroy();
            staffChartInst = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sale ($)',
                        data: data,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function saveStaffData() { 
            if(!currentUser) return; 
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state'), { json: JSON.stringify(appData), lastUpdated: Date.now() }); 
            
            // Sync summary to public roster
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid), { 
                    weight: appData.weight,
                    unitsFull: appData.unitsFull || 0,
                    unitsUsual: appData.unitsUsual || 0,
                    soldWeight: appData.soldWeight,
                    soldUnitsFull: appData.soldUnitsFull || 0,
                    soldUnitsUsual: appData.soldUnitsUsual || 0,
                    personalUseWeight: appData.personalUseWeight || 0,
                    personalUseOwed: appData.personalUseOwed || 0,
                    collected: appData.collected,
                    expected: appData.expected,
                    expenses: appData.expenses || 0,
                    recentLogs: appData.transactions.slice(-10).reverse(), 
                    lastSync: Date.now() 
                }, { merge: true }); 
            } catch(e){} 
        }

        // Terminal Actions
        window.checkPriceColor = () => {
            const input = document.getElementById('money-input');
            const val = parseFloat(input.value) || 0;
            const perUnit = val / currentQty;
            
            input.classList.remove('text-gray-400', 'text-red-500', 'text-orange-500', 'text-green-500', 'dark:text-white', 'dark:text-red-500', 'dark:text-orange-500', 'dark:text-green-500');

            if (val === 0) {
                input.classList.add('dark:text-white', 'text-gray-800');
                return;
            }

            if (currentType === 'usual') {
                if (perUnit < 80) input.classList.add('text-red-500', 'dark:text-red-500');
                else if (perUnit < 100) input.classList.add('text-orange-500', 'dark:text-orange-500');
                else input.classList.add('text-green-500', 'dark:text-green-500');
            } else {
                if (perUnit < 100) input.classList.add('text-red-500', 'dark:text-red-500');
                else input.classList.add('text-green-500', 'dark:text-green-500');
            }
        };

        window.setQuickPrice = (pricePerUnit) => {
            const input = document.getElementById('money-input');
            input.value = pricePerUnit * currentQty;
            window.checkPriceColor();
        };

        window.selectQty = (q) => {
            currentQty = q;
            document.querySelectorAll('.qty-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-qty-${q}`).classList.add('active');
            window.updateMasterLabels();
            window.checkPriceColor();
        };

        window.selectType = (t) => {
            currentType = t;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-type-${t}`).classList.add('active');
            window.updateMasterLabels();
            window.checkPriceColor();
        };

        window.processSale = async () => {
            const source = document.getElementById('staff-sale-source').value;
            const moneyInput = document.getElementById('money-input');
            const money = parseFloat(moneyInput.value);
            if(isNaN(money) || money < 0) return window.showToast("Enter valid money received");

            let actualWeightDeducted = 0;
            const effectiveType = source === 'raw' ? currentType : source;
            const unitPrice = effectiveType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);

            if (source === 'raw') {
                actualWeightDeducted = currentType === 'full' ? currentQty * 1.0 : currentQty * masterData.usualRatio;
                if(appData.weight < actualWeightDeducted) return window.showToast(`Not enough raw weight! Need ${actualWeightDeducted.toFixed(1)}`);
                appData.weight -= actualWeightDeducted;
            } else if (source === 'full') {
                if(appData.unitsFull < currentQty) return window.showToast("Not enough Full Pre-Packs!");
                appData.unitsFull -= currentQty;
                actualWeightDeducted = currentQty * 1.0;
            } else if (source === 'usual') {
                if(appData.unitsUsual < currentQty) return window.showToast("Not enough Usual Pre-Packs!");
                appData.unitsUsual -= currentQty;
                actualWeightDeducted = currentQty * masterData.usualRatio;
            }

            const expectedMoney = currentQty * unitPrice;

            if (source === 'raw') {
                appData.soldWeight += actualWeightDeducted;
            } else if (source === 'processed' && currentType === 'full') {
                appData.soldUnitsFull += currentQty;
            } else if (source === 'processed' && currentType === 'usual') {
                appData.soldUnitsUsual += currentQty;
            }

            appData.collected += money;
            appData.expected += expectedMoney;

            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: currentQty,
                type: effectiveType,
                actualWeight: actualWeightDeducted,
                money: money,
                expected: expectedMoney
            });

            moneyInput.value = '';
            await saveStaffData();
            window.showToast("Sale Complete!");
        };

        window.staffPersonalUse = async () => {
            const source = document.getElementById('staff-sale-source').value;
            const effectiveType = source === 'raw' ? currentType : source;
            const unitPrice = effectiveType === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            
            if(!confirm(`Log Personal Use for ${currentQty} units from ${source.toUpperCase()} inventory?\n\nYou will be charged the standard price at a 20% discount.`)) return;

            let actualWeightDeducted = 0;
            let standardCost = currentQty * unitPrice;

            if (source === 'raw') {
                actualWeightDeducted = effectiveType === 'full' ? currentQty * 1.0 : currentQty * masterData.usualRatio;
                if(appData.weight < actualWeightDeducted) return window.showToast("Not enough raw weight!");
                appData.weight -= actualWeightDeducted;
            } else if (source === 'full') {
                if(appData.unitsFull < currentQty) return window.showToast("Not enough Full Pre-Packs!");
                appData.unitsFull -= currentQty;
                actualWeightDeducted = currentQty * 1.0;
            } else if (source === 'usual') {
                if(appData.unitsUsual < currentQty) return window.showToast("Not enough Usual Pre-Packs!");
                appData.unitsUsual -= currentQty;
                actualWeightDeducted = currentQty * masterData.usualRatio;
            }

            const discountedDebt = standardCost * 0.8;
            appData.personalUseWeight = (appData.personalUseWeight || 0) + actualWeightDeducted;
            appData.expected += discountedDebt;
            appData.personalUseOwed = (appData.personalUseOwed || 0) + discountedDebt;
            
            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: currentQty,
                type: 'personal',
                actualWeight: actualWeightDeducted,
                money: 0,
                expected: discountedDebt
            });
            
            await saveStaffData();
            window.showToast("Personal Use Logged.");
        };

        window.staffExpense = async () => {
            const desc = prompt("What is this expense for? (e.g., Gas, Food)");
            if(!desc) return;
            const amt = parseFloat(prompt(`How much did you spend on ${desc}? ($)`));
            if(isNaN(amt) || amt <= 0) return;
            
            appData.expenses = (appData.expenses || 0) + amt;
            appData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: 0, type: 'expense', actualWeight: 0, money: -amt, expected: 0, desc: desc
            });
            await saveStaffData();
            window.showToast("Expense Logged.");
        };

        window.requestWeight = async () => { 
            if(confirm("Notify admin you need more weight?")) { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), { 
                    uid: currentUser.uid, name: currentUser.displayName || 'Staff', timestamp: Date.now(), status: 'pending' 
                }); 
                window.showToast("Request Sent"); 
            } 
        };

        // ---------------------------------------------------------
        // ADMIN LOGIC
        // ---------------------------------------------------------
        window.switchAdminTab = (t) => { 
            ['storage','terminal','staff','transfers'].forEach(x => { 
                document.getElementById(`admin-view-${x}`).classList.add('hidden'); 
                document.getElementById(`adm-tab-${x}`).classList.remove('bg-gray-800','text-white','shadow'); 
                document.getElementById(`adm-tab-${x}`).classList.add('bg-white','dark:bg-gray-800','text-gray-600','dark:text-gray-300');
            }); 
            document.getElementById(`admin-view-${t}`).classList.remove('hidden'); 
            document.getElementById(`adm-tab-${t}`).classList.add('bg-gray-800','text-white','shadow'); 
            document.getElementById(`adm-tab-${t}`).classList.remove('bg-white','dark:bg-gray-800','text-gray-600','dark:text-gray-300');
        };

        function initAdminDashboard(user) {
            document.getElementById('admin-app').classList.remove('hidden');
            
            // Listen to Admin's own state
            unsubUserData = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state'), (snap) => { 
                if(snap.exists()) { 
                    const d = JSON.parse(snap.data().json);
                    adminData = { soldWeight: 0, soldUnitsFull: 0, soldUnitsUsual: 0, personalUseWeight: 0, collected: 0, expected: 0, transactions: [], ...d };
                    renderAdminTerminalUI(); 
                } else { saveAdminData(); } 
            });

            // Show admin settings in modal
            const adminSet = document.getElementById('admin-settings-section');
            if(adminSet) adminSet.classList.remove('hidden');

            unsubRoster = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'roster'), (snap) => {
                const list = document.getElementById('admin-staff-list'); 
                const select = document.getElementById('transfer-staff-select');
                const pendingList = document.getElementById('admin-pending-users');
                const staffTab = document.getElementById('adm-tab-staff');
                
                list.innerHTML=''; select.innerHTML='<option value="">Select Staff...</option>'; pendingList.innerHTML='';
                globalRoster=[]; 
                
                let totExp = 0, totCol = 0, activeCount = 0, pendCount = 0;

                snap.forEach(d => {
                    const u = { id: d.id, ...d.data() }; 
                    globalRoster.push(u);
                    
                    if(u.status === 'pending') {
                        if (u.role !== 'admin') {
                            pendCount++;
                            pendingList.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-orange-50 dark:bg-orange-900/20 rounded border border-orange-100 dark:border-orange-800">
                                <span class="font-bold text-orange-800 dark:text-orange-300">${u.name}</span>
                                <div><button onclick="window.adminSetStatus('${u.id}', 'active')" class="bg-green-500 text-white text-xs px-3 py-1 rounded font-bold mr-1 hover:bg-green-600 btn-interactive">Approve</button>
                                <button onclick="window.adminDelUser('${u.id}')" class="text-red-500 text-xs px-2 hover:underline">Deny</button></div>
                            </div>`;
                        }
                    } else {
                        activeCount++;
                        totExp += (u.expected || 0);
                        totCol += (u.collected || 0);
                        
                        const diff = (u.expected || 0) - (u.collected || 0);
                        const diffColor = diff > 0 ? 'text-red-500 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50' : (diff < 0 ? 'text-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'text-gray-500 bg-gray-50 dark:bg-gray-800');
                        const diffSign = diff > 0 ? `-$${diff}` : (diff < 0 ? `+$${Math.abs(diff)}` : '$0');

                        const badge = u.role === 'admin' ? '<span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full ml-2">ADMIN</span>' : '';

                        list.innerHTML += `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-blue-400 transition" onclick="window.viewDriverDetails('${u.id}')">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-bold dark:text-white flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs mr-2 border border-blue-200">${u.name[0]}</div>
                                    ${u.name} ${badge}
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-500">${u.role === 'admin' ? 'Total Sold' : 'Holding'}</div>
                                    <div class="font-black dark:text-white">${u.role === 'admin' ? (u.soldWeight||0).toFixed(1) : (u.weight||0).toFixed(1)} u</div>
                                </div>
                            </div>
                            <div class="flex justify-between items-end border-t dark:border-gray-700 pt-2">
                                <div class="text-xs text-gray-500">
                                    Exp: <span class="font-bold text-gray-800 dark:text-gray-300">$${u.expected||0}</span><br>
                                    Col: <span class="font-bold text-green-600">$${u.collected||0}</span>
                                </div>
                                <div class="text-xs font-bold px-2 py-1 rounded ${diffColor}">
                                    Diff: ${diffSign}
                                </div>
                            </div>
                        </div>`;
                        
                        // Populate transfer select (Don't let admin transfer to themselves via this tool)
                        if (u.role !== 'admin') {
                            const opt = document.createElement('option'); opt.value=u.id; opt.innerText=`${u.name} (${(u.weight||0).toFixed(1)} u)`; 
                            select.appendChild(opt); 
                        }
                    }
                });
                
                document.getElementById('admin-active-count').innerText = `${activeCount} Active`;
                document.getElementById('admin-total-expected').innerText = `$${totExp}`;
                document.getElementById('admin-total-collected').innerText = `$${totCol}`;
                
                // Update Admin Overall Chart
                updateAdminOverallChart(globalRoster);
                
                if(pendCount === 0) {
                    pendingList.innerHTML = '<div class="text-gray-400 italic text-xs">No pending users.</div>';
                    staffTab.innerHTML = `<i data-lucide="users" class="w-4 h-4 sm:mr-1"></i> <span class="hidden sm:inline">Team</span>`;
                } else {
                    staffTab.innerHTML = `<i data-lucide="users" class="w-4 h-4 sm:mr-1"></i> <span class="hidden sm:inline">Team</span> <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">${pendCount}</span>`;
                }
                lucide.createIcons();
            });

            unsubReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                const section = document.getElementById('admin-requests-section'); 
                const list = document.getElementById('admin-requests-list'); 
                list.innerHTML = ''; let count = 0;
                snap.forEach(d => { 
                    const req = d.data(); 
                    if(req.status === 'pending') { 
                        count++; 
                        list.innerHTML += `<div class="bg-white dark:bg-gray-800 p-2 rounded-lg flex justify-between items-center text-sm shadow-sm"><span class="font-bold dark:text-white">${req.name} <span class="text-xs font-normal text-gray-500 ml-2">Needs weight</span></span><div class="space-x-1"><button onclick="window.fulfillReq('${d.id}', '${req.uid}')" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded font-bold hover:bg-blue-700 btn-interactive">Fulfill</button><button onclick="window.dismissReq('${d.id}')" class="text-gray-400 text-xs px-2 hover:text-gray-600">Dismiss</button></div></div>`; 
                    }
                });
                if(count > 0) {
                    section.classList.remove('hidden');
                    document.getElementById('admin-req-badge').classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                    document.getElementById('admin-req-badge').classList.add('hidden');
                }
            });
        }

        function updateAdminOverallChart(roster) {
            const ctx = document.getElementById('adminOverallChart');
            if(!ctx) return;
            
            const activeStaff = roster.filter(u => u.status === 'active' || u.role === 'admin');
            const labels = activeStaff.map(u => u.role === 'admin' ? `${u.name} (Admin)` : u.name);
            const data = activeStaff.map(u => u.collected || 0);

            if(adminOverallChartInst) adminOverallChartInst.destroy();
            adminOverallChartInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Collected ($)',
                        data: data,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Admin Master Controls
        window.adminAddWeight = async () => { 
            const q = prompt("Add weight to Master Vault (Units):"); 
            if(q && !isNaN(q)) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{rawWeight:increment(parseFloat(q))},{merge:true}); 
        };

        window.adminPurchaseStock = async (weight, cost) => {
            if (weight === 'custom') {
                weight = parseFloat(prompt("Enter custom weight amount (units):"));
                if (isNaN(weight) || weight <= 0) return;
                cost = parseFloat(prompt("Enter total cost of purchase ($):"));
                if (isNaN(cost) || cost < 0) return;
            }
            if(!confirm(`Confirm Purchase: Add ${weight} units for $${cost}?`)) return;
            
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{
                rawWeight: increment(weight),
                totalExpenses: increment(cost)
            }, {merge:true});
            
            window.showToast(`Restocked ${weight} units for $${cost}.`);
        };

        window.adminSetVariable = async (field, label) => {
            const v = prompt(`Set ${label}:`, masterData[field]);
            if(v && !isNaN(v)) await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[field]: parseFloat(v)},{merge:true});
        };

        window.adminProcessUnits = async () => {
            const type = document.getElementById('process-type').value;
            const qty = parseInt(document.getElementById('process-qty').value);
            
            if(isNaN(qty) || qty <= 0) return window.showToast("Enter valid quantity");
            
            const wpu = type === 'full' ? 1.0 : masterData.usualRatio;
            const totalW = qty * wpu;
            
            if(masterData.rawWeight < totalW) return window.showToast("Not enough raw weight in vault!");

            const updateData = { rawWeight: increment(-totalW) };
            if (type === 'full') updateData.unitsFull = increment(qty);
            else updateData.unitsUsual = increment(qty);

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), updateData, {merge:true});
            
            document.getElementById('process-qty').value = '';
            window.showToast(`Processed ${qty} ${type} units.`);
        };

        async function saveAdminData() { 
            if(!currentUser) return; 
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state'), { json: JSON.stringify(adminData), lastUpdated: Date.now() }); 
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid), { 
                    soldWeight: adminData.soldWeight,
                    soldUnitsFull: adminData.soldUnitsFull || 0,
                    soldUnitsUsual: adminData.soldUnitsUsual || 0,
                    personalUseWeight: adminData.personalUseWeight || 0,
                    collected: adminData.collected,
                    expected: adminData.expected,
                    recentLogs: adminData.transactions.slice(-10).reverse(),
                    lastSync: Date.now() 
                }, { merge: true }); 
            } catch(e){} 
        }

        function renderAdminTerminalUI() {
            document.getElementById('admin-stat-weight').innerText = (adminData.soldWeight || 0).toFixed(1);
            document.getElementById('admin-stat-money').innerText = `$${adminData.collected || 0}`;
            
            const diff = (adminData.expected || 0) - (adminData.collected || 0);
            const warn = document.getElementById('admin-shortage-warning');
            if(diff > 0) {
                warn.classList.remove('hidden');
                document.getElementById('admin-shortage-amount').innerText = `$${diff}`;
            } else {
                warn.classList.add('hidden');
            }

            // Chart
            const ctx = document.getElementById('adminTerminalChart');
            if(ctx) {
                const sales = adminData.transactions.filter(t => t.type !== 'personal').reverse(); 
                const labels = sales.map(t => t.time);
                const data = sales.map(t => t.money);

                if(adminTerminalChartInst) adminTerminalChartInst.destroy();
                adminTerminalChartInst = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sale ($)',
                            data: data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2, fill: true, tension: 0.3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            // Logs
            const list = document.getElementById('admin-log-list');
            list.innerHTML = '';
            const reversed = [...adminData.transactions].reverse();
            reversed.forEach(t => {
                if(t.type === 'personal') {
                    list.innerHTML += `<div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl mb-2 border border-purple-100 dark:border-purple-800"><div><div class="font-bold text-purple-800 dark:text-purple-300"><i data-lucide="user" class="inline w-3 h-3 mr-1"></i> Personal Use</div><div class="text-xs text-gray-500">${t.time}  Removed: ${t.actualWeight.toFixed(1)} units</div></div><div class="text-right"><div class="font-black text-gray-400">-$0</div></div></div>`;
                } else {
                    const color = t.type === 'full' ? 'text-green-600' : 'text-orange-500';
                    const label = t.type === 'full' ? 'Full' : (t.type === 'raw' ? 'Raw' : 'Usual');
                    list.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-xl mb-2 border border-gray-200 dark:border-gray-600"><div><div class="font-bold dark:text-white">Sold ${t.qty} <span class="text-[10px] ${color} uppercase tracking-wider ml-1">(${label})</span></div><div class="text-xs text-gray-500">${t.time}  Used: ${t.actualWeight.toFixed(1)} units</div></div><div class="text-right"><div class="font-black text-green-600">+$${t.money}</div></div></div>`;
                }
            });
            if(reversed.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-4 text-xs">No activity recorded yet.</div>';
            lucide.createIcons();
        }

        window.adminSellRaw = async () => {
            const w = parseFloat(document.getElementById('adm-sell-raw-w').value);
            const m = parseFloat(document.getElementById('adm-sell-raw-m').value);
            if(isNaN(w) || isNaN(m)) return window.showToast("Enter valid numbers");
            if(masterData.rawWeight < w) return window.showToast("Not enough raw weight!");

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { rawWeight: increment(-w) }, {merge:true});
            
            // Log for Admin
            const expectedMoney = w * masterData.pricePerUnit;
            adminData.soldWeight += w;
            adminData.collected += m;
            adminData.expected += expectedMoney;
            adminData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: w, type: 'raw', actualWeight: w, money: m, expected: expectedMoney
            });
            await saveAdminData();

            document.getElementById('adm-sell-raw-w').value = ''; document.getElementById('adm-sell-raw-m').value = '';
            window.showToast(`Sold ${w}u for $${m}`);
        };

        window.adminSellUnit = async () => {
            const type = document.getElementById('adm-sell-unit-type').value;
            const q = parseInt(document.getElementById('adm-sell-unit-q').value);
            const m = parseFloat(document.getElementById('adm-sell-unit-m').value);
            if(isNaN(q) || isNaN(m)) return window.showToast("Enter valid numbers");
            
            const currentStock = type === 'full' ? masterData.unitsFull : masterData.unitsUsual;
            if((currentStock || 0) < q) return window.showToast("Not enough processed units!");

            const updateData = {};
            if (type === 'full') {
                updateData.unitsFull = increment(-q);
                adminData.soldUnitsFull += q;
            } else {
                updateData.unitsUsual = increment(-q);
                adminData.soldUnitsUsual += q;
            }

            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), updateData, {merge:true});
            
            // Log for Admin
            const actualW = type === 'full' ? q * 1.0 : q * masterData.usualRatio;
            const unitPrice = type === 'full' ? masterData.pricePerUnit : (masterData.pricePerUnit * masterData.usualRatio);
            const expectedMoney = q * unitPrice;
            
            adminData.soldWeight += actualW;
            adminData.collected += m;
            adminData.expected += expectedMoney;
            adminData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: q, type: type, actualWeight: actualW, money: m, expected: expectedMoney
            });
            await saveAdminData();

            document.getElementById('adm-sell-unit-q').value = ''; document.getElementById('adm-sell-unit-m').value = '';
            window.showToast(`Sold ${q} units for $${m}`);
        };

        window.adminPersonalUse = async (type) => {
            let actualW = 0;
            if(type === 'weight') {
                const w = parseFloat(document.getElementById('adm-use-w').value);
                if(isNaN(w) || w <= 0) return;
                if(masterData.rawWeight < w) return window.showToast("Not enough raw weight!");
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { rawWeight: increment(-w) }, {merge:true});
                document.getElementById('adm-use-w').value = '';
                actualW = w;
            } else {
                const u = parseInt(document.getElementById('adm-use-u').value);
                const uType = document.getElementById('adm-use-u-type').value;
                if(isNaN(u) || u <= 0) return;
                
                const currentStock = uType === 'full' ? masterData.unitsFull : masterData.unitsUsual;
                if((currentStock || 0) < u) return window.showToast("Not enough processed units!");
                
                const updateData = {};
                if (uType === 'full') updateData.unitsFull = increment(-u);
                else updateData.unitsUsual = increment(-u);

                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), updateData, {merge:true});
                document.getElementById('adm-use-u').value = '';
                actualW = uType === 'full' ? u * 1.0 : u * masterData.usualRatio;
            }
            
            // Log for Admin
            adminData.personalUseWeight += actualW;
            adminData.transactions.push({
                id: Date.now(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                qty: 0, type: 'personal', actualWeight: actualW, money: 0, expected: 0
            });
            await saveAdminData();

            window.showToast("Personal Use Logged");
        };

        // Admin Staff Approval
        window.adminSetStatus = async (uid, status) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid), { status }); window.showToast("Status updated"); };
        window.adminDelUser = async (uid) => { if(confirm("Delete user?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid)); };

        // Admin Transfers
        window.fulfillReq = async (reqId, uid) => { 
            window.switchAdminTab('transfers');
            document.getElementById('transfer-staff-select').value = uid; 
            window.updateTransferPreview(); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', reqId), { status: 'completed' }); 
        };
        window.dismissReq = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id)); };

        window.updateTransferPreview = () => {
            const uid = document.getElementById('transfer-staff-select').value;
            const el = document.getElementById('transfer-preview');
            const u = globalRoster.find(x => x.id === uid);
            if(u) {
                const type = document.getElementById('transfer-item-type').value;
                let h = 0; let label = "";
                if(type === 'raw') { h = u.weight||0; label = 'g'; }
                else if(type === 'full') { h = u.unitsFull||0; label = 'units'; }
                else if(type === 'usual') { h = u.unitsUsual||0; label = 'units'; }
                el.innerText = `Current Staff Holding: ${h.toFixed(1)} ${label}`;
            } else { el.innerText = ''; }
        };

        window.adminTransferWeight = async (action) => {
            const uid = document.getElementById('transfer-staff-select').value;
            const amt = parseFloat(document.getElementById('transfer-amount').value);
            const type = document.getElementById('transfer-item-type').value; // 'raw', 'full', 'usual'

            if(!uid || isNaN(amt) || amt <= 0) return window.showToast("Select staff and valid amount");
            
            const r = doc(db,'artifacts',appId,'users',uid,'data','app_state'); 
            const sn = await getDoc(r); 
            let dat = sn.exists() ? JSON.parse(sn.data().json) : {weight:0, unitsFull:0, unitsUsual:0, soldWeight:0, personalUseWeight:0, personalUseOwed:0, collected:0, expected:0, expenses:0, transactions:[]}; 

            // Map keys
            let adminKey = type === 'raw' ? 'rawWeight' : (type === 'full' ? 'unitsFull' : 'unitsUsual');
            let staffKey = type === 'raw' ? 'weight' : (type === 'full' ? 'unitsFull' : 'unitsUsual');

            if (action === 'send') {
                if((masterData[adminKey] || 0) < amt) {
                    if(!confirm(`Warning: Master vault only has ${(masterData[adminKey]||0).toFixed(1)} of this item. Proceed anyway?`)) return;
                }
                // Deduct Master, Add to Staff
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[adminKey]:increment(-amt)},{merge:true}); 
                dat[staffKey] = (dat[staffKey]||0) + amt;
                window.showToast(`Sent ${amt} to staff.`);
            } else if (action === 'reclaim') {
                if((dat[staffKey] || 0) < amt) return window.showToast("Staff does not have that much inventory to reclaim!");
                // Add to Master, Deduct from Staff
                await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'),{[adminKey]:increment(amt)},{merge:true}); 
                dat[staffKey] = (dat[staffKey]||0) - amt;
                window.showToast(`Reclaimed ${amt} from staff.`);
            }
            
            // Save private
            await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
            // Save public
            await setDoc(doc(db,'artifacts',appId,'public','data','roster',uid), {
                weight: dat.weight, unitsFull: dat.unitsFull, unitsUsual: dat.unitsUsual
            }, {merge:true}); 
            
            document.getElementById('transfer-amount').value = '';
            window.updateTransferPreview();
        };

        // Admin Detail View
        window.viewDriverDetails = (uid) => { 
            const d = globalRoster.find(x => x.id === uid); 
            if(!d) return; 
            currentDetailUid = uid; 
            document.getElementById('admin-user-detail').classList.remove('hidden'); 
            document.getElementById('detail-user-name').innerText = d.name; 
            
            // Holdings
            document.getElementById('det-holding-raw').innerText = (d.weight||0).toFixed(1);
            document.getElementById('det-holding-full').innerText = (d.unitsFull||0);
            document.getElementById('det-holding-usual').innerText = (d.unitsUsual||0);
            
            // Sold Totals
            document.getElementById('det-sold-raw').innerText = (d.soldWeight||0).toFixed(1);
            document.getElementById('det-sold-full').innerText = (d.soldUnitsFull||0);
            document.getElementById('det-sold-usual').innerText = (d.soldUnitsUsual||0);
            
            document.getElementById('det-expected').innerText = `$${d.expected||0}`;
            document.getElementById('det-personal-owed').innerText = `$${d.personalUseOwed||0}`;
            
            document.getElementById('det-collected').innerText = `$${d.collected||0}`;
            document.getElementById('det-expenses').innerText = `-$${d.expenses||0}`;
            
            const netCash = (d.collected||0) - (d.expenses||0);
            document.getElementById('det-net-cash').innerText = `$${netCash}`;

            const diff = (d.expected||0) - (d.collected||0);
            const box = document.getElementById('det-diff-box');
            const diffEl = document.getElementById('det-diff');
            
            if(diff > 0) {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 mb-4";
                diffEl.innerText = `-$${diff} (Short)`;
            } else if (diff < 0) {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 mb-4";
                diffEl.innerText = `+$${Math.abs(diff)} (Over)`;
            } else {
                box.className = "p-3 rounded-lg flex justify-between items-center font-bold bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 mb-4";
                diffEl.innerText = `$0 (Perfect)`;
            }
            
            // Update Detail Chart
            const ctx = document.getElementById('adminDetailChart');
            if(ctx && d.recentLogs) {
                const sales = d.recentLogs.filter(t => t.type !== 'personal' && t.type !== 'expense').reverse();
                const labels = sales.map(t => t.time);
                const data = sales.map(t => t.money);

                if(adminDetailChartInst) adminDetailChartInst.destroy();
                adminDetailChartInst = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sale ($)',
                            data: data,
                            backgroundColor: '#8b5cf6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        };

        window.adminClearStaffData = async () => {
            if(!currentDetailUid) return;
            if(!confirm("Are you sure? This sets their expected, collected, and sold items to 0. (Does not affect Holding Inventory)")) return;

            const r = doc(db,'artifacts',appId,'users',currentDetailUid,'data','app_state'); 
            const sn = await getDoc(r); 
            if(sn.exists()) {
                let dat = JSON.parse(sn.data().json);
                dat.soldWeight = 0; dat.soldUnitsFull = 0; dat.soldUnitsUsual = 0; dat.collected = 0; dat.expected = 0; dat.personalUseOwed = 0; dat.expenses = 0; dat.transactions = [];
                await setDoc(r, {json:JSON.stringify(dat), lastUpdated:Date.now()}); 
                await setDoc(doc(db,'artifacts',appId,'public','data','roster',currentDetailUid), {soldWeight:0, soldUnitsFull:0, soldUnitsUsual:0, collected:0, expected:0, personalUseOwed:0, expenses:0, recentLogs:[]}, {merge:true}); 
                window.showToast("Data Cleared.");
                document.getElementById('admin-user-detail').classList.add('hidden');
            }
        };

        // ADMIN FACTORY RESET
        window.adminFactoryReset = async () => {
            if(!confirm("WARNING: This will reset all Master Vault inventory AND all Staff balances/sales history to 0.\n\nUser accounts and roles will remain intact.\n\nProceed?")) return;
            if(!confirm("Are you ABSOLUTELY sure? This cannot be undone.")) return;

            window.showToast("Resetting data...");

            // 1. Reset Master
            await setDoc(doc(db,'artifacts',appId,'public','data','inventory','master'), { rawWeight: 0, unitsFull: 0, unitsUsual: 0, pricePerUnit: masterData.pricePerUnit, usualRatio: masterData.usualRatio, totalExpenses: 0 });

            // 2. Reset All Staff
            for(const u of globalRoster) {
                if(u.role !== 'admin') {
                    const r = doc(db,'artifacts',appId,'users',u.id,'data','app_state');
                    const emptyData = { weight:0, soldWeight:0, personalUseWeight:0, collected:0, expected:0, transactions:[] };
                    await setDoc(r, { json: JSON.stringify(emptyData), lastUpdated: Date.now() });

                    await setDoc(doc(db,'artifacts',appId,'public','data','roster',u.id), {
                        weight: 0, soldWeight: 0, personalUseWeight: 0, collected: 0, expected: 0, recentLogs: []
                    }, {merge: true});
                }
            }

            // 3. Clear pending requests
            const reqsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'requests'));
            reqsSnap.forEach(async (d) => { await deleteDoc(d.ref); });

            window.showToast("Factory Reset Complete.");
        };

    </script>
</body>
</html>