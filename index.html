<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales & Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .hidden { display: none !important; }
    </style>
    <script>
        // Force Dark Mode Default on Load
        if (localStorage.theme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200">

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Portal Login</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Drivers & Admins</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="window.handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-3 rounded-lg shadow-sm flex justify-center items-center hover:bg-gray-50 dark:hover:bg-gray-600">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Approval Pending Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
                <i data-lucide="clock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold dark:text-white">Approval Pending</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">Contact the Boss to approve your account.</p>
            <div class="animate-pulse text-xs text-blue-500 mb-6">Waiting for authorization...</div>
            <button onclick="window.logout()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-lg text-gray-700 dark:text-gray-300">Sign Out</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Options</h2>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="space-y-3">
                <button onclick="window.toggleTheme()" class="w-full flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <span class="font-medium dark:text-white">Dark Mode</span>
                    <i data-lucide="moon" class="w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                </button>
                
                <hr class="border-gray-200 dark:border-gray-700 my-2">
                
                <button onclick="window.logout()" class="w-full flex justify-center items-center p-3 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg font-bold">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- DRIVER UI -->
    <div id="driver-app" class="hidden pb-20">
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold">Driver Portal</h1>
                <div class="flex items-center text-xs text-blue-200 mt-1">
                    <span id="driver-name-display">Guest</span>
                    <span class="mx-2">â€¢</span>
                    <div id="driver-sync-status" class="w-2 h-2 rounded-full bg-green-400"></div>
                </div>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-md mx-auto">
            <!-- Stock Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-gray-500 text-xs uppercase tracking-wide">My Stock</h2>
                        <span class="text-4xl font-bold dark:text-white" id="display-stock">0</span>
                    </div>
                    <div class="text-right">
                        <h2 class="text-gray-500 text-xs uppercase tracking-wide">Owed</h2>
                        <span class="text-2xl font-bold text-red-500" id="display-stock-value">$0</span>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-400 italic text-center">Stock is managed by Admin</div>
            </div>

            <!-- Quick Sell -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700">
                <h2 class="text-gray-500 text-xs uppercase tracking-wide mb-3">New Sale</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="window.sellItem(1)" class="p-3 rounded-lg border-2 border-blue-100 dark:border-blue-900 bg-blue-50 dark:bg-blue-900/20 text-center active:scale-95 transition">
                        <div class="text-lg font-bold text-blue-700 dark:text-blue-400">1 ($80)</div>
                    </button>
                    <button onclick="window.sellItem(2)" class="p-3 rounded-lg border-2 border-green-100 dark:border-green-900 bg-green-50 dark:bg-green-900/20 text-center active:scale-95 transition">
                        <div class="text-lg font-bold text-green-700 dark:text-green-400">2 ($150)</div>
                    </button>
                    <button onclick="window.sellItem(3)" class="p-3 rounded-lg border-2 border-purple-100 dark:border-purple-900 bg-purple-50 dark:bg-purple-900/20 text-center active:scale-95 transition">
                        <div class="text-lg font-bold text-purple-700 dark:text-purple-400">3 ($220)</div>
                    </button>
                    <button onclick="window.sellItem(4)" class="p-3 rounded-lg border-2 border-orange-100 dark:border-orange-900 bg-orange-50 dark:bg-orange-900/20 text-center active:scale-95 transition">
                        <div class="text-lg font-bold text-orange-700 dark:text-orange-400">4 ($280)</div>
                    </button>
                </div>
            </div>

            <!-- Today's Stats -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-gray-500 text-xs uppercase tracking-wide">Today's Shift</h2>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold" id="today-profit-badge">$0 Profit</span>
                </div>
                <div id="transaction-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar text-sm">
                    <div class="text-center text-gray-400 py-2">No sales yet today</div>
                </div>
                <button onclick="window.endDay()" class="mt-4 w-full bg-gray-900 dark:bg-gray-700 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">End Shift & Save</button>
            </div>
        </main>
    </div>

    <!-- ADMIN UI -->
    <div id="admin-app" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900 pb-20">
        <header class="bg-gray-900 text-white p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">BOSS DASHBOARD</h1>
                <p class="text-xs text-gray-400" id="admin-date-display"></p>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-2xl mx-auto">
            
            <!-- Admin Navigation -->
            <div class="flex space-x-2 mb-6">
                <button onclick="window.switchAdminTab('team')" id="adm-tab-team" class="flex-1 bg-white dark:bg-gray-800 py-2 rounded-lg font-bold text-sm shadow-sm border-b-4 border-blue-600 text-blue-600 transition">Team Sales</button>
                <button onclick="window.switchAdminTab('inventory')" id="adm-tab-inventory" class="flex-1 bg-white dark:bg-gray-800 py-2 rounded-lg font-bold text-sm shadow-sm text-gray-500 dark:text-gray-400 transition">Inventory</button>
            </div>

            <!-- TAB: TEAM OVERVIEW -->
            <div id="admin-view-team" class="admin-tab-content">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase">Total Team Profit</div>
                        <div class="text-2xl font-bold text-green-600" id="admin-total-profit">$0</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase">Items Sold Today</div>
                        <div class="text-2xl font-bold text-blue-600" id="admin-total-sold">0</div>
                    </div>
                </div>

                <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3 ml-1">Active Drivers</h3>
                <div id="admin-driver-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400 animate-pulse">Loading team data...</div>
                </div>
            </div>

            <!-- TAB: INVENTORY -->
            <div id="admin-view-inventory" class="admin-tab-content hidden">
                <!-- Master Stock Card -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 text-white mb-6 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-gray-400 text-xs uppercase tracking-wider font-bold mb-1">Warehouse Master Stock</h2>
                            <div class="text-4xl font-bold mb-2" id="admin-master-stock">--</div>
                            <p class="text-xs text-gray-500">Items available to distribute</p>
                        </div>
                        <button onclick="window.adminAddMasterStock()" class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg text-white text-xs font-bold border border-gray-600 transition">
                            + Restock
                        </button>
                    </div>
                </div>

                <!-- Distribute Panel -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i data-lucide="truck" class="w-5 h-5 mr-2 text-blue-600"></i> Distribute Stock
                    </h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Select Driver</label>
                            <select id="distribute-select-driver" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg outline-none font-medium text-gray-800 dark:text-white">
                                <option value="">Loading drivers...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Quantity to Send</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="number" id="distribute-qty" placeholder="0" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg outline-none font-bold text-lg text-gray-800 dark:text-white">
                                <button onclick="window.adminDistributeStock()" class="bg-blue-600 text-white font-bold px-6 rounded-lg shadow-md hover:bg-blue-700 active:scale-95 transition">
                                    SEND
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: USER DETAIL (Hidden modal-like) -->
            <div id="admin-user-detail" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 overflow-y-auto hidden">
                <div class="bg-white dark:bg-gray-800 p-4 sticky top-0 shadow-md flex items-center justify-between">
                    <button onclick="document.getElementById('admin-user-detail').classList.add('hidden')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <h2 class="font-bold text-lg dark:text-white" id="detail-user-name">Driver Stats</h2>
                    <div class="w-8"></div>
                </div>
                <div class="p-4 max-w-2xl mx-auto space-y-4">
                    <!-- Detailed Stats -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Stock on Hand</div>
                            <div class="text-xl font-bold dark:text-white" id="detail-stock">0</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Start of Day</div>
                            <div class="text-xl font-bold dark:text-white" id="detail-start-stock">0</div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-sm mb-3 border-b pb-2 dark:border-gray-700 dark:text-white">Today's Activity Log</h3>
                        <div id="detail-log-list" class="space-y-2 text-sm"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- MAIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgX9tL8zEaPvaZIcqDdk8XHzz4y7MvCeU",
            authDomain: "salesonwheels-f6eec.firebaseapp.com",
            projectId: "salesonwheels-f6eec",
            storageBucket: "salesonwheels-f6eec.firebasestorage.app",
            messagingSenderId: "432785821226",
            appId: "1:432785821226:web:96b34cc3d0526160b0bd53"
        };
        const appId = "sales-tracker-v1"; // DB Namespace

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userRole = 'driver'; 
        let appData = { stock: 0, currentTransactions: [], history: [], stockLogs: [] };
        
        // Listeners
        let unsubUserData = null;
        let unsubProfile = null;
        let unsubRoster = null; 
        let unsubMasterStock = null; 

        // --- UTILS ---
        window.showToast = (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); };
        
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };

        // --- AUTH & ROUTING ---
        window.handleGoogleLogin = async () => {
            try { await signInWithPopup(auth, googleProvider); } 
            catch (e) { window.showToast("Login Failed: " + e.message); }
        };

        window.logout = async () => {
            if(unsubUserData) unsubUserData();
            if(unsubProfile) unsubProfile();
            if(unsubRoster) unsubRoster();
            await signOut(auth);
            window.location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-modal').classList.add('hidden');
                
                // 1. Get/Create Profile & Check Role
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                unsubProfile = onSnapshot(profileRef, async (snap) => {
                    let role = 'driver';
                    let status = 'pending';
                    
                    if (!snap.exists()) {
                        // Create New Profile
                        await setDoc(profileRef, {
                            name: user.displayName || user.email, 
                            email: user.email, 
                            role: 'driver', 
                            status: 'pending', 
                            createdAt: Date.now()
                        });
                    } else {
                        const data = snap.data();
                        role = data.role || 'driver';
                        status = data.status || 'pending';
                    }

                    // *** CRITICAL: Add to roster so Admin sees user ***
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'roster', user.uid), {
                        name: user.displayName || user.email, 
                        email: user.email, 
                        uid: user.uid,
                        lastLogin: Date.now()
                    }, { merge: true });

                    userRole = role;

                    if (status === 'approved' || role === 'admin') {
                        document.getElementById('approval-modal').classList.add('hidden');
                        if (role === 'admin') initAdminDashboard();
                        else initDriverApp(user);
                    } else {
                        document.getElementById('approval-modal').classList.remove('hidden');
                    }
                });
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('driver-app').classList.add('hidden');
                document.getElementById('admin-app').classList.add('hidden');
            }
        });

        // --- DRIVER LOGIC ---
        function initDriverApp(user) {
            document.getElementById('driver-app').classList.remove('hidden');
            const displayName = user.displayName ? user.displayName.split(' ')[0] : 'Driver';
            document.getElementById('driver-name-display').innerText = displayName;
            
            // Sync Data
            const dataRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state');
            unsubUserData = onSnapshot(dataRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if(data.json) appData = JSON.parse(data.json);
                    // Ensure arrays exist
                    appData.stockLogs = appData.stockLogs || []; 
                    appData.currentTransactions = appData.currentTransactions || [];
                    renderDriverUI();
                } else {
                    saveDriverData(); // Create empty
                }
            });
        }

        function renderDriverUI() {
            // Calculate Stock
            document.getElementById('display-stock').innerText = appData.stock;
            document.getElementById('display-stock-value').innerText = `$${(appData.stock * 60).toLocaleString()}`; 
            
            // Calculate Today's Stats
            const todayTotals = appData.currentTransactions.reduce((acc, t) => ({ profit: acc.profit + t.profit, gross: acc.gross + t.price }), {profit:0, gross:0});
            document.getElementById('today-profit-badge').innerText = `+$${todayTotals.profit} Profit`;

            // Render List
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            [...appData.currentTransactions].reverse().forEach(t => {
                list.innerHTML += `<div class="flex justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded">
                    <span class="dark:text-gray-200">Sold ${t.qty} item(s)</span>
                    <span class="font-bold text-green-600">+$${t.profit}</span>
                </div>`;
            });
            if(appData.currentTransactions.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-2">No sales yet today</div>';
        }

        async function saveDriverData() {
            if(!currentUser) return;
            const dataRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state');
            await setDoc(dataRef, { json: JSON.stringify(appData), lastUpdated: Date.now() });
        }

        window.sellItem = async (qty) => {
            if(appData.stock < qty) { window.showToast("Not enough stock!"); return; }
            
            const pricing = { 1:{p:80, prof:20}, 2:{p:150, prof:40}, 3:{p:220, prof:60}, 4:{p:280, prof:80} };
            const tier = pricing[qty];
            
            appData.stock -= qty;
            appData.currentTransactions.push({ date: Date.now(), qty: qty, price: tier.p, profit: tier.prof, time: new Date().toLocaleTimeString() });
            
            await saveDriverData();
            window.showToast(`Sold ${qty} for $${tier.p}`);
        };

        window.endDay = async () => {
            if(appData.currentTransactions.length === 0) { window.showToast("No sales to save."); return; }
            // Move today to history
            const todayStats = appData.currentTransactions.reduce((acc, t) => ({ profit: acc.profit+t.profit, sold: acc.sold+t.qty }), {profit:0, sold:0});
            appData.history.push({ date: new Date().toISOString().split('T')[0], ...todayStats });
            appData.currentTransactions = [];
            await saveDriverData();
            window.showToast("Day saved!");
        };

        // --- ADMIN LOGIC ---
        function initAdminDashboard() {
            document.getElementById('admin-app').classList.remove('hidden');
            document.getElementById('admin-date-display').innerText = new Date().toDateString();
            
            // 1. Subscribe to Roster (List of Drivers)
            const rosterRef = collection(db, 'artifacts', appId, 'public', 'roster');
            unsubRoster = onSnapshot(rosterRef, async (snap) => {
                const listEl = document.getElementById('admin-driver-list');
                const selectEl = document.getElementById('distribute-select-driver');
                listEl.innerHTML = '';
                selectEl.innerHTML = '<option value="">Select Driver...</option>';
                
                if (snap.empty) {
                    listEl.innerHTML = '<div class="text-center py-8 text-gray-400">No active drivers found.</div>';
                    return;
                }
                
                let totalSoldToday = 0;
                let totalProfitToday = 0;

                for (const docSnap of snap.docs) {
                    const driver = docSnap.data();
                    // Fetch that driver's live state
                    const stateRef = doc(db, 'artifacts', appId, 'users', driver.uid, 'data', 'app_state');
                    const stateSnap = await getDoc(stateRef);
                    
                    let dStock = 0;
                    let dSold = 0;
                    let dProfit = 0;

                    if(stateSnap.exists()) {
                        const dData = JSON.parse(stateSnap.data().json);
                        dStock = dData.stock || 0;
                        dData.currentTransactions?.forEach(t => {
                            dSold += t.qty;
                            dProfit += t.profit;
                        });
                    }

                    totalSoldToday += dSold;
                    totalProfitToday += dProfit;

                    // Render Card
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition";
                    card.onclick = () => window.viewDriverDetails(driver.uid, driver.name);
                    card.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold mr-3">${driver.name ? driver.name[0].toUpperCase() : 'U'}</div>
                            <div>
                                <div class="font-bold text-gray-800 dark:text-white">${driver.name || 'Unknown User'}</div>
                                <div class="text-xs text-gray-500">Stock: ${dStock} â€¢ Sold Today: ${dSold}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">+$${dProfit}</div>
                            <div class="text-xs text-gray-400">Profit</div>
                        </div>
                    `;
                    listEl.appendChild(card);

                    // Add to Select Dropdown
                    const option = document.createElement('option');
                    option.value = driver.uid;
                    option.innerText = driver.name || 'Unknown';
                    selectEl.appendChild(option);
                }

                document.getElementById('admin-total-profit').innerText = `$${totalProfitToday}`;
                document.getElementById('admin-total-sold').innerText = totalSoldToday;
            });

            // 2. Subscribe to Master Inventory
            const masterRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master');
            unsubMasterStock = onSnapshot(masterRef, (snap) => {
                const val = snap.exists() ? (snap.data().qty || 0) : 0;
                document.getElementById('admin-master-stock').innerText = val;
            });
        }

        window.switchAdminTab = (tab) => {
            document.getElementById('admin-view-team').classList.add('hidden');
            document.getElementById('admin-view-inventory').classList.add('hidden');
            document.getElementById('adm-tab-team').classList.remove('border-b-4', 'border-blue-600', 'text-blue-600');
            document.getElementById('adm-tab-inventory').classList.remove('border-b-4', 'border-blue-600', 'text-blue-600');
            
            document.getElementById(`admin-view-${tab}`).classList.remove('hidden');
            document.getElementById(`adm-tab-${tab}`).classList.add('border-b-4', 'border-blue-600', 'text-blue-600');
        };

        window.adminAddMasterStock = async () => {
            const qty = prompt("Enter quantity to add to Warehouse:");
            if(!qty) return;
            const val = parseInt(qty);
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master');
            // Use setDoc with merge to ensure creation if missing
            await setDoc(ref, { qty: increment(val) }, { merge: true });
            window.showToast("Warehouse updated");
        };

        window.adminDistributeStock = async () => {
            const uid = document.getElementById('distribute-select-driver').value;
            const qty = parseInt(document.getElementById('distribute-qty').value);
            
            if(!uid || !qty || qty <= 0) { window.showToast("Select driver and enter valid qty"); return; }

            // 1. Decrease Master
            const masterRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master');
            await setDoc(masterRef, { qty: increment(-qty) }, { merge: true });

            // 2. Increase Driver
            const driverRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'app_state');
            const snap = await getDoc(driverRef);
            if(snap.exists()) {
                let dData = JSON.parse(snap.data().json);
                dData.stock = (dData.stock || 0) + qty;
                dData.stockLogs = dData.stockLogs || [];
                dData.stockLogs.push({ date: Date.now(), type: 'receive', qty: qty, by: 'admin' });
                
                await setDoc(driverRef, { json: JSON.stringify(dData), lastUpdated: Date.now() });
                window.showToast(`Sent ${qty} items to driver`);
                document.getElementById('distribute-qty').value = '';
            } else {
                // Create data for new driver if they haven't logged in yet
                let dData = { stock: qty, currentTransactions: [], history: [], stockLogs: [] };
                dData.stockLogs.push({ date: Date.now(), type: 'receive', qty: qty, by: 'admin' });
                await setDoc(driverRef, { json: JSON.stringify(dData), lastUpdated: Date.now() });
                window.showToast(`Sent ${qty} items (New Profile created)`);
            }
        };

        window.viewDriverDetails = async (uid, name) => {
            document.getElementById('admin-user-detail').classList.remove('hidden');
            document.getElementById('detail-user-name').innerText = name;
            
            const ref = doc(db, 'artifacts', appId, 'users', uid, 'data', 'app_state');
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                const d = JSON.parse(snap.data().json);
                const currentStock = d.stock || 0;
                let addedToday = 0;
                let soldToday = 0;
                
                const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
                
                d.stockLogs?.forEach(log => {
                    if(log.date >= startOfDay.getTime()) addedToday += log.qty;
                });
                d.currentTransactions?.forEach(t => {
                    soldToday += t.qty;
                });

                const startStock = currentStock + soldToday - addedToday;

                document.getElementById('detail-stock').innerText = currentStock;
                document.getElementById('detail-start-stock').innerText = startStock;

                const logList = document.getElementById('detail-log-list');
                logList.innerHTML = '';
                
                let timeline = [];
                d.currentTransactions?.forEach(t => timeline.push({ ...t, type: 'sale' }));
                d.stockLogs?.forEach(l => {
                    if(l.date >= startOfDay.getTime()) timeline.push({ ...l, type: 'stock' });
                });
                timeline.sort((a,b) => b.date - a.date);

                timeline.forEach(item => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between border-b border-gray-100 dark:border-gray-700 pb-2";
                    if(item.type === 'sale') {
                        row.innerHTML = `<span class="text-gray-500">${new Date(item.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span> <span class="dark:text-gray-300">Sold <b>${item.qty}</b> items</span> <span class="text-green-600 font-bold">+$${item.profit}</span>`;
                    } else {
                        row.innerHTML = `<span class="text-gray-500">${new Date(item.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span> <span class="dark:text-gray-300">ðŸ“¦ Added <b>${item.qty}</b> items</span> <span class="text-blue-500 text-xs uppercase">${item.by}</span>`;
                    }
                    logList.appendChild(row);
                });
                
                if(timeline.length === 0) logList.innerHTML = "<div class='text-center text-gray-400'>No activity today</div>";
            }
        };
    </script>
</body>
</html>