<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales & Inventory Tracker (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- CONFIGURATION START ---
        // PASTE YOUR FIREBASE CONFIG HERE FROM THE CONSOLE
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

			apiKey: "AIzaSyBgX9tL8zEaPvaZIcqDdk8XHzz4y7MvCeU",
			authDomain: "salesonwheels-f6eec.firebaseapp.com",
			projectId: "salesonwheels-f6eec",
			storageBucket: "salesonwheels-f6eec.firebasestorage.app",
            messagingSenderId: "432785821226",
            appId: "1:432785821226:web:96b34cc3d0526160b0bd53"
			};
		 const appId = "sales-tracker-v1"; 	
			
        // --- CONFIGURATION END ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Expose to window for app logic
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.updateProfile = updateProfile;
        window.googleProvider = googleProvider;
        window.signInWithPopup = signInWithPopup;
    </script>

    <style>
        /* Custom styles for mobile app feel */
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 200; /* HIGH PRIORITY: Ensures errors show ON TOP of login modal */
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 90px;
        }

        /* Slide to delete animation */
        .slide-out {
            animation: slideOut 0.3s forwards;
        }
        @keyframes slideOut {
            to { transform: translateX(100%); opacity: 0; height: 0; margin: 0; padding: 0; }
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .hidden { display: none !important; }
    </style>
    <script>
        // Check theme before render
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="text-gray-800 dark:text-gray-100 dark:bg-gray-900 pb-24 transition-colors duration-200">

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-6">
                <div class="bg-blue-100 dark:bg-blue-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="truck" class="w-8 h-8 text-blue-600 dark:text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white" id="auth-title">Driver Login</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1" id="auth-subtitle">Sign in to access your route data.</p>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <!-- Google Button -->
                <button onclick="handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-3 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition flex justify-center items-center">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/>
                        <path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-xs uppercase">Or use email</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Email</label>
                    <input type="email" id="login-email" placeholder="driver@example.com" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Password</label>
                    <input type="password" id="login-password" placeholder="••••••••" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                </div>
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 flex justify-center items-center">
                    <span>Sign In</span>
                </button>
                <div class="text-center mt-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">New Driver?</p>
                    <button onclick="toggleAuthMode('register')" class="text-blue-600 dark:text-blue-400 font-bold text-sm hover:underline">Create Account</button>
                </div>
            </div>

            <!-- Register Form (Hidden by default) -->
            <div id="register-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Full Name</label>
                    <input type="text" id="reg-name" placeholder="John Doe" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Email</label>
                    <input type="email" id="reg-email" placeholder="driver@example.com" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-400 mb-1">Password</label>
                    <input type="password" id="reg-password" placeholder="••••••••" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition">
                </div>
                <button onclick="handleRegister()" id="btn-register" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform active:scale-95 flex justify-center items-center">
                    <span>Create Account</span>
                </button>
                <div class="text-center mt-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Have an account?</p>
                    <button onclick="toggleAuthMode('login')" class="text-blue-600 dark:text-blue-400 font-bold text-sm hover:underline">Back to Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Pending Modal -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 dark:bg-yellow-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="clock" class="w-8 h-8 text-yellow-600 dark:text-yellow-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Approval Pending</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">
                Your account has been created but requires Admin approval before you can access the system.
            </p>
            <div class="animate-pulse flex justify-center items-center text-xs text-blue-500 mb-6">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                Waiting for admin...
            </div>
            <button onclick="logout()" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold py-3 rounded-lg">
                Sign Out
            </button>
        </div>
    </div>

    <!-- App Container -->
    <div class="max-w-md mx-auto bg-gray-50 dark:bg-gray-900 min-h-screen shadow-xl relative transition-colors duration-200">
        
        <!-- Header -->
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md transition-colors duration-200">
            <div class="flex justify-between items-start">
                <div class="w-8"></div>
                <div class="text-center">
                    <h1 class="text-xl font-bold">Sales Tracker</h1>
                    <div class="flex items-center justify-center space-x-2 mt-1">
                        <span id="current-user-display" class="text-xs bg-blue-700 dark:bg-gray-700 px-2 py-0.5 rounded-full text-blue-100 opacity-0 transition-opacity">Driver</span>
                        <div id="sync-status" class="w-2 h-2 rounded-full bg-green-400 animate-pulse" title="Online"></div>
                    </div>
                    <!-- Restored Date Header -->
                    <p id="current-date-header" class="text-xs text-blue-200 dark:text-gray-400 mt-1"></p>
                </div>
                <button onclick="toggleTheme()" class="p-1 rounded-full hover:bg-white/20 transition">
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5 text-white"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-4">
            
            <!-- TAB 1: SALES & TERMINAL -->
            <div id="tab-sales" class="tab-content active">
                
                <!-- Stock Management Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-2 flex items-center justify-between">
                        <div class="flex items-center"><i data-lucide="package" class="w-5 h-5 mr-2"></i> Inventory</div>
                        <button onclick="toggleStockEdit()" class="text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded text-gray-600 dark:text-gray-300 transition flex items-center">
                            <i data-lucide="edit-2" class="w-3 h-3 mr-1"></i> Edit
                        </button>
                    </h2>
                    
                    <!-- Stock Display Mode -->
                    <div id="stock-display-mode">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-3xl font-bold dark:text-white" id="display-stock">--</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Items in Stock</span>
                        </div>
                        <div class="flex space-x-2">
                            <input type="number" id="stock-add-input" placeholder="Qty to add" class="flex-1 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" min="1">
                            <button onclick="addStock()" class="bg-blue-600 dark:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium active:bg-blue-700 transition">Add</button>
                        </div>
                    </div>

                    <!-- Stock Edit Mode (Hidden by default) -->
                    <div id="stock-edit-mode" class="hidden">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Set exact stock count:</p>
                        <div class="flex space-x-2">
                            <input type="number" id="stock-set-input" class="flex-1 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500">
                            <button onclick="saveStockEdit()" class="bg-green-600 dark:bg-green-500 text-white px-4 py-2 rounded-lg font-medium active:bg-green-700 transition">Set</button>
                            <button onclick="toggleStockEdit()" class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg font-medium">Cancel</button>
                        </div>
                    </div>

                    <div class="mt-3 text-sm text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-2 rounded flex justify-between">
                        <span>Value of Unsold Stock:</span>
                        <span id="display-stock-value" class="font-semibold text-gray-700 dark:text-gray-200">$0</span>
                    </div>
                </div>

                <!-- Sell Terminal Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-3 flex items-center">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i> Quick Sell
                    </h2>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="sellItem(1)" class="border-2 border-blue-100 dark:border-blue-900/50 hover:border-blue-500 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-center active:bg-blue-200 dark:active:bg-blue-900/40 transition">
                            <div class="font-bold text-lg text-blue-800 dark:text-blue-400">1 Item</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$80</div>
                        </button>
                        <button onclick="sellItem(2)" class="border-2 border-green-100 dark:border-green-900/50 hover:border-green-500 bg-green-50 dark:bg-green-900/20 rounded-lg p-3 text-center active:bg-green-200 dark:active:bg-green-900/40 transition">
                            <div class="font-bold text-lg text-green-800 dark:text-green-400">2 Items</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$150</div>
                        </button>
                        <button onclick="sellItem(3)" class="border-2 border-purple-100 dark:border-purple-900/50 hover:border-purple-500 bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 text-center active:bg-purple-200 dark:active:bg-purple-900/40 transition">
                            <div class="font-bold text-lg text-purple-800 dark:text-purple-400">3 Items</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$220</div>
                        </button>
                        <button onclick="sellItem(4)" class="border-2 border-orange-100 dark:border-orange-900/50 hover:border-orange-500 bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3 text-center active:bg-orange-200 dark:active:bg-orange-900/40 transition">
                            <div class="font-bold text-lg text-orange-800 dark:text-orange-400">4 Items</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$280</div>
                        </button>
                    </div>
                </div>

                <!-- Today's Transactions (Editable) -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-3 flex items-center justify-between">
                        <div class="flex items-center"><i data-lucide="list" class="w-5 h-5 mr-2"></i> Today's Sales</div>
                        <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 px-2 py-1 rounded-full" id="txn-count-badge">0 sales</span>
                    </h2>
                    
                    <!-- Stats Summary Mini -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded border border-green-100 dark:border-green-900/30 text-center">
                             <div class="text-xs text-green-600 dark:text-green-400 uppercase">Profit</div>
                             <div class="font-bold text-green-700 dark:text-green-300" id="today-profit">$0</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded border border-gray-100 dark:border-gray-600 text-center">
                             <div class="text-xs text-gray-500 dark:text-gray-400 uppercase">Gross</div>
                             <div class="font-bold text-gray-700 dark:text-white" id="today-gross">$0</div>
                        </div>
                    </div>

                    <!-- Transaction List -->
                    <div id="current-transactions-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar mb-4">
                        <!-- Items injected here -->
                        <div class="text-center text-gray-400 text-sm py-4">No sales yet today.</div>
                    </div>

                    <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg flex justify-between items-center mb-4">
                        <div class="text-xs text-red-600 dark:text-red-400 uppercase tracking-wide">Supplier Funds</div>
                        <div class="text-xl font-bold text-red-700 dark:text-red-400" id="today-supplier">$0</div>
                    </div>

                    <button onclick="endDay()" class="w-full bg-gray-800 dark:bg-gray-700 text-white py-3 rounded-lg font-bold shadow-md active:bg-gray-900 dark:active:bg-gray-600 transition flex justify-center items-center">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Day & Reset Shift
                    </button>
                </div>
            </div>

            <!-- TAB 2: REPORTS & ANALYTICS -->
            <div id="tab-reports" class="tab-content">
                
                <!-- Predictions Card -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-800 dark:to-indigo-900 rounded-xl shadow-sm p-5 mb-4 text-white">
                    <h2 class="font-semibold text-blue-100 dark:text-blue-200 mb-1 flex items-center text-sm uppercase tracking-wider">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i> Predicted Weekly Profit
                    </h2>
                    <div class="text-3xl font-bold mb-1" id="predicted-earnings">$0</div>
                    <p class="text-xs text-blue-200 dark:text-blue-300" id="prediction-context">Based on average sales this week</p>
                </div>

                <!-- Financial Charts Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h3 class="font-semibold text-gray-600 dark:text-gray-300 mb-4 text-sm uppercase">Financial Performance</h3>
                    <div class="flex space-x-2 mb-4 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                        <button onclick="updateChart('daily')" id="btn-chart-daily" class="flex-1 py-1 text-sm rounded-md bg-white dark:bg-gray-600 shadow text-blue-600 dark:text-blue-400 font-medium transition">Daily</button>
                        <button onclick="updateChart('weekly')" id="btn-chart-weekly" class="flex-1 py-1 text-sm rounded-md text-gray-500 dark:text-gray-400 font-medium transition">Weekly</button>
                        <button onclick="updateChart('monthly')" id="btn-chart-monthly" class="flex-1 py-1 text-sm rounded-md text-gray-500 dark:text-gray-400 font-medium transition">Monthly</button>
                    </div>
                    
                    <div class="relative h-56 w-full">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <!-- Hourly Analysis Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                     <h3 class="font-semibold text-gray-600 dark:text-gray-300 mb-2 text-sm uppercase flex items-center">
                         <i data-lucide="clock" class="w-4 h-4 mr-2"></i> Busiest Times (Hourly)
                     </h3>
                     <p class="text-xs text-gray-400 mb-4">Total items sold by hour of day</p>
                     <div class="relative h-48 w-full">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>

                <!-- History List -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-3">Recent Days</h2>
                    <div id="history-list" class="space-y-3 max-h-60 overflow-y-auto hide-scrollbar">
                        <!-- History items injected here -->
                    </div>
                </div>
            </div>

            <!-- TAB 3: SETTINGS -->
            <div id="tab-settings" class="tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-4 flex items-center">
                        <i data-lucide="user" class="w-5 h-5 mr-2"></i> Account & Data
                    </h2>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-900/50 mb-4">
                        <div class="flex items-center mb-2">
                             <div class="w-10 h-10 rounded-full bg-blue-200 dark:bg-blue-800 flex items-center justify-center text-blue-700 dark:text-blue-300 font-bold mr-3" id="profile-initial">
                                 ?
                             </div>
                             <div>
                                 <h3 class="font-bold text-gray-800 dark:text-white text-sm" id="profile-name">Guest</h3>
                                 <p class="text-xs text-blue-600 dark:text-blue-300 capitalize" id="profile-role">Driver</p>
                             </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Email: <span id="profile-email">...</span></p>
                    </div>

                    <div class="space-y-4">
                        <button onclick="logout()" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 py-3 rounded-lg font-medium active:bg-gray-300 dark:active:bg-gray-600 transition flex justify-center items-center">
                            <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-around pb-safe pt-2 px-2 z-50 transition-colors">
            <button onclick="switchTab('sales')" id="nav-sales" class="flex flex-col items-center p-2 text-blue-600 dark:text-blue-400 w-1/3">
                <i data-lucide="layout-dashboard" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Sales</span>
            </button>
            <button onclick="switchTab('reports')" id="nav-reports" class="flex flex-col items-center p-2 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 w-1/3 transition">
                <i data-lucide="pie-chart" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Reports</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center p-2 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 w-1/3 transition">
                <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Settings</span>
            </button>
        </nav>
        
        <!-- Toast Element -->
        <div id="toast">Message here</div>

    </div>

    <script type="module">
        // Import Auth functions 
        const { 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile,
            GoogleAuthProvider,
            signInWithPopup
        } = window;
        const { doc, getDoc, setDoc, onSnapshot, collection } = window;

        // --- Core App Logic ---
        lucide.createIcons();

        // Constants
        const PRICING = {
            1: { price: 80, profit: 20, supplier: 60 },
            2: { price: 150, profit: 40, supplier: 110 },
            3: { price: 220, profit: 60, supplier: 160 },
            4: { price: 280, profit: 80, supplier: 200 }
        };
        const SUPPLIER_COST_PER_ITEM = 60; 

        // State
        let appData = {
            stock: 0,
            currentTransactions: [], 
            history: [] 
        };
        
        let currentUser = null;
        let unsubscribeSnapshot = null;
        let unsubscribeProfile = null; 
        let chartInstance = null;
        let hourlyChartInstance = null;

        // --- Auth Logic ---

        window.initAuthListener = function() {
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    // CRITICAL FIX: Immediately hide Login and Show Pending status
                    // This prevents "flicker" or getting stuck on login while DB loads
                    document.getElementById('login-modal').classList.add('hidden');
                    document.getElementById('approval-modal').classList.remove('hidden');

                    // Update UI Info
                    const name = user.displayName || user.email.split('@')[0];
                    document.getElementById('profile-email').innerText = user.email;
                    document.getElementById('profile-name').innerText = name;
                    document.getElementById('profile-initial').innerText = name.charAt(0).toUpperCase();
                    document.getElementById('current-user-display').innerText = name;

                    // 1. Check/Create User Profile
                    const profileRef = window.doc(window.db, 'artifacts', window.appId, 'users', user.uid, 'settings', 'profile');
                    
                    if (unsubscribeProfile) unsubscribeProfile();
                    unsubscribeProfile = window.onSnapshot(profileRef, async (snap) => {
                        let status = 'pending';
                        
                        if (!snap.exists()) {
                            // Create default profile if missing
                            try {
                                await window.setDoc(profileRef, {
                                    name: name,
                                    email: user.email,
                                    role: 'driver',
                                    status: 'pending', // BLOCKED BY DEFAULT
                                    createdAt: Date.now()
                                });
                            } catch (e) { console.error("Profile create failed", e); }
                        } else {
                            status = snap.data().status || 'pending';
                            const role = snap.data().role || 'driver';
                            document.getElementById('profile-role').innerText = role;
                        }

                        // 2. Logic: Approved vs Pending
                        if (status === 'approved') {
                            document.getElementById('login-modal').classList.add('hidden');
                            document.getElementById('approval-modal').classList.add('hidden');
                            document.getElementById('current-user-display').classList.remove('opacity-0');
                            
                            // Start Data Sync if not already started
                            if (!unsubscribeSnapshot) startSync(user.uid);
                        } else {
                            // Block Access - Keep Approval Modal Visible
                            document.getElementById('login-modal').classList.add('hidden');
                            document.getElementById('approval-modal').classList.remove('hidden');
                        }
                    });

                } else {
                    // No user
                    currentUser = null;
                    document.getElementById('login-modal').classList.remove('hidden');
                    document.getElementById('approval-modal').classList.add('hidden');
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                    if (unsubscribeProfile) unsubscribeProfile();
                    
                    appData = { stock: 0, currentTransactions: [], history: [] };
                    updateUI();
                }
            });
        }

        window.handleGoogleLogin = async function() {
            try {
                // Show feedback during pop-up
                await window.signInWithPopup(window.auth, window.googleProvider);
            } catch (error) {
                console.error(error);
                showToast("Google Sign-In Failed: " + error.message);
            }
        }

        window.toggleAuthMode = function(mode) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');

            if (mode === 'register') {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                title.innerText = "Create Account";
                subtitle.innerText = "Join the fleet and start tracking.";
            } else {
                regForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                title.innerText = "Driver Login";
                subtitle.innerText = "Sign in to access your route data.";
            }
        }

        window.handleLogin = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('btn-login');

            if (!email || !password) {
                showToast("Please fill in all fields");
                return;
            }

            try {
                btn.innerHTML = `<span class="animate-spin mr-2">⟳</span> Signing In...`;
                await signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                console.error(error);
                showToast(error.message.replace("Firebase: ", ""));
                btn.innerHTML = `<span>Sign In</span>`;
            }
        }

        window.handleRegister = async function() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const btn = document.getElementById('btn-register');

            if (!email || !password || !name) {
                showToast("Please fill in all fields");
                return;
            }

            try {
                btn.innerHTML = `<span class="animate-spin mr-2">⟳</span> Creating...`;
                const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, { displayName: name });
                showToast("Account created! Waiting for approval.");
            } catch (error) {
                console.error(error);
                showToast(error.message.replace("Firebase: ", ""));
                btn.innerHTML = `<span>Create Account</span>`;
            }
        }

        window.logout = async function() {
            try {
                await signOut(window.auth);
                showToast("Signed out successfully");
            } catch (error) {
                showToast("Error signing out");
            }
        }

        // --- Data Sync ---

        function startSync(uid) {
            const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', uid, 'data', 'app_state');

            unsubscribeSnapshot = window.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.appData) {
                        appData = JSON.parse(data.appData);
                        if (!appData.currentTransactions) appData.currentTransactions = [];
                        updateUI();
                        document.getElementById('sync-status').classList.remove('bg-red-500');
                        document.getElementById('sync-status').classList.add('bg-green-400');
                    }
                } else {
                    saveDataToCloud(); 
                }
            }, (error) => {
                console.error("Sync Error:", error);
                document.getElementById('sync-status').classList.remove('bg-green-400');
                document.getElementById('sync-status').classList.add('bg-red-500');
            });
            showToast("Data Synced");
        }

        async function saveDataToCloud() {
            if (!currentUser) return;
            const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', currentUser.uid, 'data', 'app_state');
            try {
                await window.setDoc(docRef, {
                    lastUpdated: Date.now(),
                    appData: JSON.stringify(appData)
                });
            } catch (e) {
                console.error("Save failed", e);
                showToast("Error saving to cloud");
            }
        }

        // --- Core Functions ---

        function getTodayTotals() {
            return appData.currentTransactions.reduce((acc, t) => {
                acc.gross += t.price;
                acc.profit += t.profit;
                acc.supplier += t.supplier;
                acc.itemsSold += t.qty;
                return acc;
            }, { gross: 0, profit: 0, supplier: 0, itemsSold: 0 });
        }

        function updateUI() {
            const totals = getTodayTotals();
            document.getElementById('display-stock').innerText = appData.stock;
            document.getElementById('display-stock-value').innerText = `$${(appData.stock * SUPPLIER_COST_PER_ITEM).toLocaleString()}`;
            document.getElementById('today-gross').innerText = `$${totals.gross.toLocaleString()}`;
            document.getElementById('today-profit').innerText = `$${totals.profit.toLocaleString()}`;
            document.getElementById('today-supplier').innerText = `$${totals.supplier.toLocaleString()}`;
            document.getElementById('txn-count-badge').innerText = `${appData.currentTransactions.length} sales`;

            renderTransactionList();
            calculatePredictions(totals);
            renderHistoryList();
            
            if (document.getElementById('tab-reports').classList.contains('active')) {
                const activeBtn = document.getElementById('btn-chart-daily').classList.contains('text-blue-600') ? 'daily' : 
                                  document.getElementById('btn-chart-weekly').classList.contains('text-blue-600') ? 'weekly' : 'monthly';
                updateChart(activeBtn);
                updateHourlyChart();
            }
        }

        // --- Transaction Management ---

        function renderTransactionList() {
            const list = document.getElementById('current-transactions-list');
            list.innerHTML = '';
            if (appData.currentTransactions.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 dark:text-gray-500 text-sm py-4">No sales yet today.</div>';
                return;
            }
            const reversedTxns = [...appData.currentTransactions].reverse();
            reversedTxns.forEach(t => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700';
                item.id = `txn-${t.id}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 p-2 rounded-lg mr-3">
                            <span class="font-bold text-lg">${t.qty}</span>
                        </div>
                        <div>
                            <div class="font-medium dark:text-gray-200">Sale at ${t.time}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Profit: +$${t.profit}</div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="text-right mr-3">
                            <div class="font-bold text-gray-800 dark:text-gray-100">$${t.price}</div>
                        </div>
                        <button onclick="deleteTransaction(${t.id})" class="text-red-400 hover:text-red-600 p-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        window.deleteTransaction = function(id) {
            const index = appData.currentTransactions.findIndex(t => t.id === id);
            if (index > -1) {
                const t = appData.currentTransactions[index];
                const el = document.getElementById(`txn-${id}`);
                if (el) el.classList.add('slide-out');
                setTimeout(() => {
                    appData.stock += t.qty;
                    appData.currentTransactions.splice(index, 1);
                    saveDataToCloud();
                    showToast("Sale deleted. Stock restored.");
                }, 300);
            }
        }

        // --- Actions ---

        window.toggleStockEdit = function() {
            const displayMode = document.getElementById('stock-display-mode');
            const editMode = document.getElementById('stock-edit-mode');
            const input = document.getElementById('stock-set-input');
            if (editMode.classList.contains('hidden')) {
                displayMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                input.value = appData.stock;
                input.focus();
            } else {
                displayMode.classList.remove('hidden');
                editMode.classList.add('hidden');
            }
        }

        window.saveStockEdit = function() {
            const input = document.getElementById('stock-set-input');
            const qty = parseInt(input.value);
            if (isNaN(qty) || qty < 0) { showToast("Please enter a valid stock number."); return; }
            appData.stock = qty;
            saveDataToCloud();
            toggleStockEdit();
            showToast("Stock updated manually.");
        }

        window.addStock = function() {
            const input = document.getElementById('stock-add-input');
            const qty = parseInt(input.value);
            if (isNaN(qty) || qty <= 0) { showToast("Please enter a valid quantity."); return; }
            appData.stock += qty;
            input.value = '';
            saveDataToCloud();
            showToast(`Added ${qty} items to stock.`);
        }

        window.sellItem = function(qty) {
            if (appData.stock < qty) { showToast(`Not enough stock! You only have ${appData.stock} left.`); return; }
            const tier = PRICING[qty];
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const transaction = { id: Date.now(), timestamp: now.getTime(), hour: now.getHours(), time: timeStr, qty: qty, price: tier.price, profit: tier.profit, supplier: tier.supplier };
            appData.stock -= qty;
            appData.currentTransactions.push(transaction);
            saveDataToCloud();
            showToast(`Sold ${qty} item(s) for $${tier.price}`);
        }

        window.endDay = function() {
            const totals = getTodayTotals();
            if (appData.currentTransactions.length === 0) { showToast("No sales to save today."); return; }
            const todayDate = new Date().toISOString().split('T')[0]; 
            const hourlyDist = {};
            appData.currentTransactions.forEach(t => {
                const h = t.hour || new Date(t.timestamp).getHours();
                hourlyDist[h] = (hourlyDist[h] || 0) + t.qty;
            });
            const existingRecordIndex = appData.history.findIndex(h => h.date === todayDate);
            if (existingRecordIndex >= 0) {
                const rec = appData.history[existingRecordIndex];
                rec.gross += totals.gross; rec.profit += totals.profit; rec.supplier += totals.supplier; rec.itemsSold += totals.itemsSold;
                for (const [hour, count] of Object.entries(hourlyDist)) {
                    rec.hourlyDistribution = rec.hourlyDistribution || {};
                    rec.hourlyDistribution[hour] = (rec.hourlyDistribution[hour] || 0) + count;
                }
            } else {
                appData.history.push({ date: todayDate, ...totals, hourlyDistribution: hourlyDist });
            }
            appData.currentTransactions = [];
            saveDataToCloud();
            showToast("Shift saved successfully!");
            if (document.getElementById('tab-reports').classList.contains('active')) { updateChart('daily'); updateHourlyChart(); }
        }

        // --- Reports & Charts ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay() || 7; 
            if (day !== 1) d.setHours(-24 * (day - 1));
            return d.toISOString().split('T')[0];
        }

        function calculatePredictions(currentTotals) {
            const totalProfitToday = currentTotals.profit;
            if (appData.history.length === 0 && totalProfitToday === 0) {
                document.getElementById('predicted-earnings').innerText = "$0"; return;
            }
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const startOfWeek = getStartOfWeek(today);
            let profitThisWeek = 0;
            appData.history.forEach(record => {
                if (record.date >= startOfWeek && record.date <= todayStr) { profitThisWeek += record.profit; }
            });
            profitThisWeek += totalProfitToday;
            let daysElapsed = today.getDay() || 7; daysElapsed = Math.max(1, daysElapsed);
            const dailyAverage = profitThisWeek / daysElapsed;
            const predictedWeekly = Math.round(dailyAverage * 7);
            document.getElementById('predicted-earnings').innerText = `$${predictedWeekly.toLocaleString()}`;
            document.getElementById('prediction-context').innerText = `Based on $${Math.round(dailyAverage)}/day average this week`;
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            if (appData.history.length === 0) { list.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No saved records yet.</p>'; return; }
            const sortedHistory = [...appData.history].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedHistory.slice(0, 10).forEach(record => {
                const dateObj = new Date(record.date); dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg transition-colors';
                div.innerHTML = `<div><div class="font-medium text-gray-800 dark:text-gray-200 text-sm">${dateStr}</div><div class="text-xs text-gray-500 dark:text-gray-400">${record.itemsSold} items sold</div></div><div class="text-right"><div class="font-bold text-green-600 dark:text-green-400 text-sm">+$${record.profit}</div><div class="text-xs text-gray-500 dark:text-gray-400">Gross: $${record.gross}</div></div>`;
                list.appendChild(div);
            });
        }

        window.updateHourlyChart = function() {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (hourlyChartInstance) hourlyChartInstance.destroy();
            const hourlyTotals = new Array(24).fill(0);
            appData.history.forEach(rec => { if (rec.hourlyDistribution) { for (const [hour, count] of Object.entries(rec.hourlyDistribution)) { hourlyTotals[parseInt(hour)] += count; } } });
            appData.currentTransactions.forEach(t => { const h = t.hour || new Date(t.timestamp).getHours(); hourlyTotals[h] += t.qty; });
            const labels = hourlyTotals.map((_, i) => { const d = new Date(); d.setHours(i); return d.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }); });
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#374151' : '#f3f4f6'; const textColor = isDark ? '#9ca3af' : '#6b7280';
            const gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
            hourlyChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Total Items Sold', data: hourlyTotals, borderColor: '#3b82f6', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor, maxTicksLimit: 8 } } } } });
        }

        window.updateChart = function(viewMode) {
            ['daily', 'weekly', 'monthly'].forEach(mode => { const btn = document.getElementById(`btn-chart-${mode}`); if (mode === viewMode) { btn.className = 'flex-1 py-1 text-sm rounded-md bg-white dark:bg-gray-600 shadow text-blue-600 dark:text-blue-400 font-medium transition'; } else { btn.className = 'flex-1 py-1 text-sm rounded-md text-gray-500 dark:text-gray-400 font-medium transition'; } });
            const ctx = document.getElementById('salesChart').getContext('2d'); if (chartInstance) chartInstance.destroy();
            let labels = [], profitData = [], grossData = []; const todayTotals = getTodayTotals();
            if (viewMode === 'daily') { const last7Days = []; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); last7Days.push(d.toISOString().split('T')[0]); } labels = last7Days.map(d => { let date = new Date(d); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); return date.toLocaleDateString('en-US', { weekday: 'short' }); }); last7Days.forEach(dateStr => { const record = appData.history.find(h => h.date === dateStr); let profit = record ? record.profit : 0; let gross = record ? record.gross : 0; const todayStr = new Date().toISOString().split('T')[0]; if (dateStr === todayStr) { profit += todayTotals.profit; gross += todayTotals.gross; } profitData.push(profit); grossData.push(gross); }); } 
            else if (viewMode === 'weekly') { labels = ['Week -3', 'Week -2', 'Last Week', 'This Week']; profitData = [0, 0, 0, 0]; grossData = [0, 0, 0, 0]; const today = new Date(); const allData = [...appData.history]; if (todayTotals.gross > 0) allData.push({ date: today.toISOString().split('T')[0], ...todayTotals }); allData.forEach(record => { const rDate = new Date(record.date); const diffTime = Math.abs(today - rDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays <= 7) { profitData[3] += record.profit; grossData[3] += record.gross; } else if (diffDays <= 14) { profitData[2] += record.profit; grossData[2] += record.gross; } else if (diffDays <= 21) { profitData[1] += record.profit; grossData[1] += record.gross; } else if (diffDays <= 28) { profitData[0] += record.profit; grossData[0] += record.gross; } }); } 
            else if (viewMode === 'monthly') { labels = []; profitData = [0, 0, 0, 0, 0, 0]; grossData = [0, 0, 0, 0, 0, 0]; for (let i = 5; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); labels.push(d.toLocaleDateString('en-US', { month: 'short' })); } const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear(); const allData = [...appData.history]; if (todayTotals.gross > 0) allData.push({ date: new Date().toISOString().split('T')[0], ...todayTotals }); allData.forEach(record => { const rDate = new Date(record.date); rDate.setMinutes(rDate.getMinutes() + rDate.getTimezoneOffset()); const monthDiff = (currentYear - rDate.getFullYear()) * 12 + (currentMonth - rDate.getMonth()); if (monthDiff >= 0 && monthDiff <= 5) { const index = 5 - monthDiff; profitData[index] += record.profit; grossData[index] += record.gross; } }); }
            const isDark = document.documentElement.classList.contains('dark'); const gridColor = isDark ? '#374151' : '#f3f4f6'; const textColor = isDark ? '#9ca3af' : '#6b7280';
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Profit', data: profitData, backgroundColor: 'rgba(34, 197, 94, 0.8)', borderRadius: 4, order: 1 }, { label: 'Gross', data: grossData, backgroundColor: isDark ? 'rgba(75, 85, 99, 0.8)' : 'rgba(209, 213, 219, 0.6)', borderRadius: 4, order: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, color: textColor } } }, scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4], color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } } } });
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            const navIds = ['sales', 'reports', 'settings'];
            navIds.forEach(id => { const el = document.getElementById(`nav-${id}`); if (id === tabName) { el.classList.remove('text-gray-400', 'dark:text-gray-500'); el.classList.add('text-blue-600', 'dark:text-blue-400'); } else { el.classList.remove('text-blue-600', 'dark:text-blue-400'); el.classList.add('text-gray-400', 'dark:text-gray-500'); } });
            if (tabName === 'reports') { const activeBtn = document.getElementById('btn-chart-daily').classList.contains('text-blue-600') ? 'daily' : document.getElementById('btn-chart-weekly').classList.contains('text-blue-600') ? 'weekly' : 'monthly'; updateChart(activeBtn); updateHourlyChart(); }
        }

        window.toggleTheme = function() {
            document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); const icon = document.getElementById('theme-icon'); if(icon) { icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon'); lucide.createIcons(); }
            if (document.getElementById('tab-reports').classList.contains('active')) { const activeBtn = document.getElementById('btn-chart-daily').classList.contains('text-blue-600') ? 'daily' : document.getElementById('btn-chart-weekly').classList.contains('text-blue-600') ? 'weekly' : 'monthly'; updateChart(activeBtn); updateHourlyChart(); }
        }

        window.showToast = function(message) { const toast = document.getElementById("toast"); toast.innerText = message; toast.className = "show"; setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000); }

        // Boot
        window.onload = function() {
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            document.getElementById('current-date-header').innerText = new Date().toLocaleDateString('en-US', options);
            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.getElementById('theme-icon');
            if(themeIcon) { themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon'); lucide.createIcons(); }
            initAuthListener();
        };
    </script>
</body>
</html>