<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales & Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for mobile app feel */
        body {
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 90px;
        }

        /* Slide to delete animation */
        .slide-out {
            animation: slideOut 0.3s forwards;
        }
        @keyframes slideOut {
            to { transform: translateX(100%); opacity: 0; height: 0; margin: 0; padding: 0; }
        }
    </style>
    <script>
        // Check theme before render to prevent flashing
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="text-gray-800 dark:text-gray-100 dark:bg-gray-900 pb-24 transition-colors duration-200">

    <!-- App Container -->
    <div class="max-w-md mx-auto bg-gray-50 dark:bg-gray-900 min-h-screen shadow-xl relative transition-colors duration-200">
        
        <!-- Header -->
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md transition-colors duration-200">
            <h1 class="text-xl font-bold text-center">Sales Tracker</h1>
            <p id="current-date-header" class="text-center text-sm text-blue-200 dark:text-gray-400"></p>
            <button onclick="toggleTheme()" class="absolute right-4 top-4 p-1 rounded-full hover:bg-white/20 transition">
                <i data-lucide="moon" id="theme-icon" class="w-5 h-5 text-white"></i>
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="p-4">
            
            <!-- TAB 1: SALES & TERMINAL -->
            <div id="tab-sales" class="tab-content active">
                
                <!-- Stock Management Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-2 flex items-center justify-between">
                        <div class="flex items-center"><i data-lucide="package" class="w-5 h-5 mr-2"></i> Inventory</div>
                        <button onclick="toggleStockEdit()" class="text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded text-gray-600 dark:text-gray-300 transition flex items-center">
                            <i data-lucide="edit-2" class="w-3 h-3 mr-1"></i> Edit
                        </button>
                    </h2>
                    
                    <!-- Stock Display Mode -->
                    <div id="stock-display-mode">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-3xl font-bold dark:text-white" id="display-stock">0</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Items in Stock</span>
                        </div>
                        <div class="flex space-x-2">
                            <input type="number" id="stock-add-input" placeholder="Qty to add" class="flex-1 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" min="1">
                            <button onclick="addStock()" class="bg-blue-600 dark:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium active:bg-blue-700 transition">Add</button>
                        </div>
                    </div>

                    <!-- Stock Edit Mode (Hidden by default) -->
                    <div id="stock-edit-mode" class="hidden">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Set exact stock count:</p>
                        <div class="flex space-x-2">
                            <input type="number" id="stock-set-input" class="flex-1 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-green-500">
                            <button onclick="saveStockEdit()" class="bg-green-600 dark:bg-green-500 text-white px-4 py-2 rounded-lg font-medium active:bg-green-700 transition">Set</button>
                            <button onclick="toggleStockEdit()" class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg font-medium">Cancel</button>
                        </div>
                    </div>

                    <div class="mt-3 text-sm text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-2 rounded flex justify-between">
                        <span>Value of Unsold Stock:</span>
                        <span id="display-stock-value" class="font-semibold text-gray-700 dark:text-gray-200">$0</span>
                    </div>
                </div>

                <!-- Sell Terminal Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-3 flex items-center">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-2"></i> Quick Sell
                    </h2>
                    
                    <button onclick="sellItem('1_full')" class="w-full mb-3 border-2 border-blue-100 dark:border-blue-900/50 hover:border-blue-500 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-center active:bg-blue-200 dark:active:bg-blue-900/40 transition">
                        <div class="font-bold text-lg text-blue-800 dark:text-blue-400">1 Item</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">$80</div>
                    </button>

                    <div class="grid grid-cols-2 gap-x-2 gap-y-3 mb-2">
                        <!-- Headers -->
                        <div class="text-[10px] text-center font-bold text-gray-400 dark:text-gray-500 col-span-1 uppercase tracking-widest border-b border-gray-200 dark:border-gray-700 pb-1">Deal Price</div>
                        <div class="text-[10px] text-center font-bold text-gray-400 dark:text-gray-500 col-span-1 uppercase tracking-widest border-b border-gray-200 dark:border-gray-700 pb-1">Full Price</div>

                        <!-- 2 Items -->
                        <button onclick="sellItem('2_deal')" class="border-2 border-green-100 dark:border-green-900/50 hover:border-green-500 bg-green-50 dark:bg-green-900/20 rounded-lg py-3 px-1 text-center active:bg-green-200 dark:active:bg-green-900/40 transition flex flex-col items-center justify-center">
                            <div class="font-bold text-md text-green-800 dark:text-green-400">2 Items</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$150</div>
                        </button>
                        <button onclick="sellItem('2_full')" class="border-2 border-green-200 dark:border-green-800 hover:border-green-500 bg-white dark:bg-gray-800 rounded-lg py-3 px-1 text-center active:bg-green-50 dark:active:bg-gray-700 transition flex flex-col items-center justify-center relative overflow-hidden shadow-sm">
                            <div class="absolute top-0 right-0 bg-green-500 text-white text-[9px] px-1.5 py-0.5 rounded-bl font-bold tracking-wide">+$10 Profit</div>
                            <div class="font-bold text-md text-gray-800 dark:text-gray-200">2 Items</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">$160</div>
                        </button>

                        <!-- 3 Items -->
                        <button onclick="sellItem('3_deal')" class="border-2 border-purple-100 dark:border-purple-900/50 hover:border-purple-500 bg-purple-50 dark:bg-purple-900/20 rounded-lg py-3 px-1 text-center active:bg-purple-200 dark:active:bg-purple-900/40 transition flex flex-col items-center justify-center">
                            <div class="font-bold text-md text-purple-800 dark:text-purple-400">3 Items</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$220</div>
                        </button>
                        <button onclick="sellItem('3_full')" class="border-2 border-purple-200 dark:border-purple-800 hover:border-purple-500 bg-white dark:bg-gray-800 rounded-lg py-3 px-1 text-center active:bg-purple-50 dark:active:bg-gray-700 transition flex flex-col items-center justify-center relative overflow-hidden shadow-sm">
                            <div class="absolute top-0 right-0 bg-purple-500 text-white text-[9px] px-1.5 py-0.5 rounded-bl font-bold tracking-wide">+$20 Profit</div>
                            <div class="font-bold text-md text-gray-800 dark:text-gray-200">3 Items</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">$240</div>
                        </button>

                        <!-- 4 Items -->
                        <button onclick="sellItem('4_deal')" class="border-2 border-orange-100 dark:border-orange-900/50 hover:border-orange-500 bg-orange-50 dark:bg-orange-900/20 rounded-lg py-3 px-1 text-center active:bg-orange-200 dark:active:bg-orange-900/40 transition flex flex-col items-center justify-center">
                            <div class="font-bold text-md text-orange-800 dark:text-orange-400">4 Items</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">$280</div>
                        </button>
                        <button onclick="sellItem('4_full')" class="border-2 border-orange-200 dark:border-orange-800 hover:border-orange-500 bg-white dark:bg-gray-800 rounded-lg py-3 px-1 text-center active:bg-orange-50 dark:active:bg-gray-700 transition flex flex-col items-center justify-center relative overflow-hidden shadow-sm">
                            <div class="absolute top-0 right-0 bg-orange-500 text-white text-[9px] px-1.5 py-0.5 rounded-bl font-bold tracking-wide">+$40 Profit</div>
                            <div class="font-bold text-md text-gray-800 dark:text-gray-200">4 Items</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">$320</div>
                        </button>
                    </div>
                </div>

                <!-- Today's Transactions (Editable) -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-3 flex items-center justify-between">
                        <div class="flex items-center"><i data-lucide="list" class="w-5 h-5 mr-2"></i> Today's Sales</div>
                        <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-300 px-2 py-1 rounded-full" id="txn-count-badge">0 sales</span>
                    </h2>
                    
                    <!-- Stats Summary Mini -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded border border-green-100 dark:border-green-900/30 text-center">
                             <div class="text-xs text-green-600 dark:text-green-400 uppercase">Profit</div>
                             <div class="font-bold text-green-700 dark:text-green-300" id="today-profit">$0</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded border border-gray-100 dark:border-gray-600 text-center">
                             <div class="text-xs text-gray-500 dark:text-gray-400 uppercase">Gross</div>
                             <div class="font-bold text-gray-700 dark:text-white" id="today-gross">$0</div>
                        </div>
                    </div>

                    <!-- Transaction List -->
                    <div id="current-transactions-list" class="space-y-2 max-h-48 overflow-y-auto hide-scrollbar mb-4">
                        <!-- Items injected here -->
                        <div class="text-center text-gray-400 text-sm py-4">No sales yet today.</div>
                    </div>

                    <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg flex justify-between items-center mb-4 border border-red-100 dark:border-red-900/30">
                        <div class="text-xs text-red-600 dark:text-red-400 uppercase tracking-wide font-medium">Supplier Funds</div>
                        <div class="text-xl font-bold text-red-700 dark:text-red-400" id="today-supplier">$0</div>
                    </div>

                    <button onclick="showEndDaySummary()" class="w-full bg-gray-800 dark:bg-gray-700 text-white py-3 rounded-lg font-bold shadow-md active:bg-gray-900 dark:active:bg-gray-600 transition flex justify-center items-center">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save Day & Reset Shift
                    </button>
                </div>
            </div>

            <!-- TAB 2: REPORTS & ANALYTICS -->
            <div id="tab-reports" class="tab-content">
                
                <!-- Predictions Card -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-800 dark:to-indigo-900 rounded-xl shadow-sm p-5 mb-4 text-white">
                    <h2 class="font-semibold text-blue-100 dark:text-blue-200 mb-1 flex items-center text-sm uppercase tracking-wider">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i> Predicted Weekly Profit
                    </h2>
                    <div class="text-3xl font-bold mb-1" id="predicted-earnings">$0</div>
                    <p class="text-xs text-blue-200 dark:text-blue-300" id="prediction-context">Based on average sales this week</p>
                </div>

                <!-- Financial Charts Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h3 class="font-semibold text-gray-600 dark:text-gray-300 mb-4 text-sm uppercase">Financial Performance</h3>
                    <div class="flex space-x-2 mb-4 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                        <button onclick="updateChart('daily')" id="btn-chart-daily" class="flex-1 py-1 text-sm rounded-md bg-white dark:bg-gray-600 shadow text-blue-600 dark:text-blue-400 font-medium transition">Daily</button>
                        <button onclick="updateChart('weekly')" id="btn-chart-weekly" class="flex-1 py-1 text-sm rounded-md text-gray-500 dark:text-gray-400 font-medium transition">Weekly</button>
                        <button onclick="updateChart('monthly')" id="btn-chart-monthly" class="flex-1 py-1 text-sm rounded-md text-gray-500 dark:text-gray-400 font-medium transition">Monthly</button>
                    </div>
                    
                    <div class="relative h-56 w-full">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <!-- Hourly Analysis Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                     <h3 class="font-semibold text-gray-600 dark:text-gray-300 mb-2 text-sm uppercase flex items-center">
                         <i data-lucide="clock" class="w-4 h-4 mr-2"></i> Busiest Times (Hourly)
                     </h3>
                     <p class="text-xs text-gray-400 mb-4">Total items sold by hour of day</p>
                     <div class="relative h-48 w-full">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>

                <!-- History List -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-3">Recent Days</h2>
                    <div id="history-list" class="space-y-3 max-h-60 overflow-y-auto hide-scrollbar">
                        <!-- History items injected here -->
                    </div>
                </div>
            </div>

            <!-- TAB 3: CALCULATOR -->
            <div id="tab-calculator" class="tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-4 flex items-center">
                        <i data-lucide="calculator" class="w-5 h-5 mr-2"></i> Supplier Ledger & Cash
                    </h2>
                    
                    <!-- Debt Ledger Section -->
                    <div class="bg-red-50 dark:bg-red-900/10 rounded-lg p-3 mb-4 border border-red-100 dark:border-red-900/30">
                        <h3 class="text-xs font-bold text-red-800 dark:text-red-400 uppercase mb-3 flex items-center"><i data-lucide="trending-up" class="w-4 h-4 mr-1"></i> Supplier Debt</h3>
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Previous Unpaid Debt</span>
                            <span class="font-bold text-gray-800 dark:text-gray-100" id="calc-carried-debt">$0</span>
                        </div>
                        <div class="flex justify-between items-center mb-4 pb-3 border-b border-red-200 dark:border-red-900/40">
                            <span class="text-sm text-red-700 dark:text-red-400">Today's Auto-Debt (Sales)</span>
                            <span class="font-bold text-red-700 dark:text-red-400" id="calc-auto-owed">$0</span>
                        </div>

                        <!-- Custom Debt Addition -->
                        <div class="mb-2">
                            <span class="text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase block mb-1">Add Custom Debt</span>
                            <div class="flex space-x-2">
                                <input type="text" id="new-custom-debt-desc" placeholder="Reason..." class="flex-1 w-1/2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1.5 text-sm outline-none focus:ring-1 focus:ring-red-400">
                                <input type="number" id="new-custom-debt-amount" placeholder="$ Amount" class="w-24 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1.5 text-sm outline-none focus:ring-1 focus:ring-red-400">
                                <button onclick="addCustomDebt()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded font-medium transition shadow-sm"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        
                        <!-- List of Custom Debts -->
                        <div id="list-custom-debts" class="mb-3 space-y-1"></div>

                        <div class="pt-2 flex justify-between items-center bg-white dark:bg-gray-800 p-2 rounded shadow-sm border border-red-100 dark:border-red-900/50">
                            <span class="text-xs font-bold text-red-800 dark:text-red-300 uppercase tracking-wide">Total Gross Debt</span>
                            <span class="font-bold text-red-800 dark:text-red-400 text-lg" id="calc-total-gross-debt">$0</span>
                        </div>
                    </div>

                    <!-- Payments Ledger Section -->
                    <div class="bg-green-50 dark:bg-green-900/10 rounded-lg p-3 mb-4 border border-green-100 dark:border-green-900/30">
                        <h3 class="text-xs font-bold text-green-800 dark:text-green-400 uppercase mb-3 flex items-center"><i data-lucide="trending-down" class="w-4 h-4 mr-1"></i> Payments Made</h3>
                        
                        <div class="mb-2 flex space-x-2">
                            <div class="flex-1 text-sm text-gray-600 dark:text-gray-300 py-1.5">Money Paid to Supplier</div>
                            <input type="number" id="new-payment-amount" placeholder="$ Amount" class="w-24 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded px-2 py-1.5 text-sm outline-none focus:ring-1 focus:ring-green-400">
                            <button onclick="addSupplierPayment()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded font-medium transition shadow-sm"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                        
                        <!-- List of Payments -->
                        <div id="list-payments" class="mb-3 space-y-1"></div>

                        <div class="pt-2 flex justify-between items-center bg-white dark:bg-gray-800 p-2 rounded shadow-sm border border-green-100 dark:border-green-900/50">
                            <span class="text-xs font-bold text-green-800 dark:text-green-300 uppercase tracking-wide">Total Paid Today</span>
                            <span class="font-bold text-green-800 dark:text-green-400 text-lg" id="calc-total-payments">$0</span>
                        </div>
                    </div>

                    <!-- Net Owed -->
                    <div class="bg-gray-800 dark:bg-gray-900 rounded-lg p-4 mb-5 shadow-inner text-white flex justify-between items-center border border-gray-700">
                        <div>
                            <span class="text-sm text-gray-200 block font-bold uppercase tracking-wide">Net Amount Owed</span>
                            <span class="text-[10px] text-gray-400">Total Debt minus Payments</span>
                        </div>
                        <span class="font-bold text-2xl text-blue-400" id="calc-net-owed">$0</span>
                    </div>

                    <!-- Funds Section -->
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Assets On Hand</h3>
                            <div class="text-xs font-bold text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded border border-green-100 dark:border-green-900/30" id="calc-total-assets">Combined: $0</div>
                        </div>
                        <div class="flex space-x-2">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 block mb-1">CASH AMOUNT</label>
                                <input type="number" id="calc-cash" oninput="appData.calcCash = this.value; localStorage.setItem('salesAppData', JSON.stringify(appData)); calculateReconciliation();" placeholder="0" class="w-full border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-green-700 dark:text-green-400 font-bold rounded-lg px-3 py-3 outline-none transition-colors">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs font-bold text-gray-500 dark:text-gray-400 block mb-1">BANK BALANCE</label>
                                <input type="number" id="calc-bank" oninput="appData.calcBank = this.value; localStorage.setItem('salesAppData', JSON.stringify(appData)); calculateReconciliation();" placeholder="0" class="w-full border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white text-green-700 dark:text-green-400 font-bold rounded-lg px-3 py-3 outline-none transition-colors">
                            </div>
                        </div>
                        <button onclick="transferBankToCash()" class="w-full mt-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-3 rounded-lg text-sm font-bold transition flex items-center justify-center shadow-sm">
                            <i data-lucide="arrow-left-right" class="w-4 h-4 mr-2"></i> Transfer Bank to Cash
                        </button>
                    </div>

                    <!-- Results Section -->
                    <div class="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 border border-gray-200 dark:border-gray-700 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium" id="calc-status-label">Status</span>
                            <span class="font-bold text-2xl" id="calc-status-value">$0</span>
                        </div>
                    </div>

                    <!-- AI Advisor Section -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-lg p-4 border border-indigo-100 dark:border-indigo-800/50 shadow-sm relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 opacity-10">
                            <i data-lucide="sparkles" class="w-24 h-24 text-indigo-500"></i>
                        </div>
                        <div class="flex justify-between items-center mb-3 relative z-10">
                            <h3 class="text-xs font-bold text-indigo-800 dark:text-indigo-300 uppercase flex items-center">
                                <i data-lucide="bot" class="w-4 h-4 mr-1.5"></i> AI Financial Advisor
                            </h3>
                            <button id="btn-ai-advisor" onclick="generateAIFinancialAdvice()" class="text-[10px] font-bold bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white px-2.5 py-1.5 rounded shadow-sm transition flex items-center disabled:opacity-70 disabled:cursor-not-allowed">
                                âœ¨ Get Insight
                            </button>
                        </div>
                        <p id="ai-advisor-output" class="text-sm text-gray-700 dark:text-gray-300 italic relative z-10 leading-relaxed">
                            Click the button above to get AI-powered insights on your current ledger balance, debt, and cash flow.
                        </p>
                    </div>
                </div>
            </div>

            <!-- TAB 4: SETTINGS -->
            <div id="tab-settings" class="tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700 transition-colors">
                    <h2 class="font-semibold text-gray-600 dark:text-gray-300 mb-4 flex items-center">
                        <i data-lucide="database" class="w-5 h-5 mr-2"></i> Data Management
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Save a backup of all your sales data to your device.</p>
                            <button onclick="exportData()" class="w-full bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border border-blue-200 dark:border-blue-800 py-3 rounded-lg font-medium active:bg-blue-100 dark:active:bg-blue-900/50 transition flex justify-center items-center">
                                <i data-lucide="download" class="w-5 h-5 mr-2"></i> Export Data (JSON)
                            </button>
                        </div>
                        
                        <hr class="border-gray-100 dark:border-gray-700">
                        
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Restore data from a previously exported file.</p>
                            <label class="w-full bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-600 py-3 rounded-lg font-medium active:bg-gray-100 dark:active:bg-gray-600 transition flex justify-center items-center cursor-pointer">
                                <i data-lucide="upload" class="w-5 h-5 mr-2"></i> Import Data
                                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-red-50 dark:bg-red-900/20 rounded-xl shadow-sm p-4 border border-red-100 dark:border-red-900/50 mt-8 transition-colors">
                    <h2 class="font-semibold text-red-700 dark:text-red-500 mb-2 flex items-center">
                        <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> Danger Zone
                    </h2>
                    <p class="text-xs text-red-600 dark:text-red-400 mb-3">This will permanently delete all stock and sales history. Export your data first!</p>
                    <button onclick="resetApp()" class="w-full bg-red-600 dark:bg-red-700 text-white py-3 rounded-lg font-bold shadow-sm active:bg-red-700 transition">
                        Factory Reset App
                    </button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-around pb-safe pt-2 px-2 z-50 transition-colors">
            <button onclick="switchTab('sales')" id="nav-sales" class="flex flex-col items-center p-2 text-blue-600 dark:text-blue-400 w-1/4">
                <i data-lucide="layout-dashboard" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Sales</span>
            </button>
            <button onclick="switchTab('reports')" id="nav-reports" class="flex flex-col items-center p-2 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 w-1/4 transition">
                <i data-lucide="pie-chart" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Reports</span>
            </button>
            <button onclick="switchTab('calculator')" id="nav-calculator" class="flex flex-col items-center p-2 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 w-1/4 transition">
                <i data-lucide="calculator" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Calculator</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center p-2 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 w-1/4 transition">
                <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-medium">Settings</span>
            </button>
        </nav>
        
        <!-- Toast Element -->
        <div id="toast">Message here</div>

        <!-- End of Day Summary Modal -->
        <div id="end-day-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh] animate-[fadeIn_0.2s_ease-out]">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center">
                        <i data-lucide="file-text" class="w-5 h-5 mr-2 text-blue-500"></i> Shift Summary
                    </h2>
                    <button onclick="closeEndDaySummary()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="p-4 overflow-y-auto flex-1 hide-scrollbar">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Items Sold Breakdown</h3>
                    <div id="summary-breakdown-list" class="mb-5 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                        <!-- Injected via JS -->
                    </div>

                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Final Financials</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-100 dark:border-gray-700">
                            <span class="text-gray-600 dark:text-gray-300 font-medium">Gross Total (Cash)</span>
                            <span class="font-bold text-gray-900 dark:text-white text-lg" id="summary-total-gross">$0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-900/30">
                            <span class="text-red-700 dark:text-red-400 font-medium flex items-center"><i data-lucide="corner-down-right" class="w-4 h-4 mr-1"></i> Owed to Supplier</span>
                            <span class="font-bold text-red-700 dark:text-red-400 text-lg" id="summary-total-supplier">$0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-900/50 shadow-sm mt-2">
                            <span class="text-green-700 dark:text-green-400 font-bold flex items-center"><i data-lucide="wallet" class="w-4 h-4 mr-2"></i> Your Final Profit</span>
                            <span class="font-bold text-green-700 dark:text-green-400 text-2xl" id="summary-total-profit">$0</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex space-x-3">
                    <button onclick="closeEndDaySummary()" class="flex-1 py-3 rounded-lg font-medium text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 active:bg-gray-100 dark:active:bg-gray-700 transition">Go Back</button>
                    <button onclick="confirmEndDay()" class="flex-1 py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 active:bg-blue-800 transition flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> Confirm Save
                    </button>
                </div>
            </div>
        </div>

        <!-- History Detail Modal -->
        <div id="history-detail-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh] animate-[fadeIn_0.2s_ease-out]">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center">
                            <i data-lucide="calendar" class="w-5 h-5 mr-2 text-blue-500"></i> Day Record
                        </h2>
                        <p id="history-modal-date" class="text-xs text-gray-500 dark:text-gray-400 mt-1"></p>
                    </div>
                    <button onclick="closeHistoryDetail()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="p-4 overflow-y-auto flex-1 hide-scrollbar">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Items Sold Breakdown</h3>
                    <div id="history-breakdown-list" class="mb-5 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                        <!-- Injected via JS -->
                    </div>

                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Final Financials</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-900/50 rounded-xl border border-gray-100 dark:border-gray-700">
                            <span class="text-gray-600 dark:text-gray-300 font-medium">Gross Total (Cash)</span>
                            <span class="font-bold text-gray-900 dark:text-white text-lg" id="history-total-gross">$0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-900/30">
                            <span class="text-red-700 dark:text-red-400 font-medium flex items-center"><i data-lucide="corner-down-right" class="w-4 h-4 mr-1"></i> Owed to Supplier</span>
                            <span class="font-bold text-red-700 dark:text-red-400 text-lg" id="history-total-supplier">$0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-900/50 shadow-sm mt-2">
                            <span class="text-green-700 dark:text-green-400 font-bold flex items-center"><i data-lucide="wallet" class="w-4 h-4 mr-2"></i> Total Profit</span>
                            <span class="font-bold text-green-700 dark:text-green-400 text-2xl" id="history-total-profit">$0</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                    <button onclick="closeHistoryDetail()" class="w-full py-3 rounded-lg font-medium text-white bg-gray-800 dark:bg-gray-700 hover:bg-gray-900 dark:hover:bg-gray-600 transition">Close Record</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // Advanced Pricing Model
        // Supplier amount is LOCKED to the deal amount, any overpayment from "full" goes strictly to your profit.
        const PRICING = {
            '1_full': { qty: 1, label: '1 Item', price: 80, profit: 20, supplier: 60 },
            '2_deal': { qty: 2, label: '2 Items (Deal)', price: 150, profit: 40, supplier: 110 },
            '2_full': { qty: 2, label: '2 Items (Full)', price: 160, profit: 50, supplier: 110 },
            '3_deal': { qty: 3, label: '3 Items (Deal)', price: 220, profit: 60, supplier: 160 },
            '3_full': { qty: 3, label: '3 Items (Full)', price: 240, profit: 80, supplier: 160 },
            '4_deal': { qty: 4, label: '4 Items (Deal)', price: 280, profit: 80, supplier: 200 },
            '4_full': { qty: 4, label: '4 Items (Full)', price: 320, profit: 120, supplier: 200 }
        };
        const SUPPLIER_COST_PER_ITEM = 60; // Base inventory value cost

        // State Management
        let appData = {
            stock: 0,
            currentTransactions: [],
            history: [],
            carriedDebt: 0,
            customDebts: [],
            supplierPayments: [],
            calcCash: '',
            calcBank: ''
        };

        let chartInstance = null;
        let hourlyChartInstance = null;

        // Initialize App
        function initApp() {
            const savedData = localStorage.getItem('salesAppData');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                appData = { ...appData, ...parsed }; // Merge to preserve defaults
                if (!appData.currentTransactions) appData.currentTransactions = [];
                if (appData.carriedDebt === undefined) appData.carriedDebt = 0;
                if (!appData.customDebts) appData.customDebts = [];
                if (!appData.supplierPayments) appData.supplierPayments = [];
            }
            
            // Set Header Date
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            document.getElementById('current-date-header').innerText = new Date().toLocaleDateString('en-US', options);

            // Restore Calc Inputs
            if (appData.calcCash !== undefined) document.getElementById('calc-cash').value = appData.calcCash;
            if (appData.calcBank !== undefined) document.getElementById('calc-bank').value = appData.calcBank;

            const isDark = document.documentElement.classList.contains('dark');
            const themeIcon = document.getElementById('theme-icon');
            if(themeIcon) {
                themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
            }

            updateUI();
        }

        function saveData() {
            localStorage.setItem('salesAppData', JSON.stringify(appData));
            updateUI();
        }

        function getTodayTotals() {
            return appData.currentTransactions.reduce((acc, t) => {
                acc.gross += t.price;
                acc.profit += t.profit;
                acc.supplier += t.supplier;
                acc.itemsSold += t.qty;
                return acc;
            }, { gross: 0, profit: 0, supplier: 0, itemsSold: 0 });
        }

        function updateUI() {
            const totals = getTodayTotals();

            document.getElementById('display-stock').innerText = appData.stock;
            document.getElementById('display-stock-value').innerText = `$${(appData.stock * SUPPLIER_COST_PER_ITEM).toLocaleString()}`;
            
            document.getElementById('today-gross').innerText = `$${totals.gross.toLocaleString()}`;
            document.getElementById('today-profit').innerText = `$${totals.profit.toLocaleString()}`;
            document.getElementById('today-supplier').innerText = `$${totals.supplier.toLocaleString()}`;
            document.getElementById('txn-count-badge').innerText = `${appData.currentTransactions.length} sales`;

            renderTransactionList();
            calculatePredictions(totals);
            renderHistoryList();
            calculateReconciliation();
        }

        // --- Transaction Management ---

        function renderTransactionList() {
            const list = document.getElementById('current-transactions-list');
            list.innerHTML = '';

            if (appData.currentTransactions.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 dark:text-gray-500 text-sm py-4">No sales yet today.</div>';
                return;
            }

            const reversedTxns = [...appData.currentTransactions].reverse();

            reversedTxns.forEach(t => {
                const label = t.label || `${t.qty} Item(s)`; // Fallback for older saved data
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700';
                item.id = `txn-${t.id}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 p-2 rounded-lg mr-3 flex-shrink-0">
                            <span class="font-bold text-lg">${t.qty}</span>
                        </div>
                        <div>
                            <div class="font-medium dark:text-gray-200 text-sm leading-tight">${label}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Profit: <span class="text-green-600 dark:text-green-400">+$${t.profit}</span></div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="text-right mr-3">
                            <div class="font-bold text-gray-800 dark:text-gray-100">$${t.price}</div>
                            <div class="text-[10px] text-gray-400">${t.time}</div>
                        </div>
                        <button onclick="deleteTransaction(${t.id})" class="text-red-400 hover:text-red-600 p-1 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function deleteTransaction(id) {
            const index = appData.currentTransactions.findIndex(t => t.id === id);
            if (index > -1) {
                const t = appData.currentTransactions[index];
                const el = document.getElementById(`txn-${id}`);
                if (el) el.classList.add('slide-out');

                setTimeout(() => {
                    appData.stock += t.qty;
                    appData.currentTransactions.splice(index, 1);
                    saveData();
                    showToast("Sale deleted. Stock restored.");
                }, 300);
            }
        }

        // --- Actions ---

        function toggleStockEdit() {
            const displayMode = document.getElementById('stock-display-mode');
            const editMode = document.getElementById('stock-edit-mode');
            const input = document.getElementById('stock-set-input');

            if (editMode.classList.contains('hidden')) {
                displayMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                input.value = appData.stock;
                input.focus();
            } else {
                displayMode.classList.remove('hidden');
                editMode.classList.add('hidden');
            }
        }

        function saveStockEdit() {
            const input = document.getElementById('stock-set-input');
            const qty = parseInt(input.value);
            if (isNaN(qty) || qty < 0) {
                showToast("Please enter a valid stock number.");
                return;
            }
            appData.stock = qty;
            saveData();
            toggleStockEdit();
            showToast("Stock updated manually.");
        }

        function addStock() {
            const input = document.getElementById('stock-add-input');
            const qty = parseInt(input.value);
            if (isNaN(qty) || qty <= 0) {
                showToast("Please enter a valid quantity.");
                return;
            }
            appData.stock += qty;
            input.value = '';
            saveData();
            showToast(`Added ${qty} items to stock.`);
        }

        function sellItem(key) {
            const tier = PRICING[key];
            if (appData.stock < tier.qty) {
                showToast(`Not enough stock! You only have ${appData.stock} left.`);
                return;
            }

            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            const transaction = {
                id: Date.now(),
                timestamp: now.getTime(),
                hour: now.getHours(), 
                time: timeStr,
                key: key,
                qty: tier.qty,
                price: tier.price,
                profit: tier.profit,
                supplier: tier.supplier,
                label: tier.label
            };

            appData.stock -= tier.qty;
            appData.currentTransactions.push(transaction);

            saveData();
            showToast(`Sold ${tier.label} for $${tier.price}`);
        }

        // --- End of Day Summary Modal Logic ---

        function showEndDaySummary() {
            if (appData.currentTransactions.length === 0) {
                showToast("No sales to save today.");
                return;
            }

            const totals = getTodayTotals();

            // Group transactions by their exact label for the breakdown
            const grouped = {};
            appData.currentTransactions.forEach(t => {
                const label = t.label || `${t.qty} Item(s)`; // fallback
                if (!grouped[label]) {
                    grouped[label] = { count: 0, gross: 0, supplier: 0, profit: 0, unitPrice: t.price };
                }
                grouped[label].count += 1;
                grouped[label].gross += t.price;
                grouped[label].supplier += t.supplier;
                grouped[label].profit += t.profit;
            });

            // Build Breakdown DOM
            const listEl = document.getElementById('summary-breakdown-list');
            listEl.innerHTML = '';
            
            for (const [label, data] of Object.entries(grouped)) {
                listEl.innerHTML += `
                    <div class="py-3 border-b border-gray-200 dark:border-gray-700 last:border-0 last:pb-0">
                        <div class="flex items-center mb-2">
                            <div class="text-sm font-medium text-gray-800 dark:text-gray-200 flex items-center flex-wrap gap-1.5">
                                <span>${label}</span>
                                <span class="text-gray-500 dark:text-gray-400 font-normal">x${data.count}</span>
                                <span class="text-[10px] bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 px-1.5 py-0.5 rounded ml-1 border border-blue-200 dark:border-blue-800">$${data.unitPrice} each</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="bg-gray-100 dark:bg-gray-800/50 p-1.5 rounded border border-gray-200 dark:border-gray-700">
                                <div class="text-gray-500 dark:text-gray-400 uppercase text-[9px] font-bold tracking-wider mb-0.5">Gross</div>
                                <div class="font-bold text-gray-800 dark:text-gray-200">$${data.gross.toLocaleString()}</div>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/20 p-1.5 rounded border border-red-100 dark:border-red-900/30">
                                <div class="text-red-500 dark:text-red-400 uppercase text-[9px] font-bold tracking-wider mb-0.5">Owed</div>
                                <div class="font-bold text-red-700 dark:text-red-400">$${data.supplier.toLocaleString()}</div>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 p-1.5 rounded border border-green-100 dark:border-green-900/30">
                                <div class="text-green-600 dark:text-green-500 uppercase text-[9px] font-bold tracking-wider mb-0.5">Profit</div>
                                <div class="font-bold text-green-700 dark:text-green-400">$${data.profit.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Populate Totals
            document.getElementById('summary-total-gross').innerText = `$${totals.gross.toLocaleString()}`;
            document.getElementById('summary-total-supplier').innerText = `$${totals.supplier.toLocaleString()}`;
            document.getElementById('summary-total-profit').innerText = `$${totals.profit.toLocaleString()}`;

            // Show Modal
            const modal = document.getElementById('end-day-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeEndDaySummary() {
            const modal = document.getElementById('end-day-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function confirmEndDay() {
            closeEndDaySummary();

            const totals = getTodayTotals();
            const todayDate = new Date().toISOString().split('T')[0]; 
            
            const hourlyDist = {};
            const groupedBreakdown = {};

            appData.currentTransactions.forEach(t => {
                const h = t.hour || new Date(t.timestamp).getHours();
                hourlyDist[h] = (hourlyDist[h] || 0) + t.qty;

                // Group the breakdown for historical saving
                const label = t.label || `${t.qty} Item(s)`; 
                if (!groupedBreakdown[label]) {
                    groupedBreakdown[label] = { count: 0, gross: 0, supplier: 0, profit: 0, unitPrice: t.price };
                }
                groupedBreakdown[label].count += 1;
                groupedBreakdown[label].gross += t.price;
                groupedBreakdown[label].supplier += t.supplier;
                groupedBreakdown[label].profit += t.profit;
            });

            // Handle Rolling Debt Logic
            let customDebtTotal = 0;
            appData.customDebts.forEach(d => customDebtTotal += d.amount);
            
            let paymentTotal = 0;
            appData.supplierPayments.forEach(p => paymentTotal += p.amount);

            // Calculate the finalized new rolling debt going into tomorrow
            appData.carriedDebt = (appData.carriedDebt || 0) + totals.supplier + customDebtTotal - paymentTotal;

            const existingRecordIndex = appData.history.findIndex(h => h.date === todayDate);
            
            if (existingRecordIndex >= 0) {
                const rec = appData.history[existingRecordIndex];
                rec.gross += totals.gross;
                rec.profit += totals.profit;
                rec.supplier += totals.supplier;
                rec.itemsSold += totals.itemsSold;
                
                for (const [hour, count] of Object.entries(hourlyDist)) {
                    rec.hourlyDistribution = rec.hourlyDistribution || {};
                    rec.hourlyDistribution[hour] = (rec.hourlyDistribution[hour] || 0) + count;
                }

                // Merge breakdown into existing record
                rec.breakdown = rec.breakdown || {};
                for (const [label, data] of Object.entries(groupedBreakdown)) {
                    if (!rec.breakdown[label]) {
                        rec.breakdown[label] = { count: 0, gross: 0, supplier: 0, profit: 0, unitPrice: data.unitPrice };
                    }
                    rec.breakdown[label].count += data.count;
                    rec.breakdown[label].gross += data.gross;
                    rec.breakdown[label].supplier += data.supplier;
                    rec.breakdown[label].profit += data.profit;
                }
            } else {
                appData.history.push({
                    date: todayDate,
                    ...totals,
                    hourlyDistribution: hourlyDist,
                    breakdown: groupedBreakdown
                });
            }

            appData.currentTransactions = [];
            appData.customDebts = [];
            appData.supplierPayments = [];
            
            saveData();
            showToast("Shift confirmed and saved successfully!");
            
            if (document.getElementById('tab-reports').classList.contains('active')) {
                updateChart('daily');
                updateHourlyChart();
            }
        }

        // --- Reports & Predictions ---

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay() || 7; 
            if (day !== 1) d.setHours(-24 * (day - 1));
            return d.toISOString().split('T')[0];
        }

        function calculatePredictions(currentTotals) {
            const totalProfitToday = currentTotals.profit;
            
            if (appData.history.length === 0 && totalProfitToday === 0) {
                document.getElementById('predicted-earnings').innerText = "$0";
                return;
            }

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const startOfWeek = getStartOfWeek(today);

            let profitThisWeek = 0;
            
            appData.history.forEach(record => {
                if (record.date >= startOfWeek && record.date <= todayStr) {
                    profitThisWeek += record.profit;
                }
            });

            profitThisWeek += totalProfitToday;

            let daysElapsed = today.getDay() || 7; 
            daysElapsed = Math.max(1, daysElapsed);

            const dailyAverage = profitThisWeek / daysElapsed;
            const predictedWeekly = Math.round(dailyAverage * 7);

            document.getElementById('predicted-earnings').innerText = `$${predictedWeekly.toLocaleString()}`;
            document.getElementById('prediction-context').innerText = `Based on $${Math.round(dailyAverage)}/day average this week`;
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            if (appData.history.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No saved records yet.</p>';
                return;
            }

            const sortedHistory = [...appData.history].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedHistory.slice(0, 10).forEach(record => {
                const dateObj = new Date(record.date);
                dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
                
                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg transition-colors cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 active:scale-[0.98]';
                div.onclick = () => showHistoryDetail(record.date);
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800 dark:text-gray-200 text-sm">${dateStr}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${record.itemsSold} items sold</div>
                    </div>
                    <div class="flex items-center">
                        <div class="text-right mr-3">
                            <div class="font-bold text-green-600 dark:text-green-400 text-sm">+$${record.profit}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Gross: $${record.gross}</div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                    </div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- History Modal Detail View ---

        function showHistoryDetail(dateString) {
            const record = appData.history.find(h => h.date === dateString);
            if (!record) return;

            // Set Title/Date
            const dateObj = new Date(record.date);
            dateObj.setMinutes(dateObj.getMinutes() + dateObj.getTimezoneOffset());
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('history-modal-date').innerText = dateStr;

            // Populate Breakdown
            const listEl = document.getElementById('history-breakdown-list');
            listEl.innerHTML = '';
            
            if (record.breakdown && Object.keys(record.breakdown).length > 0) {
                for (const [label, data] of Object.entries(record.breakdown)) {
                    listEl.innerHTML += `
                        <div class="py-3 border-b border-gray-200 dark:border-gray-700 last:border-0 last:pb-0">
                            <div class="flex items-center mb-2">
                                <div class="text-sm font-medium text-gray-800 dark:text-gray-200 flex items-center flex-wrap gap-1.5">
                                    <span>${label}</span>
                                    <span class="text-gray-500 dark:text-gray-400 font-normal">x${data.count}</span>
                                    <span class="text-[10px] bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 px-1.5 py-0.5 rounded ml-1 border border-blue-200 dark:border-blue-800">$${data.unitPrice} each</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="bg-gray-100 dark:bg-gray-800/50 p-1.5 rounded border border-gray-200 dark:border-gray-700">
                                    <div class="text-gray-500 dark:text-gray-400 uppercase text-[9px] font-bold tracking-wider mb-0.5">Gross</div>
                                    <div class="font-bold text-gray-800 dark:text-gray-200">$${data.gross.toLocaleString()}</div>
                                </div>
                                <div class="bg-red-50 dark:bg-red-900/20 p-1.5 rounded border border-red-100 dark:border-red-900/30">
                                    <div class="text-red-500 dark:text-red-400 uppercase text-[9px] font-bold tracking-wider mb-0.5">Owed</div>
                                    <div class="font-bold text-red-700 dark:text-red-400">$${data.supplier.toLocaleString()}</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 p-1.5 rounded border border-green-100 dark:border-green-900/30">
                                    <div class="text-green-600 dark:text-green-500 uppercase text-[9px] font-bold tracking-wider mb-0.5">Profit</div>
                                    <div class="font-bold text-green-700 dark:text-green-400">$${data.profit.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                listEl.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4 text-sm">Detailed breakdown not available for this older record.</div>';
            }

            // Populate Totals
            document.getElementById('history-total-gross').innerText = `$${record.gross.toLocaleString()}`;
            document.getElementById('history-total-supplier').innerText = `$${record.supplier.toLocaleString()}`;
            document.getElementById('history-total-profit').innerText = `$${record.profit.toLocaleString()}`;

            // Show Modal
            const modal = document.getElementById('history-detail-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeHistoryDetail() {
            const modal = document.getElementById('history-detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- Charts ---

        function updateHourlyChart() {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (hourlyChartInstance) hourlyChartInstance.destroy();

            const hourlyTotals = new Array(24).fill(0);

            appData.history.forEach(rec => {
                if (rec.hourlyDistribution) {
                    for (const [hour, count] of Object.entries(rec.hourlyDistribution)) {
                        hourlyTotals[parseInt(hour)] += count;
                    }
                }
            });

            appData.currentTransactions.forEach(t => {
                const h = t.hour || new Date(t.timestamp).getHours();
                hourlyTotals[h] += t.qty;
            });

            const labels = hourlyTotals.map((_, i) => {
                const d = new Date(); d.setHours(i);
                return d.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
            });

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#374151' : '#f3f4f6';
            const textColor = isDark ? '#9ca3af' : '#6b7280';

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); 
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            hourlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Items Sold',
                        data: hourlyTotals,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                        x: { grid: { display: false }, ticks: { color: textColor, maxTicksLimit: 8 } }
                    }
                }
            });
        }

        function updateChart(viewMode) {
            ['daily', 'weekly', 'monthly'].forEach(mode => {
                const btn = document.getElementById(`btn-chart-${mode}`);
                if (mode === viewMode) {
                    btn.className = 'flex-1 py-1 text-sm rounded-md bg-white dark:bg-gray-600 shadow text-blue-600 dark:text-blue-400 font-medium transition';
                } else {
                    btn.className = 'flex-1 py-1 text-sm rounded-md text-gray-500 dark:text-gray-400 font-medium transition';
                }
            });

            const ctx = document.getElementById('salesChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            let labels = [];
            let profitData = [];
            let grossData = [];
            
            const todayTotals = getTodayTotals();

            if (viewMode === 'daily') {
                const last7Days = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    last7Days.push(d.toISOString().split('T')[0]);
                }

                labels = last7Days.map(d => {
                    let date = new Date(d);
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                    return date.toLocaleDateString('en-US', { weekday: 'short' });
                });

                last7Days.forEach(dateStr => {
                    const record = appData.history.find(h => h.date === dateStr);
                    let profit = record ? record.profit : 0;
                    let gross = record ? record.gross : 0;
                    
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (dateStr === todayStr) {
                        profit += todayTotals.profit;
                        gross += todayTotals.gross;
                    }

                    profitData.push(profit);
                    grossData.push(gross);
                });

            } else if (viewMode === 'weekly') {
                labels = ['Week -3', 'Week -2', 'Last Week', 'This Week'];
                profitData = [0, 0, 0, 0];
                grossData = [0, 0, 0, 0];

                const today = new Date();
                
                const allData = [...appData.history];
                if (todayTotals.gross > 0) {
                    allData.push({ date: today.toISOString().split('T')[0], ...todayTotals });
                }

                allData.forEach(record => {
                    const rDate = new Date(record.date);
                    const diffTime = Math.abs(today - rDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 7) {
                        profitData[3] += record.profit; grossData[3] += record.gross;
                    } else if (diffDays <= 14) {
                        profitData[2] += record.profit; grossData[2] += record.gross;
                    } else if (diffDays <= 21) {
                        profitData[1] += record.profit; grossData[1] += record.gross;
                    } else if (diffDays <= 28) {
                        profitData[0] += record.profit; grossData[0] += record.gross;
                    }
                });
            } else if (viewMode === 'monthly') {
                labels = [];
                profitData = [0, 0, 0, 0, 0, 0];
                grossData = [0, 0, 0, 0, 0, 0];

                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    labels.push(d.toLocaleDateString('en-US', { month: 'short' }));
                }

                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const allData = [...appData.history];
                if (todayTotals.gross > 0) {
                    allData.push({ date: new Date().toISOString().split('T')[0], ...todayTotals });
                }

                allData.forEach(record => {
                    const rDate = new Date(record.date);
                    rDate.setMinutes(rDate.getMinutes() + rDate.getTimezoneOffset());
                    
                    const monthDiff = (currentYear - rDate.getFullYear()) * 12 + (currentMonth - rDate.getMonth());
                    
                    if (monthDiff >= 0 && monthDiff <= 5) {
                        const index = 5 - monthDiff;
                        profitData[index] += record.profit;
                        grossData[index] += record.gross;
                    }
                });
            }

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#374151' : '#f3f4f6';
            const textColor = isDark ? '#9ca3af' : '#6b7280';

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Profit',
                            data: profitData,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderRadius: 4,
                            order: 1
                        },
                        {
                            label: 'Gross',
                            data: grossData,
                            backgroundColor: isDark ? 'rgba(75, 85, 99, 0.8)' : 'rgba(209, 213, 219, 0.6)',
                            borderRadius: 4,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, color: textColor } }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4], color: gridColor }, ticks: { color: textColor } },
                        x: { grid: { display: false }, ticks: { color: textColor } }
                    }
                }
            });
        }

        // --- Utilities ---

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            const navIds = ['sales', 'reports', 'calculator', 'settings'];
            navIds.forEach(id => {
                const el = document.getElementById(`nav-${id}`);
                if (id === tabName) {
                    el.classList.remove('text-gray-400', 'dark:text-gray-500');
                    el.classList.add('text-blue-600', 'dark:text-blue-400');
                } else {
                    el.classList.remove('text-blue-600', 'dark:text-blue-400');
                    el.classList.add('text-gray-400', 'dark:text-gray-500');
                }
            });

            if (tabName === 'reports') {
                const activeBtn = document.getElementById('btn-chart-daily').classList.contains('text-blue-600') ? 'daily' : 
                                  document.getElementById('btn-chart-weekly').classList.contains('text-blue-600') ? 'weekly' : 'monthly';
                updateChart(activeBtn);
                updateHourlyChart();
            }
            if (tabName === 'calculator') {
                calculateReconciliation();
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            const icon = document.getElementById('theme-icon');
            if(icon) {
                icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
            }

            if (document.getElementById('tab-reports').classList.contains('active')) {
                const activeBtn = document.getElementById('btn-chart-daily').classList.contains('text-blue-600') ? 'daily' : 
                                  document.getElementById('btn-chart-weekly').classList.contains('text-blue-600') ? 'weekly' : 'monthly';
                updateChart(activeBtn);
                updateHourlyChart();
            }
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- Calculator Logic ---

        function addCustomDebt() {
            const amountEl = document.getElementById('new-custom-debt-amount');
            const descEl = document.getElementById('new-custom-debt-desc');
            const amount = parseFloat(amountEl.value);
            if (isNaN(amount) || amount <= 0) return showToast("Enter a valid debt amount");
            
            appData.customDebts.push({
                id: Date.now(),
                amount: amount,
                desc: descEl.value || 'Custom Debt'
            });
            amountEl.value = '';
            descEl.value = '';
            saveData();
        }

        function removeCustomDebt(id) {
            appData.customDebts = appData.customDebts.filter(d => d.id !== id);
            saveData();
        }

        function addSupplierPayment() {
            const amountEl = document.getElementById('new-payment-amount');
            const amount = parseFloat(amountEl.value);
            if (isNaN(amount) || amount <= 0) return showToast("Enter a valid payment amount");
            
            appData.supplierPayments.push({
                id: Date.now(),
                amount: amount
            });
            amountEl.value = '';
            saveData();
        }

        function removeSupplierPayment(id) {
            appData.supplierPayments = appData.supplierPayments.filter(p => p.id !== id);
            saveData();
        }

        function updateInputBorderColors(el, state) {
            el.classList.remove('border-red-500', 'border-orange-500', 'border-green-500', 'border-gray-200', 'dark:border-gray-600');
            if (state === 'red') el.classList.add('border-red-500');
            else if (state === 'orange') el.classList.add('border-orange-500');
            else if (state === 'green') el.classList.add('border-green-500');
            else el.classList.add('border-gray-200', 'dark:border-gray-600');
        }

        function calculateReconciliation() {
            const totals = getTodayTotals();
            const autoOwed = totals.supplier;
            const expectedProfit = totals.profit;
            
            const carriedDebt = appData.carriedDebt || 0;
            
            let customDebtTotal = 0;
            appData.customDebts.forEach(d => customDebtTotal += d.amount);
            
            let paymentTotal = 0;
            appData.supplierPayments.forEach(p => paymentTotal += p.amount);
            
            const totalGrossDebt = carriedDebt + autoOwed + customDebtTotal;
            const netOwedSigned = totalGrossDebt - paymentTotal;
            
            const cashEl = document.getElementById('calc-cash');
            const bankEl = document.getElementById('calc-bank');
            const cash = parseFloat(cashEl.value) || 0;
            const bank = parseFloat(bankEl.value) || 0;

            const totalFunds = cash + bank;
            
            // Render Combined Assets
            const totalAssetsEl = document.getElementById('calc-total-assets');
            if (totalAssetsEl) totalAssetsEl.innerText = `Combined: $${totalFunds.toLocaleString()}`;

            // Render Text Displays
            document.getElementById('calc-carried-debt').innerText = `$${carriedDebt.toLocaleString()}`;
            document.getElementById('calc-auto-owed').innerText = `$${autoOwed.toLocaleString()}`;
            document.getElementById('calc-total-gross-debt').innerText = `$${totalGrossDebt.toLocaleString()}`;
            document.getElementById('calc-total-payments').innerText = `$${paymentTotal.toLocaleString()}`;
            document.getElementById('calc-net-owed').innerText = `$${netOwedSigned.toLocaleString()}`;

            // Render Lists
            const debtList = document.getElementById('list-custom-debts');
            debtList.innerHTML = appData.customDebts.map(d => `
                <div class="flex justify-between items-center text-sm py-2 px-3 bg-white dark:bg-gray-800 rounded border border-gray-100 dark:border-gray-700 shadow-sm">
                    <span class="text-gray-600 dark:text-gray-300 font-medium">${d.desc}</span>
                    <div class="flex items-center">
                        <span class="font-bold text-red-600 dark:text-red-400 mr-3">+$${d.amount}</span>
                        <button onclick="removeCustomDebt(${d.id})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            
            const payList = document.getElementById('list-payments');
            payList.innerHTML = appData.supplierPayments.map(p => `
                <div class="flex justify-between items-center text-sm py-2 px-3 bg-white dark:bg-gray-800 rounded border border-gray-100 dark:border-gray-700 shadow-sm">
                    <span class="text-gray-600 dark:text-gray-300 font-medium flex items-center"><i data-lucide="check-circle" class="w-3 h-3 mr-1 text-green-500"></i> Payment</span>
                    <div class="flex items-center">
                        <span class="font-bold text-green-600 dark:text-green-400 mr-3">-$${p.amount}</span>
                        <button onclick="removeSupplierPayment(${p.id})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();

            // Status Logic & Colors
            const statusLabel = document.getElementById('calc-status-label');
            const statusValue = document.getElementById('calc-status-value');

            if (totalFunds < netOwedSigned) {
                // Short on Supplier Debt
                updateInputBorderColors(cashEl, 'red');
                updateInputBorderColors(bankEl, 'red');
                statusLabel.innerText = "Short for Supplier";
                statusLabel.className = "text-sm font-medium text-red-600 dark:text-red-400";
                statusValue.innerText = `-$${(netOwedSigned - totalFunds).toLocaleString()}`;
                statusValue.className = "font-bold text-2xl text-red-600 dark:text-red-400";
            } else {
                const surplus = totalFunds - netOwedSigned;
                if (surplus < expectedProfit) {
                    // Supplier Paid, but missing some expected profit
                    updateInputBorderColors(cashEl, 'orange');
                    updateInputBorderColors(bankEl, 'orange');
                    statusLabel.innerText = `Covered (Target Profit: $${expectedProfit.toLocaleString()})`;
                    statusLabel.className = "text-sm font-medium text-orange-600 dark:text-orange-400";
                    statusValue.innerText = `+$${surplus.toLocaleString()}`;
                    statusValue.className = "font-bold text-2xl text-orange-600 dark:text-orange-400";
                } else {
                    // Supplier Paid AND Profiting perfectly
                    updateInputBorderColors(cashEl, 'green');
                    updateInputBorderColors(bankEl, 'green');
                    statusLabel.innerText = "Surplus / Full Profit";
                    statusLabel.className = "text-sm font-medium text-green-600 dark:text-green-500";
                    statusValue.innerText = `+$${surplus.toLocaleString()}`;
                    statusValue.className = "font-bold text-2xl text-green-600 dark:text-green-500";
                }
            }
        }

        function transferBankToCash() {
            const bankInput = document.getElementById('calc-bank');
            const cashInput = document.getElementById('calc-cash');
            
            const bankVal = parseFloat(bankInput.value) || 0;
            const cashVal = parseFloat(cashInput.value) || 0;
            
            if (bankVal > 0) {
                cashInput.value = cashVal + bankVal;
                bankInput.value = '';
                appData.calcCash = cashInput.value;
                appData.calcBank = bankInput.value;
                calculateReconciliation();
                saveData();
                showToast("Bank funds transferred to Cash.");
            }
        }


        // --- Data Management ---

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `Sales_Backup_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Data exported successfully.");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.stock !== undefined) {
                        appData = importedData;
                        if (!appData.currentTransactions) appData.currentTransactions = [];
                        
                        saveData();
                        showToast("Data imported successfully!");
                        updateUI();
                    } else {
                        showToast("Invalid data format.");
                    }
                } catch (err) {
                    showToast("Error reading file.");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function resetApp() {
            if (confirm("Are you sure? This cannot be undone unless you have exported a backup!")) {
                localStorage.removeItem('salesAppData');
                appData = { stock: 0, currentTransactions: [], history: [] };
                updateUI();
                showToast("App data has been reset.");
            }
        }

        // Boot the app
        window.onload = initApp;

    </script>
</body>
</html>