<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales & Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .hidden { display: none !important; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
    <script>
        if (localStorage.theme === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="modal-overlay z-[150]">
        <div class="text-white flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p class="font-bold tracking-wide">Loading Profile...</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-white">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Portal Login</h2>
                <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Drivers & Admins</p>
            </div>
            <button onclick="window.handleGoogleLogin()" class="w-full bg-white dark:bg-gray-700 text-gray-700 dark:text-white border border-gray-300 dark:border-gray-600 font-bold py-3 rounded-lg shadow-sm flex justify-center items-center hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 4.36c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 1.09 14.97 0 12 0 7.7 0 3.99 2.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Approval Pending -->
    <div id="approval-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-600">
                <i data-lucide="clock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold dark:text-white">Status Check</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-2 mb-6">Waiting for approval or loading profile...</p>
            <button onclick="window.logout()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-lg text-gray-700 dark:text-gray-300">Sign Out</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold dark:text-white">Options</h2>
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="window.toggleTheme()" class="w-full flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <span class="font-medium dark:text-white">Dark Mode</span>
                    <i data-lucide="moon" class="w-5 h-5 text-gray-500 dark:text-gray-300"></i>
                </button>
                <hr class="border-gray-200 dark:border-gray-700 my-2">
                <button onclick="window.logout()" class="w-full flex justify-center items-center p-3 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg font-bold">
                    <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- DRIVER REPORTS MODAL -->
    <div id="driver-stats-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 p-0 rounded-2xl shadow-2xl w-11/12 max-w-md overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 bg-blue-600 dark:bg-gray-700 text-white flex justify-between items-center">
                <h2 class="text-lg font-bold">My Performance</h2>
                <button onclick="document.getElementById('driver-stats-modal').classList.add('hidden')" class="p-1 hover:bg-blue-700 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-4 overflow-y-auto">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase">This Week</div>
                        <div class="text-xl font-bold text-green-600" id="drv-stat-week">$0</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <div class="text-xs text-gray-500 dark:text-gray-400 uppercase">This Month</div>
                        <div class="text-xl font-bold text-blue-600" id="drv-stat-month">$0</div>
                    </div>
                </div>
                <!-- Chart -->
                <div class="h-64 bg-white dark:bg-gray-900 rounded-lg p-2 border border-gray-100 dark:border-gray-700 mb-4">
                    <canvas id="driverProfitChart"></canvas>
                </div>
                <!-- Detailed Breakdown -->
                <h3 class="font-bold text-sm mb-2 dark:text-white">Breakdown</h3>
                <div class="space-y-2 text-sm" id="drv-stat-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- DRIVER UI -->
    <div id="driver-app" class="hidden pb-24">
        <header class="bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300" id="driver-header">
            <div>
                <h1 class="text-lg font-bold">Driver Portal</h1>
                <div class="flex items-center text-xs text-blue-200 mt-1 space-x-2">
                    <span id="driver-name-display">Guest</span>
                    <span>•</span>
                    <!-- Status Toggle -->
                    <button onclick="window.toggleDriverStatus()" id="status-badge" class="flex items-center bg-black/20 px-2 py-0.5 rounded-full hover:bg-black/30 transition">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400 mr-1.5"></div>
                        <span id="status-text">Offline</span>
                    </button>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="window.openDriverStats()" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                </button>
                <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-blue-700 dark:bg-gray-700 rounded-full hover:bg-blue-800 transition">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto">
            <!-- Stock Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-gray-500 text-xs uppercase tracking-wide">My Stock</h2>
                        <span class="text-4xl font-bold dark:text-white" id="display-stock">0</span>
                    </div>
                    <div class="text-right">
                        <h2 class="text-gray-500 text-xs uppercase tracking-wide">Owed</h2>
                        <span class="text-2xl font-bold text-red-500" id="display-stock-value">$0</span>
                    </div>
                </div>
            </div>

            <!-- Quick Sell -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 mb-4 border border-gray-100 dark:border-gray-700">
                <h2 class="text-gray-500 text-xs uppercase tracking-wide mb-3">New Sale</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="window.sellItem(1)" class="p-3 rounded-lg border-2 border-blue-100 dark:border-blue-900 bg-blue-50 dark:bg-blue-900/20 text-center active:scale-95 transition hover:shadow-md">
                        <div class="text-lg font-bold text-blue-700 dark:text-blue-400">1 ($80)</div>
                    </button>
                    <button onclick="window.sellItem(2)" class="p-3 rounded-lg border-2 border-green-100 dark:border-green-900 bg-green-50 dark:bg-green-900/20 text-center active:scale-95 transition hover:shadow-md">
                        <div class="text-lg font-bold text-green-700 dark:text-green-400">2 ($150)</div>
                    </button>
                    <button onclick="window.sellItem(3)" class="p-3 rounded-lg border-2 border-purple-100 dark:border-purple-900 bg-purple-50 dark:bg-purple-900/20 text-center active:scale-95 transition hover:shadow-md">
                        <div class="text-lg font-bold text-purple-700 dark:text-purple-400">3 ($220)</div>
                    </button>
                    <button onclick="window.sellItem(4)" class="p-3 rounded-lg border-2 border-orange-100 dark:border-orange-900 bg-orange-50 dark:bg-orange-900/20 text-center active:scale-95 transition hover:shadow-md">
                        <div class="text-lg font-bold text-orange-700 dark:text-orange-400">4 ($280)</div>
                    </button>
                </div>
            </div>

            <!-- Today's Stats -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-gray-500 text-xs uppercase tracking-wide">Today's Shift</h2>
                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold" id="today-profit-badge">$0 Profit</span>
                </div>
                <div id="transaction-list" class="space-y-2 max-h-64 overflow-y-auto hide-scrollbar text-sm">
                    <div class="text-center text-gray-400 py-2">No sales yet today</div>
                </div>
                <button onclick="window.endDay()" class="mt-4 w-full bg-gray-900 dark:bg-gray-700 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">End Shift & Save</button>
            </div>
        </main>
    </div>

    <!-- ADMIN UI -->
    <div id="admin-app" class="hidden min-h-screen bg-gray-50 dark:bg-gray-900 pb-20">
        <header class="bg-gray-900 text-white p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">BOSS DASHBOARD</h1>
                <p class="text-xs text-gray-400" id="admin-date-display"></p>
            </div>
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <main class="p-4 max-w-2xl mx-auto">
            
            <!-- Admin Navigation -->
            <div class="flex space-x-1 mb-6 bg-white dark:bg-gray-800 p-1 rounded-xl shadow-sm">
                <button onclick="window.switchAdminTab('team')" id="adm-tab-team" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm transition bg-gray-100 dark:bg-gray-700 text-blue-600">Team Sales</button>
                <button onclick="window.switchAdminTab('inventory')" id="adm-tab-inventory" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm text-gray-500 dark:text-gray-400 transition hover:bg-gray-50 dark:hover:bg-gray-700">Inventory</button>
                <button onclick="window.switchAdminTab('reports')" id="adm-tab-reports" class="flex-1 py-2 rounded-lg font-bold text-xs sm:text-sm text-gray-500 dark:text-gray-400 transition hover:bg-gray-50 dark:hover:bg-gray-700">Reports</button>
            </div>

            <!-- TAB: TEAM OVERVIEW -->
            <div id="admin-view-team" class="admin-tab-content">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase">Total Team Profit</div>
                        <div class="text-2xl font-bold text-green-600" id="admin-total-profit">$0</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase">Items Sold Today</div>
                        <div class="text-2xl font-bold text-blue-600" id="admin-total-sold">0</div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-3 ml-1">
                    <h3 class="font-bold text-gray-700 dark:text-gray-300">Driver Status</h3>
                    <div class="text-xs text-gray-400">Green = Active</div>
                </div>
                <div id="admin-driver-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400 animate-pulse">Loading team data...</div>
                </div>
            </div>

            <!-- TAB: INVENTORY -->
            <div id="admin-view-inventory" class="admin-tab-content hidden">
                <!-- Master Stock Card -->
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 text-white mb-6 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-gray-400 text-xs uppercase tracking-wider font-bold mb-1">Warehouse Master Stock</h2>
                            <div class="text-4xl font-bold mb-2" id="admin-master-stock">--</div>
                            <p class="text-xs text-gray-500">Items available to distribute</p>
                        </div>
                        <button onclick="window.adminAddMasterStock()" class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg text-white text-xs font-bold border border-gray-600 transition">
                            + Restock
                        </button>
                    </div>
                </div>

                <!-- Distribute Panel -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i data-lucide="truck" class="w-5 h-5 mr-2 text-blue-600"></i> Distribute Stock
                    </h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Select Driver</label>
                            <select id="distribute-select-driver" class="w-full mt-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg outline-none font-medium text-gray-800 dark:text-white">
                                <option value="">Loading drivers...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Quantity to Send</label>
                            <div class="flex space-x-2 mt-1">
                                <input type="number" id="distribute-qty" placeholder="0" class="flex-1 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg outline-none font-bold text-lg text-gray-800 dark:text-white">
                                <button onclick="window.adminDistributeStock()" class="bg-blue-600 text-white font-bold px-6 rounded-lg shadow-md hover:bg-blue-700 active:scale-95 transition">
                                    SEND
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: REPORTS -->
            <div id="admin-view-reports" class="admin-tab-content hidden">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-4">Team Performance (Last 7 Days)</h3>
                    <div class="h-64">
                        <canvas id="adminTeamChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                     <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase mb-1">Last 7 Days Sales</div>
                        <div class="text-xl font-bold text-gray-800 dark:text-white" id="adm-report-week-qty">0</div>
                        <div class="text-sm text-green-600 font-bold" id="adm-report-week-profit">$0 Profit</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="text-gray-500 text-xs uppercase mb-1">This Month Sales</div>
                        <div class="text-xl font-bold text-gray-800 dark:text-white" id="adm-report-month-qty">0</div>
                        <div class="text-sm text-blue-600 font-bold" id="adm-report-month-profit">$0 Profit</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: USER DETAIL -->
            <div id="admin-user-detail" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 z-50 overflow-y-auto hidden">
                <div class="bg-white dark:bg-gray-800 p-4 sticky top-0 shadow-md flex items-center justify-between">
                    <button onclick="document.getElementById('admin-user-detail').classList.add('hidden')" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <h2 class="font-bold text-lg dark:text-white" id="detail-user-name">Driver Stats</h2>
                    <div class="w-8"></div>
                </div>
                <div class="p-4 max-w-2xl mx-auto space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Stock on Hand</div>
                            <div class="text-xl font-bold dark:text-white" id="detail-stock">0</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-200 dark:border-gray-700">
                            <div class="text-xs text-gray-500 uppercase">Profit Today</div>
                            <div class="text-xl font-bold text-green-600" id="detail-profit">0</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-sm mb-3 border-b pb-2 dark:border-gray-700 dark:text-white">Recent Activity</h3>
                        <div class="text-xs text-gray-400 italic">Detailed transaction logs are private to the driver. Only summary data is shown here to comply with security rules.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- MAIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgX9tL8zEaPvaZIcqDdk8XHzz4y7MvCeU",
            authDomain: "salesonwheels-f6eec.firebaseapp.com",
            projectId: "salesonwheels-f6eec",
            storageBucket: "salesonwheels-f6eec.firebasestorage.app",
            messagingSenderId: "432785821226",
            appId: "1:432785821226:web:96b34cc3d0526160b0bd53"
        };
        const appId = "sales-tracker-v1"; 

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userRole = 'driver'; 
        let appData = { stock: 0, status: 'inactive', currentTransactions: [], history: [], stockLogs: [] };
        
        let driverChartInstance = null;
        let adminChartInstance = null;

        // Listeners
        let unsubUserData = null;
        let unsubProfile = null;
        let unsubRoster = null; 
        let unsubMasterStock = null; 

        // --- UTILS ---
        window.showToast = (msg) => { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); };
        
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };

        // --- AUTH & ROUTING ---
        window.handleGoogleLogin = async () => {
            try { await signInWithPopup(auth, googleProvider); } 
            catch (e) { window.showToast("Login Failed: " + e.message); }
        };

        window.logout = async () => {
            if(unsubUserData) unsubUserData();
            if(unsubProfile) unsubProfile();
            if(unsubRoster) unsubRoster();
            await signOut(auth);
            window.location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                
                unsubProfile = onSnapshot(profileRef, async (snap) => {
                    try {
                        let role = 'driver';
                        let status = 'pending';
                        
                        if (!snap.exists()) {
                            await setDoc(profileRef, {
                                name: user.displayName || user.email, 
                                email: user.email, 
                                role: 'driver', 
                                status: 'pending', 
                                createdAt: Date.now()
                            });
                        } else {
                            const data = snap.data();
                            role = data.role || 'driver';
                            status = data.status || 'pending';
                        }

                        // Sync presence to roster
                        try {
                            const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', user.uid);
                            await setDoc(rosterRef, {
                                name: user.displayName || user.email, 
                                email: user.email, 
                                uid: user.uid,
                                lastLogin: Date.now()
                            }, { merge: true });
                        } catch (e) {}

                        userRole = role;
                        document.getElementById('loading-overlay').classList.add('hidden');

                        if (status === 'approved' || role === 'admin') {
                            document.getElementById('approval-modal').classList.add('hidden');
                            if (role === 'admin') initAdminDashboard();
                            else initDriverApp(user);
                        } else {
                            document.getElementById('approval-modal').classList.remove('hidden');
                        }
                    } catch (err) {
                        document.getElementById('loading-overlay').classList.add('hidden');
                    }
                });
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('driver-app').classList.add('hidden');
                document.getElementById('admin-app').classList.add('hidden');
            }
        });

        // --- DRIVER LOGIC ---
        function initDriverApp(user) {
            document.getElementById('driver-app').classList.remove('hidden');
            const displayName = user.displayName ? user.displayName.split(' ')[0] : 'Driver';
            document.getElementById('driver-name-display').innerText = displayName;
            
            // Sync Data
            const dataRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'app_state');
            unsubUserData = onSnapshot(dataRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if(data.json) appData = JSON.parse(data.json);
                    
                    // Init Defaults
                    appData.stock = appData.stock || 0;
                    appData.status = appData.status || 'inactive';
                    appData.stockLogs = appData.stockLogs || []; 
                    appData.currentTransactions = appData.currentTransactions || [];
                    appData.history = appData.history || [];
                    
                    renderDriverUI();
                } else {
                    saveDriverData(); 
                }
            });
        }

        function renderDriverUI() {
            // Status UI
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            const hdr = document.getElementById('driver-header');
            if(appData.status === 'active') {
                dot.className = "w-2 h-2 rounded-full bg-green-400 mr-1.5 animate-pulse";
                txt.innerText = "Online";
                hdr.className = "bg-green-600 dark:bg-green-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-gray-400 mr-1.5";
                txt.innerText = "Offline";
                hdr.className = "bg-blue-600 dark:bg-gray-800 text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300";
            }

            // Stock
            document.getElementById('display-stock').innerText = appData.stock;
            document.getElementById('display-stock-value').innerText = `$${(appData.stock * 60).toLocaleString()}`; 
            
            // Today's Stats
            const todayTotals = appData.currentTransactions.reduce((acc, t) => ({ profit: acc.profit + t.profit, gross: acc.gross + t.price }), {profit:0, gross:0});
            document.getElementById('today-profit-badge').innerText = `+$${todayTotals.profit} Profit`;

            // Render Transaction List with DELETE button
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            
            // Clone and reverse to show newest first, but keep track of original index for deletion
            const displayList = appData.currentTransactions.map((t, i) => ({...t, originalIndex: i})).reverse();
            
            displayList.forEach(t => {
                list.innerHTML += `
                <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700/50 rounded group">
                    <div>
                        <div class="text-sm dark:text-gray-200"><span class="font-bold">${t.qty}</span> items sold</div>
                        <div class="text-xs text-gray-400">${t.time}</div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-green-600">+$${t.profit}</span>
                        <button onclick="window.deleteSale(${t.originalIndex})" class="text-gray-400 hover:text-red-500 transition p-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>`;
            });
            
            if(appData.currentTransactions.length === 0) list.innerHTML = '<div class="text-center text-gray-400 py-2">No sales yet today</div>';
            lucide.createIcons();
        }

        async function saveDriverData() {
            if(!currentUser) return;
            
            // 1. Save Private Full Data
            const dataRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'app_state');
            await setDoc(dataRef, { json: JSON.stringify(appData), lastUpdated: Date.now() });

            // 2. Save Public Summary + History for Reports
            let todaySold = 0;
            let todayProfit = 0;
            appData.currentTransactions.forEach(t => { todaySold += t.qty; todayProfit += t.profit; });
            
            // Prepare last 7 days history for Admin charts
            const historySlice = appData.history.slice(-7);
            
            try {
                const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', currentUser.uid);
                await setDoc(rosterRef, {
                    stock: appData.stock,
                    status: appData.status,
                    todaySold: todaySold,
                    todayProfit: todayProfit,
                    history: historySlice, // Sync history for graphs
                    lastSync: Date.now()
                }, { merge: true });
            } catch(e) { console.log("Public sync failed", e); }
        }

        window.toggleDriverStatus = async () => {
            appData.status = appData.status === 'active' ? 'inactive' : 'active';
            renderDriverUI(); // optimistically update UI
            await saveDriverData();
            window.showToast(`You are now ${appData.status === 'active' ? 'Online' : 'Offline'}`);
        };

        window.sellItem = async (qty) => {
            if(appData.stock < qty) { window.showToast("Not enough stock!"); return; }
            if(appData.status !== 'active') { 
                if(!confirm("You are currently Offline. Sell anyway?")) return;
                window.toggleDriverStatus(); // Auto switch to active
            }
            
            const pricing = { 1:{p:80, prof:20}, 2:{p:150, prof:40}, 3:{p:220, prof:60}, 4:{p:280, prof:80} };
            const tier = pricing[qty];
            
            appData.stock -= qty;
            appData.currentTransactions.push({ date: Date.now(), qty: qty, price: tier.p, profit: tier.prof, time: new Date().toLocaleTimeString() });
            
            await saveDriverData();
            window.showToast(`Sold ${qty} for $${tier.p}`);
        };

        window.deleteSale = async (originalIndex) => {
            if(!confirm("Undo this sale? Stock will be returned.")) return;
            
            const t = appData.currentTransactions[originalIndex];
            appData.stock += t.qty; // Refund
            appData.currentTransactions.splice(originalIndex, 1); // Remove
            
            await saveDriverData();
            window.showToast("Sale undone. Stock returned.");
        };

        window.endDay = async () => {
            if(appData.currentTransactions.length === 0) { window.showToast("No sales to save."); return; }
            // Move today to history
            const todayStats = appData.currentTransactions.reduce((acc, t) => ({ profit: acc.profit+t.profit, sold: acc.sold+t.qty, revenue: acc.gross+t.price }), {profit:0, sold:0, revenue:0});
            
            // Check if entry for today already exists in history (prevent dupes if multiple 'end day' clicks)
            const dateStr = new Date().toISOString().split('T')[0];
            const existingIdx = appData.history.findIndex(h => h.date === dateStr);
            
            if(existingIdx >= 0) {
                appData.history[existingIdx].profit += todayStats.profit;
                appData.history[existingIdx].sold += todayStats.sold;
                appData.history[existingIdx].revenue += todayStats.revenue;
            } else {
                appData.history.push({ date: dateStr, ...todayStats });
            }

            appData.currentTransactions = [];
            appData.status = 'inactive'; // Auto offline
            await saveDriverData();
            window.showToast("Day saved & Reset!");
        };

        // --- DRIVER STATS & CHARTS ---
        window.openDriverStats = () => {
            document.getElementById('driver-stats-modal').classList.remove('hidden');
            renderDriverCharts();
        };

        function renderDriverCharts() {
            // Calc stats
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            
            let weekProfit = 0, monthProfit = 0;
            // Include today's current profit in calculations
            const todayProfit = appData.currentTransactions.reduce((a, b) => a + b.profit, 0);
            const todayDate = new Date().toISOString().split('T')[0];

            // Combine history + today for calculation
            const allData = [...appData.history];
            if(todayProfit > 0) allData.push({ date: todayDate, profit: todayProfit });

            allData.forEach(h => {
                const d = new Date(h.date);
                if(d >= startOfWeek) weekProfit += h.profit;
                if(d >= startOfMonth) monthProfit += h.profit;
            });

            document.getElementById('drv-stat-week').innerText = `$${weekProfit}`;
            document.getElementById('drv-stat-month').innerText = `$${monthProfit}`;

            // Render Chart
            const ctx = document.getElementById('driverProfitChart').getContext('2d');
            if(driverChartInstance) driverChartInstance.destroy();

            // Last 7 entries for chart
            const chartData = appData.history.slice(-7);
            
            driverChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.date.slice(5)), // MM-DD
                    datasets: [{
                        label: 'Profit ($)',
                        data: chartData.map(d => d.profit),
                        backgroundColor: '#3B82F6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: {display: false} },
                    scales: { y: { beginAtZero: true, grid: { color: '#374151' } }, x: { grid: { display: false } } }
                }
            });
            
            // List Breakdown (Reverse chrono)
            const list = document.getElementById('drv-stat-list');
            list.innerHTML = '';
            [...appData.history].reverse().slice(0, 10).forEach(h => {
                list.innerHTML += `<div class="flex justify-between border-b dark:border-gray-700 pb-1">
                    <span class="text-gray-500">${h.date}</span>
                    <span class="dark:text-gray-300">${h.sold} sold</span>
                    <span class="font-bold text-green-600">+$${h.profit}</span>
                </div>`;
            });
        }

        // --- ADMIN LOGIC ---
        function initAdminDashboard() {
            document.getElementById('admin-app').classList.remove('hidden');
            document.getElementById('admin-date-display').innerText = new Date().toDateString();
            
            const rosterRef = collection(db, 'artifacts', appId, 'public', 'data', 'roster');
            unsubRoster = onSnapshot(rosterRef, (snap) => {
                const listEl = document.getElementById('admin-driver-list');
                const selectEl = document.getElementById('distribute-select-driver');
                listEl.innerHTML = '';
                selectEl.innerHTML = '<option value="">Select Driver...</option>';
                
                if (snap.empty) {
                    listEl.innerHTML = '<div class="text-center py-8 text-gray-400">No active drivers found.</div>';
                    return;
                }
                
                let totalSoldToday = 0;
                let totalProfitToday = 0;
                let rosterData = [];

                snap.forEach(docSnap => {
                    const driver = docSnap.data();
                    const dStock = driver.stock || 0;
                    const dSold = driver.todaySold || 0;
                    const dProfit = driver.todayProfit || 0;
                    const dStatus = driver.status || 'inactive';
                    
                    rosterData.push(driver); // Store for reports

                    totalSoldToday += dSold;
                    totalProfitToday += dProfit;

                    // Status Indicator Color
                    const statusColor = dStatus === 'active' ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600';
                    const statusBorder = dStatus === 'active' ? 'border-green-500' : 'border-gray-300 dark:border-gray-600';

                    // Render Card
                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition";
                    card.onclick = () => window.viewDriverDetails(docSnap.id, driver.name, dStock, dProfit);
                    card.innerHTML = `
                        <div class="flex items-center">
                            <div class="relative mr-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold border-2 ${statusBorder}">${driver.name ? driver.name[0].toUpperCase() : 'U'}</div>
                                <div class="absolute bottom-0 right-0 w-3 h-3 rounded-full ${statusColor} border-2 border-white dark:border-gray-800"></div>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800 dark:text-white flex items-center">
                                    ${driver.name || 'Unknown'} 
                                    ${dStatus === 'active' ? '<span class="ml-2 text-[10px] bg-green-100 text-green-800 px-1.5 py-0.5 rounded-full uppercase tracking-wide">Online</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-500">Stock: ${dStock} • Sold: ${dSold}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-600">+$${dProfit}</div>
                        </div>
                    `;
                    listEl.appendChild(card);

                    const option = document.createElement('option');
                    option.value = driver.uid || docSnap.id;
                    option.innerText = driver.name || 'Unknown';
                    selectEl.appendChild(option);
                });

                document.getElementById('admin-total-profit').innerText = `$${totalProfitToday}`;
                document.getElementById('admin-total-sold').innerText = totalSoldToday;
                
                // Update Reports whenever roster changes
                updateAdminReports(rosterData);
            });

            // Master Inventory Listener
            const masterRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master');
            unsubMasterStock = onSnapshot(masterRef, (snap) => {
                const val = snap.exists() ? (snap.data().qty || 0) : 0;
                document.getElementById('admin-master-stock').innerText = val;
            });
        }

        function updateAdminReports(rosterData) {
            // Aggregate History
            // We need to merge histories from all drivers by date
            let dateMap = {};
            let weekQty = 0, monthQty = 0;
            let weekProf = 0, monthProf = 0;
            
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - 7)); // Rolling 7 days
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

            rosterData.forEach(d => {
                if(d.history && Array.isArray(d.history)) {
                    d.history.forEach(h => {
                        if(!dateMap[h.date]) dateMap[h.date] = { profit: 0, sold: 0 };
                        dateMap[h.date].profit += (h.profit || 0);
                        dateMap[h.date].sold += (h.sold || 0);

                        const dObj = new Date(h.date);
                        if(dObj >= startOfWeek) { weekQty += h.sold; weekProf += h.profit; }
                        if(dObj >= startOfMonth) { monthQty += h.sold; monthProf += h.profit; }
                    });
                }
                // Add Today's live stats
                if(d.todaySold > 0) {
                     weekQty += d.todaySold; weekProf += d.todayProfit;
                     monthQty += d.todaySold; monthProf += d.todayProfit;
                     // Add to chart (current date)
                     const today = new Date().toISOString().split('T')[0];
                     if(!dateMap[today]) dateMap[today] = { profit: 0, sold: 0 };
                     dateMap[today].profit += d.todayProfit;
                     dateMap[today].sold += d.todaySold;
                }
            });

            document.getElementById('adm-report-week-qty').innerText = weekQty;
            document.getElementById('adm-report-week-profit').innerText = `$${weekProf} Profit`;
            document.getElementById('adm-report-month-qty').innerText = monthQty;
            document.getElementById('adm-report-month-profit').innerText = `$${monthProf} Profit`;

            // Chart
            const sortedDates = Object.keys(dateMap).sort().slice(-7); // Last 7 recorded days
            const chartData = sortedDates.map(date => dateMap[date].profit);
            
            const ctx = document.getElementById('adminTeamChart').getContext('2d');
            if(adminChartInstance) adminChartInstance.destroy();

            adminChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(d => d.slice(5)),
                    datasets: [{
                        label: 'Total Team Profit',
                        data: chartData,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: '#374151' } }, x: { grid: { display: false } } }
                }
            });
        }

        window.switchAdminTab = (tab) => {
            ['team', 'inventory', 'reports'].forEach(t => {
                document.getElementById(`admin-view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`adm-tab-${t}`);
                btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-blue-600');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            document.getElementById(`admin-view-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`adm-tab-${tab}`);
            activeBtn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-blue-600');
            activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
        };

        window.adminAddMasterStock = async () => {
            const qty = prompt("Enter quantity to add to Warehouse:");
            if(!qty) return;
            const val = parseInt(qty);
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master');
            await setDoc(ref, { qty: increment(val) }, { merge: true });
            window.showToast("Warehouse updated");
        };

        window.adminDistributeStock = async () => {
            const uid = document.getElementById('distribute-select-driver').value;
            const qty = parseInt(document.getElementById('distribute-qty').value);
            
            if(!uid || !qty || qty <= 0) { window.showToast("Select driver and enter valid qty"); return; }

            const masterRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', 'master');
            await setDoc(masterRef, { qty: increment(-qty) }, { merge: true });

            try {
                // Direct Write
                const driverRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'app_state');
                const snap = await getDoc(driverRef);
                
                let dData;
                if(snap.exists()) {
                    dData = JSON.parse(snap.data().json);
                    dData.stock = (dData.stock || 0) + qty;
                    dData.stockLogs = dData.stockLogs || [];
                    dData.stockLogs.push({ date: Date.now(), type: 'receive', qty: qty, by: 'admin' });
                } else {
                    dData = { stock: qty, currentTransactions: [], history: [], stockLogs: [{ date: Date.now(), type: 'receive', qty: qty, by: 'admin' }] };
                }
                
                await setDoc(driverRef, { json: JSON.stringify(dData), lastUpdated: Date.now() });
                
                const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster', uid);
                await setDoc(rosterRef, { stock: dData.stock }, { merge: true });

                window.showToast(`Sent ${qty} items to driver`);
                document.getElementById('distribute-qty').value = '';
                
            } catch (e) {
                console.error("Distribution Error:", e);
                window.showToast("Error: Admin cannot write to driver directly.");
            }
        };

        window.viewDriverDetails = (uid, name, stock, profit) => {
            document.getElementById('admin-user-detail').classList.remove('hidden');
            document.getElementById('detail-user-name').innerText = name;
            document.getElementById('detail-stock').innerText = stock;
            document.getElementById('detail-profit').innerText = `$${profit}`;
        };
    </script>
</body>
</html>